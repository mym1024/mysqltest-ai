drop table if exists t1,t2,t3,t4;
drop partition function h;
ERROR HY000: YAO-5077: partition function 'h' doesn't exist
create hash partition function h(x) 'x+1';
create table t1(pk int primary key, a int) partition by(hs,h,pk);
insert into t1 values(1,1);
begin;
use conn1,update t1
update t1 set a=2 where pk=1;
use conn1, select before conn1 commit, expect: (1,1)
select * from t1;
pk	a
1	2
use conn2, select before conn1 commit, expect: (1,1)
select * from t1;
pk	a
1	1
commit;
use conn2, select after conn1 commit, expect: (1,2)
select * from t1;
pk	a
1	2
drop table t1;
drop partition function e;
ERROR HY000: YAO-5077: partition function 'e' doesn't exist
create enum partition function e(x) '[(1)],[(3)]';
create table t1(pk int primary key, a int) partition by(em,e,pk);
insert into t1 values(1,1);
conn2 begin
begin;
conn3 begin
begin;
conn2 set a to 2
select * from t1;
pk	a
1	1
update t1 set a=2 where pk=1;
conn3 set a to 3, have to rollback
select * from t1;
pk	a
1	1
update t1 set a=3 where pk=1;
ERROR HY000: YAO-5049: Exclusive lock conflict 'int32:1' for key 'PRIMARY'
ROLLBACK;
conn2  select
select * from t1;
pk	a
1	2
conn3 select
select * from t1;
pk	a
1	1
conn2 commit and select
commit;
select * from t1;
pk	a
1	2
conn2  select
select * from t1;
pk	a
1	2
conn3 select
select * from t1;
pk	a
1	2
drop table t1;
create table t1(pk int primary key, a int) partition by range(pk) (partition r0 values less than(5), partition r1 values less than(10), partition r2 values less than(15), partition r3 values less than maxvalue);
insert into t1 values(1,1);
conn2 changes: 1->2->3
begin;
update t1 set a=a+1 where pk=1;
update t1 set a=a+1 where pk=1;
select * from t1;
pk	a
1	3
commit;
conn2 select after commit
select * from t1;
pk	a
1	3
conn3 select after commit
select * from t1;
pk	a
1	3
drop table t1;
