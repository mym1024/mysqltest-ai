drop table if exists t1,t2,t3,t4;
create table t1 (pk int primary key, a int) partition by list(pk)(partition a1 values in(1,3), partition a2 values in (2,4));
insert into t1 values(1,1);
insert into t1 values(2,1);
insert into t1 values(3,1),(4,1);
-- conn1 update row1 to +1
begin;
update t1 set a=a+1 where pk=1;
replace into t1 values(3,3),(4,4);
-- conn2 update row2 to +1, then update row1 to +1
begin;
update t1 set a=a+1 where pk=2;
delete from t1 where pk=4;
ERROR HY000: YAO-5049: Exclusive lock conflict 'int32:4' for key 'PRIMARY'
update t1 set a=a+1 where pk=1;
ERROR HY000: YAO-5049: Exclusive lock conflict 'int32:1' for key 'PRIMARY'
ROLLBACK;
commit;
select * from t1;
pk	a
1	2
2	1
3	3
4	4
drop table t1;
###################
create enum partition function e1(x)'[(1)],[(2)],[(3)],[(4)],[(5)],[(6)]';
create table t1 (pk varchar(30) primary key, a varchar(30)) partition by (ta1,e1,pk);
insert into t1 values('1','1');
insert into t1 values('2','1');
insert into t1 values('3','1'),('4','1');
-- conn1 update row1 to '2'
begin;
update t1 set a='2' where pk='1';
replace into t1 values('5','1'),('4','4');
-- conn2 update row2 to '2', then update row1 to '3'
begin;
update t1 set a='2' where pk='2';
delete from t1 where pk=3;
update t1 set a='3' where pk='1';
ERROR HY000: YAO-5049: Exclusive lock conflict 'varchar:1' for key 'PRIMARY'
ROLLBACK;
commit;
select * from t1;
pk	a
1	2
2	1
3	1
4	4
5	1
drop table t1;
drop partition function e1;
###################
create table t1 (pk int primary key, inta1 int, inta2 int, inta3 int, inta4 int) partition by range(pk)(partition d1 values less than(3),partition d2 values less than(6),partition d3 values less than maxvalue);
insert into t1 values(1,1,1,-1,-1);
insert into t1 values(2,2,2,-2,-2);
insert into t1 values(3,3,3,-3,-3);
insert into t1 values(4,4,4,-4,-4);
insert into t1 values(5,5,5,-5,-5);
commit;
select sum(inta1+inta2+inta3+inta4) as mysum from t1;
mysum
0
begin;
update t1 set inta1=inta1+1 where pk=1;
update t1 set inta3=inta3-1 where pk=3;
update t1 set inta3=inta3-1 where pk=1;
update t1 set inta1=inta1+1 where pk=3;
commit;
begin;
update t1 set inta1=inta1+1 where pk=2;
update t1 set inta1=inta1+1 where pk=4;
update t1 set inta3=inta3-1 where pk=4;
update t1 set inta3=inta3-1 where pk=2;
begin;
update t1 set inta1=inta1+1 where pk=5;
update t1 set inta3=inta3-1 where pk=5;
update t1 set inta3=inta3-1 where pk=1;
update t1 set inta1=inta1+1 where pk=1;
begin;
update t1 set inta3=inta3-1 where pk=3;
update t1 set inta1=inta1+1 where pk=3;
update t1 set inta1=inta1+1 where pk=2;
ERROR HY000: YAO-5049: Exclusive lock conflict 'int32:2' for key 'PRIMARY'
update t1 set inta3=inta3-1 where pk=2;
ERROR HY000: YAO-5049: Exclusive lock conflict 'int32:2' for key 'PRIMARY'
ROLLBACK;
commit;
commit;
select * from t1;
pk	inta1	inta2	inta3	inta4
1	3	1	-3	-1
2	3	2	-3	-2
3	4	3	-4	-3
4	5	4	-5	-4
5	6	5	-6	-5
drop table t1;
###################
create hash partition function h2(x,y)'x+y-2';
create table t1 (f1 int, f2 int,a int, primary key(f1,f2)) partition by (ta3,h2,f1,f2);
insert into t1 values(1,1,1);
insert into t1 values(1,2,1);
insert into t1 values(2,1,1);
insert into t1 values(2,2,1);
begin;
update t1 set a=a+1 where f1=1 and f2=1;
update t1 set a=a+1 where f1=2 and f2=1;
begin;
update t1 set a=a+1 where f1=1 and f2=2;
update t1 set a=a+1 where f1=2 and f2=2;
commit;
commit;
-- expect (1,1,2),(1,2,2),(2,1,2),(2,2,2)
select * from t1;
f1	f2	a
1	1	2
1	2	2
2	1	2
2	2	2
begin;
update t1 set a=a+1 where f1=1 and f2=1;
update t1 set a=a+1 where f1=2 and f2=2;
begin;
update t1 set a=a+1 where f1=2 and f2=1;
begin;
update t1 set a=a+1 where f1=1 and f2=2;
update t1 set a=a+1 where f1=1 and f2=1;
ERROR HY000: YAO-5049: Exclusive lock conflict 'int32:1,int32:1' for key 'PRIMARY'
ROLLBACK;
commit;
commit;
-- expect (1,1,3),(1,2,2),(2,1,3),(2,2,3)
select * from t1;
f1	f2	a
1	1	3
1	2	2
2	1	3
2	2	3
begin;
--rowkey is required
update t1 set a=a+1 where f1=1;
ROLLBACK;
-- expect (1,1,3),(1,2,2),(2,1,3),(2,2,3)
select * from t1;
f1	f2	a
1	1	3
1	2	2
2	1	3
2	2	3
drop table t1;
drop partition function h2;
###################
create table t1 (f1 int, f2 varchar(30),a int, primary key(f1,f2)) partition by list columns(f1,f2)(partition r1 values in((1,'1'),(1,'2')),partition r2 values in ((2,'1'),(2,'2')));
insert into t1 values(1,'1',1);
insert into t1 values(1,'2',1);
insert into t1 values(2,'1',1);
insert into t1 values(2,'2',1);
begin;
update t1 set a=a+1 where f1=1 and f2='1';
update t1 set a=a+1 where f1=2 and f2='1';
begin;
update t1 set a=a+1 where f1=1 and f2='2';
update t1 set a=a+1 where f1=2 and f2='2';
commit;
commit;
-- expect (1,'1',2),(1,'2',2),(2,'1',2),(2,'2',2)
select * from t1;
f1	f2	a
1	1	2
1	2	2
2	1	2
2	2	2
begin;
update t1 set a=a+1 where f1=1 and f2='1';
update t1 set a=a+1 where f1=2 and f2='2';
begin;
update t1 set a=a+1 where f1=2 and f2='1';
begin;
update t1 set a=a+1 where f1=1 and f2='2';
update t1 set a=a+1 where f1=1 and f2='1';
ERROR HY000: YAO-5049: Exclusive lock conflict 'int32:1,varchar:1' for key 'PRIMARY'
ROLLBACK;
commit;
commit;
-- expect (1,'1',3),(1,'2',2),(2,'1',3),(2,'2',3)
select * from t1;
f1	f2	a
1	1	3
1	2	2
2	1	3
2	2	3
begin;
--rowkey is required
update t1 set a=a+1 where f1=1;
ROLLBACK;
-- expect (1,'1',3),(1,'2',2),(2,'1',3),(2,'2',3)
select * from t1;
f1	f2	a
1	1	3
1	2	2
2	1	3
2	2	3
drop table t1;
################### update more columns
create table t1 (f1 int, f2 varchar(30),a int, b int, primary key(f1,f2)) partition by list columns(f1,f2)(partition q1 values in((1,'1'),(1,'2')),partition q2 values in ((2,'1'),(2,'2')));
insert into t1 values(1,'1',1,0);
insert into t1 values(1,'2',1,0);
insert into t1 values(2,'1',1,0);
insert into t1 values(2,'2',1,0);
begin;
update t1 set a=a+1,b=b-1 where f1=1 and f2='1';
update t1 set a=a+1,b=b-1 where f1=2 and f2='1';
begin;
update t1 set a=a+1,b=b-1 where f1=1 and f2='2';
update t1 set a=a+1,b=b-1 where f1=2 and f2='2';
commit;
commit;
-- expect (1,'1',2,-1),(1,'2',2,-1),(2,'1',2,-1),(2,'2',2,-1)
select * from t1;
f1	f2	a	b
1	1	2	-1
1	2	2	-1
2	1	2	-1
2	2	2	-1
begin;
update t1 set a=a+1,b=b-1 where f1=1 and f2='1';
update t1 set a=a+1,b=b-1 where f1=2 and f2='2';
begin;
update t1 set a=a+1,b=b-1 where f1=2 and f2='1';
begin;
update t1 set a=a+1,b=b-1 where f1=1 and f2='2';
update t1 set a=a+1,b=b-1 where f1=1 and f2='1';
ERROR HY000: YAO-5049: Exclusive lock conflict 'int32:1,varchar:1' for key 'PRIMARY'
ROLLBACK;
commit;
commit;
-- expect (1,'1',3,-2),(1,'2',2,-1),(2,'1',3,-2),(2,'2',3,-2)
select * from t1;
f1	f2	a	b
1	1	3	-2
1	2	2	-1
2	1	3	-2
2	2	3	-2
drop table t1;
