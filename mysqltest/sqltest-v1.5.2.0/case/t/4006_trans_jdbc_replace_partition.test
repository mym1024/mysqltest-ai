#######################################################
###1.测试功能点：在不同分区规则下，测试开启会话并测试replace操作；
#######################################################


--disable_warnings
drop table if exists t1,t2,t3,t4;
--enable_warnings

##case1
###2-1:在hash分区规则下，开启会话执行replace
--echo case1
connect(conn1,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn1;
drop table if exists t1;
--error 5077
drop partition function h;
create hash partition function h(x)'x+1';
create table t1 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1)) partition by (hs,h,i1);
--real_sleep 5
insert into t1(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(3,'c',3.3,'2013-05-30 03:00:00'),(4,'d',4.3,'2013-05-30 04:00:00');
set autocommit=0;
replace into t1(i1,v2,f3,d4) values(1,'a1',1.4,'2013-05-30 01:10:00');
replace into t1(i1,v2,f3,d4) values(5,'e',5.3,'2013-05-30 05:00:00');
commit;
--real_sleep 5
set autocommit=1;
select * from t1;
drop table t1;
disconnect conn1;


##case2
###2-2:在enum分区规则下，开启会话执行replace
--echo case2
connect(conn2,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn2;
drop table if exists t2;
--error 5077
drop partition function e;
create enum partition function e(x)'[(1)],[(3)],[(2)],[(4)],[(5)],[(6)]';
create table t2 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1)) partition by (em,e,i1);
--real_sleep 5
insert into t2(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(3,'c',3.3,'2013-05-30 03:00:00'),(4,'d',4.3,'2013-05-30 04:00:00');
set autocommit=0;
replace into t2(i1) values(2);
replace into t2(i1) values(6);
replace into t2(i1,v2) values(1,'a2');
replace into t2(i1,f3) values(2,2.4);
replace into t2(i1,d4) values(3,'2013-05-30 03:10:00');  
commit;
--real_sleep 5
set autocommit=1;
select * from t2;
disconnect conn2;

##case3
###2-3:在range分区规则下，开启会话执行replace
--echo case3
connect(conn3,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn3;
drop table if exists t3;
create table t3 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1)) partition by range(i1)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than(15),partition r3 values less than maxvalue);
--real_sleep 5
insert into t3(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(3,'c',3.3,'2013-05-30 03:00:00'),(4,'d',4.3,'2013-05-30 04:00:00');
set autocommit=0;
replace into t3(i1,v2,f3,d4) values(1,'a1',1.4,'2013-05-30 01:10:00'),(5,'e',5.3,'2013-05-30 05:00:00'),(3,'c1',3.4,'2013-05-30 03:10:00'),(6,'f',6.3,'2013-05-30 06:00:00'),(7,'e',7.3,'2013-05-30 07:00:00');
replace into t3(i1,v2,f3,d4) values(2,'b1',2.4,'2013-05-30 02:10:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(8,'f',8.3,'2013-05-30 08:00:00'),(8,'f1',8.3,'2013-05-30 08:10:00');
commit;
--real_sleep 5
set autocommit=1;
select * from t3;
disconnect conn3;

--echo case4
connect(conn4,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn4;
drop table if exists t4;
create table t4 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1)) partition by range(i1)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than maxvalue); 
--real_sleep 5
insert into t4(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(3,'c',3.3,'2013-05-30 03:00:00'),(4,'d',4.3,'2013-05-30 04:00:00');
set autocommit=0;
replace into t4(i1) values(2),(3);
replace into t4(i1) values(6),(6);
replace into t4(i1,v2) values(1,'a2'),(9,'g'),(1,'a3'),(9,'g1');
replace into t4(i1,f3) values(2,2.4),(10,10.3),(2,2.5),(10,10.4);
replace into t4(i1,d4) values(3,'2013-05-30 03:10:00'),(11,'2013-05-30 11:00:00'),(11,'2013-05-30 11:10:00');  
commit;
--real_sleep 5
set autocommit=1;
select * from t4;
disconnect conn4;


##case5
###2-4:在list分区规则下，开启会话执行replace
--echo case5
connect(conn5,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn5;
drop table if exists t5;
create table t5 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1,v2)) partition by list(i1)(partition q0 values in(1,3),partition q1 values in(2,4,5));
--real_sleep 5
insert into t5(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(3,'c',3.3,'2013-05-30 03:00:00'),(4,'d',4.3,'2013-05-30 04:00:00');
set autocommit=0;
replace into t5(i1,v2,f3,d4) values(1,'a',1.4,'2013-05-30 01:10:00');
replace into t5(i1,v2,f3,d4) values(5,'e',5.3,'2013-05-30 05:00:00');
commit;
--real_sleep 5
set autocommit=1;
select * from t5;
disconnect conn5;


##case6
connect(conn6,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn6;
drop table if exists t6;
#--error 5077
drop partition function h;
create hash partition function h(x)'x+1';
create table t6 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1,v2)) partition by (hs,h,v2);
--real_sleep 5
insert into t6(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(3,'c',3.3,'2013-05-30 03:00:00'),(4,'d',4.3,'2013-05-30 04:00:00');
set autocommit=0;
replace into t6(i1,v2) values(2,'b');
replace into t6(i1,v2) values(6,'f');
replace into t6(i1,v2,f3) values(1,'a',1.5);
replace into t6(i1,v2,d4) values(3,'c','2013-05-30 03:10:00');    
commit;
--real_sleep 5
set autocommit=1;
select * from t6;
disconnect conn6;

##case7
connect(conn7,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn7;
drop table if exists t7;
create table t7 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1,v2)) partition by list columns(i1,v2)(partition qq0 values in ((1,'a'),(2,'b')),partition qq1 values in ((3,'c'),(4,'d'),(5,'e'),(6,'f'),(7,'e'),(8,'f')));
--real_sleep 5
insert into t7(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(3,'c',3.3,'2013-05-30 03:00:00'),(4,'d',4.3,'2013-05-30 04:00:00');
set autocommit=0;
replace into t7(i1,v2,f3,d4) values(1,'a',1.4,'2013-05-30 01:10:00'),(5,'e',5.3,'2013-05-30 05:00:00'),(3,'c',3.4,'2013-05-30 03:10:00'),(6,'f',6.3,'2013-05-30 06:00:00'),(7,'e',7.3,'2013-05-30 07:00:00');
replace into t7(i1,v2,f3,d4) values(2,'b',2.4,'2013-05-30 02:10:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(8,'f',8.3,'2013-05-30 08:00:00'),(8,'f',8.4,'2013-05-30 08:10:00');
commit;
--real_sleep 5
set autocommit=1;
select * from t7;
disconnect conn7;

##case8
connect(conn8,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn8;
drop table if exists t8;
create table t8 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1,v2)) partition by list columns(i1,v2)(partition qq0 values in ((1,'a'),(2,'b')),partition qq1 values in ((3,'c'),(4,'d'),(9,'g'),(10,'j')));
--real_sleep 5
insert into t8(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00'),(2,'b',2.3,'2013-05-30 02:00:00'),(3,'c',3.3,'2013-05-30 03:00:00'),(4,'d',4.3,'2013-05-30 04:00:00');
set autocommit=0;
replace into t8(i1,v2) values(2,'b'),(3,'c');
replace into t8(i1,v2) values(9,'g'),(9,'g');
replace into t8(i1,v2,f3) values(1,'a',1.5),(9,'g',9.3),(1,'a',1.6),(9,'g',9.4);
replace into t8(i1,v2,d4) values(3,'c','2013-05-30 03:10:00'),(10,'j','2013-05-30 11:00:00'),(3,'c','2013-05-30 03:20:00'),(10,'j','2013-05-30 11:10:00');    
commit;
--real_sleep 5
set autocommit=1;
select * from t8;
disconnect conn8;

##case9:rollback
###2-5:在不同分区规则下，开启会话执行事务，并回滚事务
connect(conn9,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn9;
drop table if exists t9;
create table t9 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1,v2)) partition by range columns(i1,v2)(partition rr0 values less than(2,'b'),partition rr1 values less than(5,'e'),partition rr2 values less than(maxvalue,maxvalue));
--real_sleep 5
set autocommit=0;
replace into t9(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00');
--error 5007
replace into t9(i1,v2,f3,d4) values(5,'e',5.3,'2013-05-30 05:00:00'),(1,'a1');
rollback;
set autocommit=1;
select * from t9;
disconnect conn9;

##case10:rollback
connect(conn10,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn10;
drop table if exists t10;
create table t10 (i1 int, v2 varchar(20),f3 float,d4 datetime, primary key(i1,v2)) partition by list(i1)(partition q0 values in(1,3),partition q1 values in(2,4,5));
--real_sleep 5
set autocommit=0;
replace into t10(i1,v2,f3,d4) values(1,'a',1.3,'2013-05-30 01:00:00');
replace into t10(i1,v2,f3,d4) values(5,'e',5.3,'2013-05-30 05:00:00');
rollback;
set autocommit=1;
select * from t10;
disconnect conn10;