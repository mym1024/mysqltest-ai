##############################################################################################
###1.测试功能点：测试check
#                         
#                 
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：
###4.问题号：
###5.预计运行时间：15s
###6.编写/修改人：zhangt
###7.编写/修改日期：2024-06
###8.其他（选填）：1.4.0.0新增
###
##
#
##############################################################################################

#####################################Do sql###################################################
###2-1:列级check约束语法
--error 5001
CREATE TABLE t1(f1 int CHECK());		
--error 5001
CREATE TABLE t1(f1 int CONSTRAINT CHECK());
--error 5001
CREATE TABLE t1(f1 int CONSTRAINT t1_ck CHECK());
--error 5001
CREATE TABLE t1(f1 int CONSTRAINT t1_ck CHECK( f1 < 10) NOT);
--error 5001
CREATE TABLE t1(f1 int t1_ck CHECK());
--error 5687
CREATE TABLE t1(f1 int CHECK(f1));		
--error 5690
CREATE TABLE t1(f1 int CHECK(f2 < 10));		
CREATE TABLE t1 (f1 int CHECK(f1 < 10),f2 int CONSTRAINT t1_f2_ck CHECK (f2 < 10));	
drop table t1;
--error 5001
CREATE TABLE t1(f1 int CHECK(f1 < 10), f2 int CHECK);
--error 5001
CREATE TABLE t1(f1 int CHECK(f1 < 10), f2 int t1_f2_ck CHECK(f2 < 10));	
--error 5001
CREATE TABLE t1(f1 int CHECK(f1 < 10), f2 int CHECK(f2 < 10) NOT);
--error 5687
CREATE TABLE t1(f1 int CHECK(f1 < 10), f2 int CHECK(f2 + 10));		
CREATE TABLE t1 (f1 int CHECK(f1 < 10), f2 int CHECK(f2 < 10),f3 int CONSTRAINT t1_f3_ck CHECK (f3  < 10));	
drop table t1;
--error 5687
CREATE TABLE t1(f1 int CHECK(f1 + 10));

###2-2:表级check约束语法
--error 5001
CREATE TABLE t1(f1 int, CONSTRAINT t1_ck CHECK);
--error 5001
CREATE TABLE t1(f1 int, CONSTRAINT t1_ck CHECK();
--error 5001
CREATE TABLE t1(f1 int, CONSTRAINT t1_ck CHECK());
--error 5687
CREATE TABLE t1(f1 int, CONSTRAINT t1_ck CHECK(f1));
--error 5687
CREATE TABLE t1(f1 int, CONSTRAINT t1_ck CHECK(f1 + 10));
--error 5685
CREATE TABLE t1(f1 int, CONSTRAINT t1_ck CHECK(f2 < 10));
CREATE TABLE t1(f1 int, CONSTRAINT t1_ck CHECK(f1 < 10));
drop table t1;
--error 5001
CREATE TABLE t1(f1 int, CONSTRAINT t1_ck CHECK(f1<10), CONSTRAINT t2_ck CHECK(f2 > 0) NOT);
--error 5685
CREATE TABLE t1(f1 int, CONSTRAINT t1_ck CHECK(f1<10), CONSTRAINT t2_ck CHECK(f2 > 1));	
CREATE TABLE t1(f1 int, CHECK(f1<10), CONSTRAINT t2_ck CHECK(f1 > 1));
drop table t1;

###2-3:check约束名形式,验证规则
CREATE TABLE t1(c1 INT, c2 INT, CONSTRAINT `ck_1$` CHECK (c2 < 10));
SHOW CREATE TABLE t1;
CREATE TABLE t2(c1 INT, c2 INT, CONSTRAINT ` ck_2$ ` CHECK (c2 < 10));	
SHOW CREATE TABLE t2;	
--error 5179
CREATE TABLE t3(c1 INT, c2 INT,CONSTRAINT ckkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkkk1 CHECK (c2 < 10));	
--error 5001
CREATE TABLE t4(c1 INT, c2 INT, CONSTRAINT FLOAT CHECK (c2 < 10));
CREATE TABLE t5(c1 INT, c2 INT, CONSTRAINT `FLOAT` CHECK (c2 < 10));
SHOW CREATE TABLE t5;
CREATE TABLE t6 (f1 INT CHECK (f1 < 10));
RENAME TABLE t6 TO t123456789012345678901234567890123456789012345678901234567890;
SHOW CREATE TABLE t123456789012345678901234567890123456789012345678901234567890;
DROP TABLE t1,t2,t5;

#验证相同数据库下的重复检查约束名称。同一数据库下不允许使用相同名称的检查约束。
CREATE TABLE t(c1 INT CONSTRAINT t2_chk_1 CHECK (c1 > 10));
CREATE TABLE t1(c1 INT CHECK (c1 > 10), CONSTRAINT ck CHECK(c1 > 10));
--error 5678
CREATE TABLE t2(c1 INT, CONSTRAINT ck CHECK(c1 > 10));
--error 5678
ALTER TABLE t1 ADD CONSTRAINT ck CHECK(c1 > 10);
ALTER TABLE t1 RENAME TO t2;

CREATE DATABASE db1;
CREATE TABLE db1.t(c1 INT CONSTRAINT t2_chk_1 CHECK (c1 > 10));
ALTER TABLE db1.t ADD c2 INT;
ALTER TABLE db1.t RENAME TO db1.t2;

#检查约束名称是否区分大小写和重音
--error 5678
CREATE TABLE t1 (f1 INT,CONSTRAINT cafe CHECK (f1 < 10),CONSTRAINT CAFE CHECK (f1 < 10));
create table t1 (f1 int,CONSTRAINT cafe CHECK (f1 < 10),CONSTRAINT café CHECK (f1 < 10));
SHOW CREATE TABLE t1;

#验证约束中列的前向引用	
drop table t2;
--error 5685
CREATE TABLE t2(CHECK((f1 + f3) > 10), f1 int CHECK (f1 < 10), f2 int);
CREATE TABLE t3(CHECK((f1 + f2) > 10), f1 int CHECK (f1 < 10), f2 int);
SHOW CREATE TABLE t3;
drop table t1,t3;

#验证表上的多个检查约束的创建
CREATE TABLE t1(c1 INT, c2 INT, c3 INT, c4 INT);
--sleep 3
ALTER TABLE t1 
	ADD CONSTRAINT ck11 CHECK(c1 > 1),
    ADD CONSTRAINT ck12 CHECK(c1 < 1),
    ADD CONSTRAINT ck21 CHECK(c2 > 1),
    ADD CONSTRAINT ck22 CHECK(c2 < 1),
    ADD CONSTRAINT ck31 CHECK(c3 > 1),
    ADD CONSTRAINT ck32 CHECK(c3 < 1),
    ADD CONSTRAINT ck41 CHECK(c4 > 1),
    ADD CONSTRAINT ck42 CHECK(c4 < 1);
SHOW CREATE TABLE t1;
--error 5678
ALTER TABLE t1
      DROP CHECK ck21, ADD CONSTRAINT ck21 CHECK (c1 > 10),
      DROP CHECK ck22, ADD CONSTRAINT ck22 CHECK (c1 < 10),
      DROP CHECK ck31, ADD CONSTRAINT ck31 CHECK (c1 > 10),
      DROP CHECK ck32, ADD CONSTRAINT ck32 CHECK (c1 < 10),
      DROP CHECK ck41, ADD CONSTRAINT ck41 CHECK (c1 > 10),
      DROP CHECK ck42, ADD CONSTRAINT ck42 CHECK (c1 < 10);
DROP TABLE t1;

#check约束有默认列值
CREATE TABLE t1(c1 INT DEFAULT 100 CHECK(c1 > 10));
--error 5689
INSERT INTO t1 VALUES(1);
CREATE TABLE t2(c1 int DEFAULT 1, CONSTRAINT CHECK(c1 IS NOT NULL));	
--error 5689
INSERT INTO t2 VALUES(NULL);	

#测试更改字符集后check约束行为
CREATE TABLE t3(c1 VARCHAR(1) CHARSET gbk CHECK(c1 = 'a'),c2 VARCHAR(1) CHARSET gbk);
show create table t3;
create table t4 (c1 varchar(255) character set 'gbk' collate 'gbk_bin' check(c1 = 'a'));
--error 5689
insert into t4 values('b');
insert into t4 values('a');
select * from t4;
show create table t4;

#check约束表达式永为false
CREATE TABLE t5 (CHECK (1 < 1), f1 int);
SHOW CREATE TABLE t5;
#--error 5689
INSERT INTO t5 VALUES(1);
#--error 5689
INSERT INTO t5 VALUES(10);
	
#添加check约束后相关系统表(__all_check_constraint,__all_check_constraint_column)的结果	
create table t6(c1 int check(c1 > 1));
select * from __all_check_constraint;
select * from __all_check_constraint_column;

CREATE TABLE t7(f1 INT CHECK (f1 < 10), f2 INT, CHECK (f2 < 10),CONSTRAINT min CHECK (f1 + f2 > 10),CONSTRAINT max CHECK (f1 + f2 < 929));
SHOW CREATE TABLE t7;
drop table t1,t2,t3,t4,t5,t6,t7;

###2-4:带有check约束下的insert、replace、update、alter等操作
CREATE TABLE t1(f1 INT PRIMARY KEY, f2 INT CHECK (f2 < 10));
SHOW CREATE TABLE t1;
CREATE TABLE t2(f1 INT, f2 INT);
INSERT INTO t2 VALUES(101, 1),(102, NULL),(103, 1000);
INSERT INTO t1 VALUES(1, 1),(2, NULL);
--error 5689
INSERT INTO t1 VALUES(3, 1000);
--error 5001
INSERT IGNORE INTO t1 VALUES (3, 1000);		
--error 5689
INSERT INTO t1 SELECT * FROM t2;
drop table t1,t2;	
	
create table t1 (c1 double check(cast(c1 as int) > 2));
--error 5689
insert into t1 values(2.1);
--error 5689
insert into t1 values(2.9);
insert into t1 values(3.9);
select * from t1;		
	
create table t2 (c1 timestamp check (cast(c1 as datetime)> '2026-12-01 12:21:21'));
--error 5689
insert into t2 values(current_date);	
drop table t1,t2;
	
--error 5690
create table t1 (c1 double, c2 int, c3 int check(c3 between c1 and c2));
create table t1 (c1 double, c2 int, c3 int default 10 ,check(c3 between c1 and c2));
--sleep 3
--error 5689
insert into t1 values(1,2,3);
insert into t1 values(1,3,3),(1,4,3),(3,5,3);
--sleep 2
--error 5689
update t1 set c3 = 11 where c2 = 3;	
update t1 set c3 = 2 where c2 = 3;
drop table t1;	
	
create table t1 (c1 varchar(10) check(c1 = 'abc'));
--error 5689
insert into t1 values(1);
--error 5689
insert into t1 values('ab');
insert into t1 values('abc');
--sleep 2
select * from t1;
--error 5689
insert into t1 values('尧');
drop table t1;	

create table t1 (c1 varchar(10) check(c1 +1 is not null));
insert into t1 values(1);
select * from t1;
--error 5689
insert into t1 values(NULL);
drop table t1;	

create table t1 (c1 datetime check( year(cast(c1 as datetime)) > 2024));
--error 5689
insert into t1 values('2024-11-12');
insert into t1 values('2025-11-12');drop table t1;		
	
CREATE TABLE t1(f1 INT PRIMARY KEY, f2 INT CHECK (f2 < 10));
--sleep 3
INSERT INTO t1 VALUES(2, NULL);
select null < 10;
--error 5689
INSERT INTO t1 VALUES(3, 1000);
insert into t1 values(1,2);
--sleep 3
UPDATE t1 SET f2 = NULL;
--sleep 2
select * from t1;
drop table t1;	

create  table t1 (c1 int primary key, c2 bit(3) check(c2 =b'001'));
--error 5689
insert into t1 values(1, 2);
--error 5689
insert into t1 values(1, b'110');
--error 5611
insert into t1 values(1, b'1110');
--error 5611
insert into t1 values(1, '1');
insert into t1 values(2, 0001),(3, 0001),(1, b'001');
--sleep 2
select * from t1;	
drop table t1;	

create table t1 (c1 int check(c1 > 1), c2 int check(c2 >2),check(c2 > c1 || c1 > c2));
--sleep 2
replace into t1 values(2,3);	
--error 5689
insert into t1 values(1,2);
--error 5689
insert into t1 values(2,1);
--error 5689
insert into t1 values(2,2);	
drop table t1;	
	
create table t1 (c1 varchar(20) check(c1 like '%abc%'));
--error 5689
insert into t1 values(1);
--error 5689
insert into t1 values('ab');
--error 5689
insert into t1 values('abv');
insert into t1 values('abc');
insert into t1 values('尧abc尧');
--sleep 3
select * from t1;
drop table t1;	

create table t1 (c1 varchar(10) check(c1 regexp '[0-9]' ));
--error 5689
insert into t1 values ('a');
insert into t1 values (1),(10),(11),(9);
--error 5689
insert into t1 values ('bab');
select * from t1;
replace into t1 values(10);
--error 5689
replace into t1 values('a');
drop table t1;	

create table t1 (c1 int check(c1 !=1 ));
--error 5689
insert into t1 values(1);
--error 5689
insert into t1 values(1.01);
drop table t1;	

#rename table操作后约束名更改
CREATE TABLE t1 (f1 INT CHECK(f1 < 10));
SHOW CREATE TABLE t1;
RENAME TABLE t1 TO t2;
SHOW CREATE TABLE t2;
drop table t2;

#测试将带有check约束的表移进另一个库中，约束是否存在(TODO)
CREATE DATABASE test1;
CREATE DATABASE test2;
USE test1;
CREATE TABLE t1(c1 INT, c2 INT CHECK (c2 < 10));
INSERT INTO t1 VALUES(1,1);
--error 5001
ALTER TABLE test1.t1 rename test2.t1;
USE test2;
--error 5019
SELECT * FROM t1;

#外键约束+check约束同时作用一列
CREATE TABLE parent(pid INT NOT NULL PRIMARY KEY CHECK(pid > 1));
CREATE TABLE child(cid INT CHECK(cid > 1),CONSTRAINT fk FOREIGN KEY (cid) REFERENCES parent(pid));
SHOW CREATE TABLE parent;
SHOW CREATE TABLE child;
INSERT INTO parent VALUES(2);
--error 5209
INSERT INTO child VALUES(3);
INSERT INTO child VALUES(2);
SELECT * FROM parent;
SELECT * FROM child;
DROP TABLE child;
DROP TABLE parent;

#删除有约束的表后check约束相关系统表数据删除
create table t1(c1 int,c2 int, check(c2>c1));
select * from __all_check_constraint;
select * from __all_check_constraint_column;
drop table t1;
select * from __all_check_constraint;
select * from __all_check_constraint_column;

#测试alter table drop/add check约束
create table t1(c1 int, c2 int,f1 INT CHECK (f1 < 10), constraint cmp_ck check(c2 > c1));
ALTER TABLE t1 DROP CHECK cmp_ck;
show create table t1;
ALTER TABLE t1 ADD CONSTRAINT CHECK (f1 > 1), ADD CONSTRAINT `t1_p_ck` CHECK (f1 > 1);
SHOW CREATE TABLE t1;
--error 5678
ALTER TABLE t1 DROP CHECK t1_p_ck, ADD CONSTRAINT t1_p_ck CHECK (c1 > 38);
SHOW CREATE TABLE t1;
drop table t1;
	
#添加删除列带有check约束	
CREATE TABLE t1 (c1 INT, CONSTRAINT ck1 CHECK (c1 > 10));
ALTER TABLE t1 ADD COLUMN c2 INT,ADD CONSTRAINT ck2 CHECK (c2 > 10);
SHOW CREATE TABLE t1;
--error 5691
ALTER TABLE t1 DROP COLUMN c2;
--error 5691
ALTER TABLE t1 DROP CHECK ck2,DROP COLUMN c2;
ALTER TABLE t1 DROP CHECK ck2;
ALTER TABLE t1 DROP COLUMN c2;
ALTER TABLE t1 ADD COLUMN c4 INT, ADD CONSTRAINT ck4 CHECK( c4 > 10);
SHOW CREATE TABLE t1;
DROP TABLE t1;

#enforced和not enforced选项	
CREATE TABLE t1(f1 INT,f2 INT CHECK (f2 < 10),f3 INT CHECK (f3 < 10) NOT ENFORCED,CONSTRAINT ck CHECK (f1 > 10),CONSTRAINT CHECK (f1 > 10) NOT ENFORCED);
SHOW CREATE TABLE t1;

#测试删除一个不存在的check约束
CREATE TABLE t2(c1 INT, c2 INT, c3 INT, c4 INT);
--error 5688
ALTER TABLE t2 DROP CHECK ck13;
	
#check constraint 结合modify语法	
CREATE TABLE t3(c1 CHAR(1), CHECK (c1 > 'A'));
SHOW CREATE TABLE t3;
--error 5689
INSERT INTO t3 VALUES('A');
INSERT INTO t3 VALUES('B');
DELETE FROM t3;
SHOW CREATE TABLE t3;
--error 5688
ALTER TABLE t3 MODIFY COLUMN c1 FLOAT, DROP CHECK t1_chk_1, ADD CONSTRAINT CHECK(C1 > 10.1) ENFORCED;
DROP TABLE t1,t2,t3;

###2-5:check约束表达式中使用操作符、运算符
#check约束表达式带有in操作符	
CREATE TABLE t1(f1 int CHECK (f1 IN (10, 20, 30)), f2 int, CHECK(f2 IN (100, 120, 450)));
SHOW CREATE TABLE t1;
INSERT INTO t1 VALUES(10, 100);
--error 5689
INSERT INTO t1 VALUES(15, 100);
--error 5689
INSERT INTO t1 VALUES(10, 105);
DROP TABLE t1;	

#check约束表达式带有between操作符
CREATE TABLE t1(f1 int CHECK(f1 BETWEEN 10 AND 30),f2 int, CHECK(f2 BETWEEN 100 AND 450));
SHOW CREATE TABLE t1;
INSERT INTO t1 VALUES(20, 200);
--error 5689
INSERT INTO t1 VALUES(2, 200);
--error 5689
INSERT INTO t1 VALUES(20, 2000);
DROP TABLE t1;

#check约束表达式带有is not null	
CREATE TABLE t1 (f1 int CHECK(f1 IS NOT NULL));
SHOW CREATE TABLE t1;
INSERT INTO t1 VALUES(10);
--error 5689
INSERT INTO t1 VALUES(NULL);
DROP TABLE t1;

#check约束表达式带有is null	
CREATE TABLE t1 (f1 int CHECK(f1 IS NULL));
SHOW CREATE TABLE t1;
INSERT INTO t1 VALUES(NULL);
--error 5689
INSERT INTO t1 VALUES(10);
DROP TABLE t1;

#check约束表达式带有case when
CREATE TABLE t1(c1 INT, c2 INT);
ALTER TABLE t1 ADD CONSTRAINT CHECK( (CASE WHEN c1 > 10 THEN c2 = 20 END) = 1);
SHOW CREATE TABLE t1;
INSERT INTO t1 VALUES(1,1);
--error 5689
INSERT INTO t1 VALUES(15,1);
INSERT INTO t1 VALUES(15,20);
SELECT * FROM t1;
DROP TABLE t1;

#测试check约束中有比较函数和比较操作符
--error 5682
CREATE TABLE t1(c1 INT, CHECK ( c1 IN ( SELECT COALESCE(NULL, 1, 1))));
--error 5682
CREATE TABLE t1(c1 INT, CHECK ( c1 < ( SELECT COALESCE(NULL, 1, 1))));
CREATE TABLE t1(c1 INT , CHECK ( c1 <=> NULL ));
--error 5689
INSERT INTO t1 VALUES(1);
INSERT INTO t1 VALUES(NULL);
SELECT * FROM t1;
ALTER TABLE t1 ADD COLUMN c2 INT, ADD CONSTRAINT CHECK( c2 >= 10 );
--error 5689
INSERT INTO t1(c2) VALUES(9);
INSERT INTO t1(c2) VALUES(10);
ALTER TABLE t1 ADD COLUMN c3 INT, ADD CONSTRAINT CHECK( c3 < 10 );
--error 5689
INSERT INTO t1(c3) VALUES(10);
INSERT INTO t1(c3) VALUES(9);
ALTER TABLE t1 ADD COLUMN c4 INT, ADD CONSTRAINT CHECK( c4 != 10 );
--error 5689
INSERT INTO t1(c4) VALUES(10);
INSERT INTO t1(c4) VALUES(20);
ALTER TABLE t1 ADD COLUMN c7 INT, ADD CONSTRAINT CHECK( c7 <> 10 );
--error 5689
INSERT INTO t1(c7) VALUES(10);
INSERT INTO t1(c7) VALUES(20);
ALTER TABLE t1 ADD COLUMN c8 INT, ADD CONSTRAINT CHECK( c8 = GREATEST(1,2,3) );
--error 5689
INSERT INTO t1(c8) VALUES(1);
INSERT INTO t1(c8) VALUES(3);
ALTER TABLE t1 ADD COLUMN c9 INT, ADD CONSTRAINT CHECK( c9 = LEAST(1,2,3) );
--error 5689
INSERT INTO t1(c9) VALUES(3);
INSERT INTO t1(c9) VALUES(1);
ALTER TABLE t1 ADD COLUMN c10 INT, ADD CONSTRAINT CHECK( c10 NOT IN (1,2,3) );
--error 5689
INSERT INTO t1(c10) VALUES(1);
--error 5689
INSERT INTO t1(c10) VALUES(3);
INSERT INTO t1(c10) VALUES(10);
ALTER TABLE t1 ADD COLUMN c11 date, ADD CONSTRAINT CHECK ( c11 > '2007-01-01');
INSERT INTO t1(c11) VALUES('2009-01-01');
ALTER TABLE t1 ADD COLUMN c12 INT, ADD CONSTRAINT CHECK ( c12 NOT BETWEEN 10 AND 20);
--error 5689
INSERT INTO t1(c12) VALUES(15);
INSERT INTO t1(c12) VALUES(25);
ALTER TABLE t1 ADD COLUMN c13 INT, ADD CONSTRAINT CHECK ( c13 NOT IN (1, 2, 3));
--error 5689
INSERT INTO t1(c13) VALUES(1);
INSERT INTO t1(c13) VALUES(15);
ALTER TABLE t1 ADD COLUMN c14 CHAR(10), ADD CONSTRAINT CHECK ( c14 LIKE 'A%');
--error 5689
INSERT INTO t1(c14) VALUES('Good');
INSERT INTO t1(c14) VALUES('All');
--error 5679
ALTER TABLE t1 ADD COLUMN c15 INT, ADD CONSTRAINT CHECK ( c15 = STRCMP('A','A'));
SHOW CREATE TABLE t1;
DROP TABLE t1;
	
#测试逻辑运算符
CREATE TABLE t1(c1 INT, c2 INT);
ALTER TABLE t1 ADD CONSTRAINT CHECK( (c1 > 10) AND (c2 < 20) );
--error 5689
INSERT INTO t1 VALUES(1,10);
ALTER TABLE t1 ADD CONSTRAINT CHECK( (c1 > 10) && (c2 < 20) );
--error 5689
INSERT INTO t1 VALUES(15,25);
--error 5688
ALTER TABLE t1 DROP CHECK `t1_chk_1`;
--error 5688
ALTER TABLE t1 DROP CHECK `t1_chk_2`;
ALTER TABLE t1 ADD CONSTRAINT CHECK( (c1 > 10) || (c2 < 20) );
ALTER TABLE t1 ADD CONSTRAINT CHECK( (c1 > 10) OR (c2 < 20) );
--error 5689
INSERT INTO t1 VALUES(15,25);
--error 5689
INSERT INTO t1 VALUES(5,10);
SHOW CREATE TABLE t1;
DROP TABLE t1;
	
#测试带有default,null，逻辑运算符下check约束的行为
CREATE TABLE t1(c1 INT DEFAULT 2 PRIMARY KEY CHECK(c1 > 1 OR c1 IS NOT NULL));
SHOW CREATE TABLE t1;
#--error 5689
INSERT INTO t1 VALUES(NULL);
INSERT INTO t1 VALUES(1);
SELECT * FROM t1;
CREATE TABLE t2(c1 INT DEFAULT 2 PRIMARY KEY CHECK(c1 > 1 OR c1 > 2));
--error 5689
INSERT INTO t2 VALUES(1);
INSERT INTO t2 VALUES(2);
SELECT * FROM t2;
CREATE TABLE t3(c1 INT DEFAULT 2 PRIMARY KEY,c2 varchar(10) CHECK(c2 > 1 OR c2 IS NOT NULL));
#--error 5689
INSERT INTO t3 VALUES(1,NULL);
CREATE TABLE t4(c1 INT DEFAULT 2 PRIMARY KEY CHECK(c1 > 1 AND c1 IS NOT NULL));
--error 5689
INSERT INTO t4 VALUES(1);
--error 5689
INSERT INTO t4 VALUES(NULL);
DROP TABLE t1,t2,t3,t4;

#测试check约束中有数字比较
CREATE TABLE t1(c1 INT, c2 VARCHAR(20));
ALTER TABLE t1 ADD CONSTRAINT ck1 CHECK ( c1 > c2 );
SHOW CREATE TABLE t1;
DROP TABLE t1;

#不能引用主键自增列
--error 5686
CREATE TABLE t1 (f1 int primary key auto_increment, f2 int, CHECK (f1 != f2));
--error 5686
CREATE TABLE t1 (f1 int primary key auto_increment CHECK (f1 < 10), f2 int, CHECK (f1 != f2));
#不能有日期函数存在
--error 5684
CREATE TABLE t1 (f1 TIMESTAMP CHECK (f1 + NOW() > '2011-11-21'));
--error 5684
CREATE TABLE t1 (f1 TIMESTAMP CHECK (f1 + CURRENT_TIMESTAMP() > '2011-11-21 01:02:03'));		
--error 5684
CREATE TABLE t1 (f1 DATETIME CHECK (f1 + CURDATE() > '2011-11-21'));	
--error 5684
CREATE TABLE t1 (f1 TIMESTAMP CHECK (f1 + CURRENT_DATE > '2011-11-21'));	
#用户自定义变量
SET @v = 10;
--error 5693
CREATE TABLE t1 (id INT CHECK (id != @v));	
#系统变量
--error 5693
create table t1 (c1 int check (c1 > @@minor_num_limit));		
#子查询
--error 5682
CREATE TABLE t1 (id INT CHECK (id != (SELECT 1)));		
#存储过程
delimiter //;
CREATE PROCEDURE proc() SELECT 1;//
delimiter ;//
--error 5679 
CREATE TABLE t1 (id INT CHECK(id = proc()));
DROP PROCEDURE proc;		
#函数
delimiter //;
CREATE FUNCTION func() RETURNS INT DETERMINISTIC return 1;//
delimiter ;//
--error 5679
CREATE TABLE t1 (id INT CHECK(id = func()));
#--error 5001
DROP FUNCTION func;

###2-6:check约束中不同数据类型
#测试check约束中数字类型
CREATE TABLE t1 (
    c1 BIT(7) CHECK(c1 < b'1111100'),
    c2 BOOLEAN CHECK(c2 > 0),
    c3 TINYINT CHECK(c3 > 10),
    c4 SMALLINT CHECK(c4 > 10),
    c5 MEDIUMINT CHECK(c5 > 10),
    c6 INT CHECK(c6 > 10),
    c7 BIGINT CHECK(c7 > 10),
    c8 DECIMAL(6,2) CHECK(c8 > 10.1),
    c9 FLOAT CHECK(c9 > 10.1),
    c10 DOUBLE CHECK(c10 > 10.1));
--error 5689
INSERT INTO t1(c1) VALUES(b'1111110');
--error 5689
INSERT INTO t1(c2) VALUES(0);
--error 5689
INSERT INTO t1(c10) VALUES(10.0);
INSERT INTO t1(c1,c2,c3,c4,c5,c6,c7,c8,c9,c10)VALUES(B'1111000',1,11,11,11,11,11,10.2,10.2,10.2);	
select * from t1;

#测试check约束中字符串类型
drop table t1;
CREATE TABLE t1(c1 CHAR(1) CHECK(c1 > 'a'),
  c2 VARCHAR(1) CHECK(c2 > 'a'),
  c3 BINARY(1) CHECK(c3 > 'a'),
  c4 VARBINARY(1) CHECK(c4 > 'a'),
  c5 TINYBLOB CHECK(c5 > 'a'),
  c6 TINYTEXT CHECK(c6 > 'a'),
  c7 BLOB CHECK(c7 > 'a'),
  c8 TEXT CHECK(c8 > 'a'),
  c9 MEDIUMBLOB CHECK(c9 > 'a'),
  c10 MEDIUMTEXT CHECK(c10 > 'a'),
  c11 LONGBLOB CHECK(c11 > 'a'),
  c12 LONGTEXT CHECK(c12 > 'a'));
SHOW CREATE TABLE t1;
--error 5689
INSERT INTO t1(c1) VALUES('a');
--error 5689
INSERT INTO t1(c12) VALUES('a');
INSERT INTO t1(c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12)VALUES('b','b','b','b','b','b','b','b','b','b','b','b');
DROP TABLE t1;	

#测试check约束中日期时间类型	
CREATE TABLE t1 (c1 DATE CHECK(c1 > '2007-01-01'),
  c2 DATETIME CHECK(c2 > '2007-01-01 12:00:01'),
  c3 TIMESTAMP CHECK(c3 > '2007-01-01 00:00:01.000000'),
  c4 TIME CHECK(c4 > '12:00:01.000000'));
--error 5689
INSERT INTO t1(c1) VALUES('2006-01-01');
--error 5689
INSERT INTO t1(c2) VALUES('2007-01-01 11:00:01');
--error 5689
INSERT INTO t1(c3) VALUES('2007-01-01 00:00:00.000000');
--error 5104
INSERT INTO t1(c4) VALUES('12:00:00.000000');
DROP TABLE t1;

#测试check约束中json类型
CREATE TABLE t1(id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(255),browser JSON CHECK( browser->'$.name' = 'Chrome' ));
--error 5689
INSERT INTO t1(name,browser)VALUES('pageview','{ "name": "Safari", "os": "Mac" }');
INSERT INTO t1(name,browser)VALUES('pageview','{ "name": "Chrome", "os": "Mac" }');
SELECT * FROM t1;
DROP TABLE t1;

#测试check约束中有正则表达式	
CREATE TABLE student (    
 id       INT,   
 stu_code  VARCHAR(10),  
 name     VARCHAR(14),    
 email    VARCHAR(20),    
 scholarship  INT,   
 country  VARCHAR(20),  
  CONSTRAINT ck1 CHECK (id != 0), 
  CONSTRAINT ck2 CHECK (stu_code like 'j%'),  
  CONSTRAINT ck3 CHECK (lower(name) != 'noname'),  
  CONSTRAINT ck4 CHECK ( email REGEXP('@')),  
  CONSTRAINT ck5 CHECK (scholarship BETWEEN 5000 AND 20000), 
  CONSTRAINT ck6 CHECK (country IN ('usa','uk')) );
SHOW CREATE TABLE student;
--error 5689
INSERT INTO student VALUES(0,'j001','name1','name1@oracle.com',6000,'usa');
--error 5689
INSERT INTO student VALUES(1,'s001','name1','name1@oracle.com',6000,'usa');
--error 5689
INSERT INTO student VALUES(1,'j001','NONAME','name1@oracle.com',6000,'usa');
--error 5689
INSERT INTO student VALUES(1,'j001','name1','name1@oracle.com',6000,'nocountry');
INSERT INTO student VALUES(1,'j001','name1','name1@oracle.com',6000,'usa');
SELECT * FROM student;
DROP TABLE student;

###2-7：结合其它功能测试
#测试外键约束与check约束搭配使用	
CREATE TABLE parent(pid INT NOT NULL PRIMARY KEY CHECK(pid > 1));
CREATE TABLE child(cid INT CHECK(cid > 1),CONSTRAINT fk FOREIGN KEY (cid) REFERENCES parent(pid));
SHOW CREATE TABLE parent;
SHOW CREATE TABLE child;
INSERT INTO parent VALUES(2);
--error 5689
INSERT INTO child VALUES(1);
--error 5209
INSERT INTO child VALUES(3);
INSERT INTO child VALUES(2);
SELECT * FROM parent;
SELECT * FROM child;
DROP TABLE child;
DROP TABLE parent;

#测试事务中check约束的行为
CREATE TABLE t1(c1 INT);
CREATE TABLE t2(c1 INT CHECK(c1 > 10));
SET AUTOCOMMIT = 0;
# Transaction 1
START TRANSACTION;
INSERT INTO t1 VALUES(1);
--error 5689
INSERT INTO t2 VALUES(1);
ROLLBACK;
SELECT * FROM t1;
SELECT * FROM t2;
--real_sleep 1
ALTER TABLE t1 ADD CONSTRAINT CHECK (C1 > 10);
COMMIT;
SHOW CREATE TABLE t1;
SET AUTOCOMMIT = 1;
DROP TABLE t1,t2;	
	
#测试check约束和可更新的视图	
CREATE TABLE t1(c1 INT, c2 INT CHECK (c2 < 10));
CREATE VIEW v1 AS SELECT * FROM t1;
--error 5689
INSERT INTO v1 VALUES(1,20);
INSERT INTO v1 VALUES(1,5);
SELECT * FROM t1;
SELECT * FROM v1;
DROP VIEW v1;
DROP TABLE t1;

#类型转换失败导致的check约束失败的show warnings错误汇报
CREATE TABLE t1 (f1 CHAR(10) CHECK (f1 < 10));
--error 5006
INSERT INTO t1 VALUES ("xy");
SHOW WARNINGS;
DROP TABLE t1;
	
#更改列时如果有check约束那么不能更改
CREATE TABLE t1 (f1 INT, f2 INT, f3 INT, f4 FLOAT , f5 INT, CHECK (f1 < f2));
--error 5691
ALTER TABLE t1 DROP COLUMN f1;
--error 5691
ALTER TABLE t1 RENAME COLUMN f1 TO f6;
drop table t1;

#存储过程中含有check约束
delimiter //;
--sleep 3
create procedure p1 ()
begin
	create table t1 (c1 int check(c1 > 1));
end //
delimiter ;//
call p1();
show tables;
show create table t1;

#用户自定义函数中含有check约束
delimiter //;
--sleep 3
CREATE FUNCTION fun() RETURNS INT DETERMINISTIC 
begin 
	create table t_ck (c1 int ,c2 double ,check(c2 > c1));  
	return 1; 
end //
--error 1
select fun()//

###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
