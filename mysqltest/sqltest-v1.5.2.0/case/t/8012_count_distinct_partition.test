#########################################必填##################################################
###1.测试功能点：有分区时count和count(distinct)测试
##
#
###2.测试项：
###2.问题网址：
###3.问题号：
###4.预计运行时间：20 s
###5.编写/修改人：chensy
###6.编写/修改日期：2019-11-04
###7.其他（选填）：
###
##
#
##############################################################################################

#####################################Do sql####################################################

###2-1 枚举分区时count和count(distinct)测试
##
## Problem with count(distinct)
##
#
--disable_warnings
drop table if exists t1,t2,t3;
--error 5077
drop partition function e1,e2;
--enable_warnings
create enum partition function e1(x) '[(New York Public Libra)],[(San Fransisco Public)],[(Berkeley Public1)],[(Berkeley Public2)],[(NYC Lib)]';
create table t1 (libname varchar(21) not null, city varchar(256), primary key (libname)) partition by(ta1,e1,libname);
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
create enum partition function e2(x) '[(001)],[(002)],[(003)],[(004)],[(005)],[(006)],[(007)]';
create table t2 (isbn varchar(21) not null, author  varchar(256), title  varchar(256), primary key (isbn))partition by(ta2,e2,isbn);
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
create table t3 (isbn varchar(21) not null, libname  varchar(21) not null, quantity int , primary key (isbn,libname)) partition by list columns(isbn,libname)(partition a1 values in(('001','New York Public Libra'),('002','New York Public Libra')),partition a2 values in(('003','New York Public Libra'),('004','New York Public Libra')),partition a3 values in(('005','New York Public Libra'),('006','San Fransisco Public')),partition a4 values in(('007','Berkeley Public1'),('007','Berkeley Public2')));
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 6
insert into t2 values ('001','Daffy','A duck''s life');
insert into t2 values ('002','Bugs','A rabbit\'s life');
insert into t2 values ('003','Cowboy','Life on the range');

insert into t2 values ('004','Best Seller','One Heckuva book');
insert into t2 values ('005','EveryoneBuys','This very book');
insert into t2 values ('006','San Fran','It is a san fran lifestyle');
insert into t2 values ('007','BerkAuthor','Cool.Berkley.the.book');

insert into t3 values ('001','New York Public Libra','2');
insert into t3 values ('002','New York Public Libra','3');
insert into t3 values ('003','New York Public Libra','4');
insert into t3 values ('004','New York Public Libra','5');
insert into t3 values ('005','New York Public Libra','6');
insert into t3 values ('006','San Fransisco Public','5');
insert into t3 values ('007','Berkeley Public1','3');
insert into t3 values ('007','Berkeley Public2','3');

insert into t1 values ('New York Public Libra','New York');
insert into t1 values ('San Fransisco Public','San Fran');
insert into t1 values ('Berkeley Public1','Berkeley');
insert into t1 values ('Berkeley Public2','Berkeley');
insert into t1 values ('NYC Lib','New York');

select t2.isbn,city,t1.libname,count(t1.libname) as a from t3 left join t1 on t3.libname=t1.libname left join t2 on t3.isbn=t2.isbn group by city,t1.libname;
select t2.isbn,city,count(distinct t1.libname) as a from t3 left join t1 on t3.libname=t1.libname left join t2 on t3.isbn=t2.isbn group by city having count(distinct t1.libname) > 1;

drop table t1,t2,t3;
drop partition function e1,e2;

###2-2 哈希分区时空表的count(distinct)测试
#
#
##
## Empty tables
##

create hash partition function h1(x)'x+3';
create table t1 (f int primary key,f2 int)partition by(ta1,h1,f);
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 3
select count(distinct f) from t1;
drop table t1;
drop partition function h1;

###2-3 对两列枚举分区时count(distinct)测试
##
## Bug #6515
##
#

create enum partition function e3(x,y)'[(ABW,Dutch)],[(ABW,English)]';
create table t1(a char(3), b char(20),c int,primary key (a, b))partition by(ta1,e3,a,b);
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 6
insert into t1(a,b) values ('ABW', 'Dutch'), ('ABW', 'English');
##chensy, need delete sleep after have snapshot
--real_sleep 3
select count(distinct a) from t1 group by b;
drop table t1;
drop partition function e3;
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;

###///新添测试项///###
###2-x：（新增测试项说明）
#do sql
#####################################Do sql####################################################