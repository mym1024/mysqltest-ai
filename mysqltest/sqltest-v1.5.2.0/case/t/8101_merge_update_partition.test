--source merge.sql
##############################################################################################
###1.测试功能点：更新主键为integer且带有range分区的表中的数据
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：xxx
###4.问题号：xxx
###5.预计运行时间：750s
###6.编写/修改人：
###7.编写/修改日期：2019/11/14
###8.其他（选填）：case格式规范化修改
###
##
#
##############################################################################################

#####################################Do sql###################################################

--disable_warnings
drop table if exists sbtest;
--enable_warnings

alter system set min_drop_cache_wait_time='10s' server_type=yaodatasvr;
alter system set each_tablet_sync_meta=False server_type=yaodatasvr;
alter system set balance_max_concurrent_migrate_num=30 server_type=yaoadminsvr;
alter system set balance_max_migrate_in_per_ds=6 server_type=yaoadminsvr;
alter system set balance_max_migrate_out_per_ds=6 server_type=yaoadminsvr;
alter system set max_migrate_task_count=6 server_type=yaodatasvr;
#创建带range分区的表
create table sbtest(id integer not null,k integer default 0 not null,c char(120) default '' not null, pad char(60) default '' not null,primary key (id)) partition by range(id)(partition r0 values less than(5),partition r1 values less than(100),partition r2 values less than maxvalue);
#插入100条数据
--echo insert 100 rows to ups
--real_sleep 5
--let $count=1
while($count < 101)
{
   --let $stmt=insert into sbtest(id,k,c,pad) values($count,0,' ','qqqqqqqqqqwwwwwwwwwweeeeeeeeeerrrrrrrrrrtttttttttt')
   eval $stmt;
   inc $count;

}

#发起合并
--echo merge
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 300

#查询每条数据
--let $count=1
while($count < 101)
{
   --let $stmt=select * from sbtest where id = $count
   eval $stmt;
   inc $count;
}

#在插入100条数据
--echo insert another 100 rows to ups

--let $count=101
while($count < 201)
{
   --let $stmt=insert into sbtest(id,k,c,pad) values($count,0,' ','qqqqqqqqqqwwwwwwwwwweeeeeeeeeerrrrrrrrrrtttttttttt')
   eval $stmt;
   inc $count;
}

#发起合并
--echo merge
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 300

#查询刚插入的数据
--let $count=101
while($count < 201)
{
   --let $stmt=select * from sbtest where id = $count
   eval $stmt;
   inc $count;
}

#在插入100条数据
--echo insert another 100 rows to ups

--let $count=201
while($count < 301)
{
   --let $stmt=insert into sbtest(id,k,c,pad) values($count,0,' ','qqqqqqqqqqwwwwwwwwwweeeeeeeeeerrrrrrrrrrtttttttttt')
   eval $stmt;
   inc $count;
}

#更新数据并确认
--let $count=1
while($count < 101)
{
  eval update sbtest set pad = 'qwt' where id = $count;
  eval select * from sbtest where id = $count;
  inc $count;
  inc $count;
  inc $count;
  inc $count;
  inc $count;
}
--let $count=101
while($count < 201)
{
  eval update sbtest set pad = 'qwt' where id = $count;
  eval select * from sbtest where id = $count;
  inc $count;
  inc $count;
  inc $count;
  inc $count;
  inc $count;
}
--let $count=201
while($count < 301)
{
  eval update sbtest set pad = 'qwt' where id = $count;
  eval select * from sbtest where id = $count;
  inc $count;
  inc $count;
  inc $count;
  inc $count;
  inc $count;
}

#删除表
--real_sleep 200
drop table sbtest;

###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
