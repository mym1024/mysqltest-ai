#######################################################
#1.���Թ��ܵ㣺��ָ������������У���֤�������ȷ��
#######################################################

--disable_warnings
drop table if exists t1,t2,t3,t4;
--enable_warnings


connect(conn1,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connect(conn2,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connect(conn3,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);

##
###2-1:hash�������У���֤�������ȷ��
##

connection conn1;
--error 5077
drop partition function h;
create hash partition function h(x) 'x+1';
create table t1(pk int primary key, a int) partition by(hs,h,pk);
--real_sleep 5
insert into t1 values(1,1);

begin;
--echo use conn1,update t1
update t1 set a=2 where pk=1;
--echo use conn1, select before conn1 commit, expect: (1,1)
select * from t1;

--echo use conn2, select before conn1 commit, expect: (1,1)
connection conn2;
select * from t1;

connection conn1;
commit;

--echo use conn2, select after conn1 commit, expect: (1,2)
connection conn2;
select * from t1;

drop table t1;


##
###2-2: enum����������У���֤�������ȷ��
##
connection conn1;
--error 5077
drop partition function e;
create enum partition function e(x) '[(1)],[(3)]';
create table t1(pk int primary key, a int) partition by(em,e,pk);
--real_sleep 5
insert into t1 values(1,1);

--echo conn2 begin
connection conn2;
begin;

--echo conn3 begin
connection conn3;
begin;

--echo conn2 set a to 2
connection conn2;
select * from t1;
update t1 set a=2 where pk=1;

--echo conn3 set a to 3, have to rollback
connection conn3;
select * from t1;
--error 5049
update t1 set a=3 where pk=1;
ROLLBACK;

--echo conn2  select
connection conn2;
select * from t1;

--echo conn3 select
connection conn3;
select * from t1;

--echo conn2 commit and select
connection conn2;
commit;
select * from t1;

--echo conn2  select
connection conn2;
select * from t1;

--echo conn3 select
connection conn3;
select * from t1;

drop table t1;

##
###2-3:range�������У���֤�������ȷ��
##

connection conn1;
create table t1(pk int primary key, a int) partition by range(pk) (partition r0 values less than(5), partition r1 values less than(10), partition r2 values less than(15), partition r3 values less than maxvalue);
--real_sleep 5
insert into t1 values(1,1);

--echo conn2 changes: 1->2->3
connection conn2;
begin;
update t1 set a=a+1 where pk=1;
update t1 set a=a+1 where pk=1;
select * from t1;
commit;

--echo conn2 select after commit
select * from t1;

--echo conn3 select after commit
connection conn3;
select * from t1;

drop table t1;

