###########################################################################################
###1.测试功能点：truncate与多表并发事务冲突时是否能检测到冲突报错
##
#
###2.测试项：（每新添一测试项,需在添加前注明测试项,注释填写在新添sql前,不填在此处,如下样例）
###2.问题网址：xxx
###3.问题号：xxx
###4.预计运行时间：xxx
###5.编写/修改人：yuanzhuping
###6.编写/修改日期：2019-11-18
###7.其它（选填）：case格式标准化修改
###
##
#
###########################################################################################

##########################################################################################
--disable_warnings
drop table if exists t1;
drop table if exists t2;
drop table if exists t3;
drop table if exists t4;
--enable_warnings

#建表，插入数据
create table t1 (c1 int primary key,c2 int);
create table t2 (c1 int primary key,c2 int);
create table t3 (c1 int primary key,c2 int);
create table t4 (c1 int primary key,c2 int);

#开两个客户端
connect (conn1,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connect (conn2,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);

#2-1连接客户端1 对表t1,t2,t3进行更新,先不提交
connection conn1;
echo 'conn1';
start transaction;
insert into t1 values(1,1);
insert into t2 values(1,1);
insert into t3 values(1,1);

#连接客户端2 truncate表t1
connection conn2;
echo 'conn2';
truncate table t1;
select * from t1;
select * from t2;
select * from t3;

#连接客户端1 事务提交
connection conn1;
echo 'conn1';
--error 155
commit;
select * from t1;
select * from t2;
select * from t3;

#2-2在客户端1 对表t1,t2,t3进行更新，先不提交
echo 'conn1';
start transaction;
insert into t1 values(2,2);
insert into t2 values(2,2);
insert into t3 values(2,2);

#连接客户端2 truncate表t2
connection conn2;
echo 'conn2';
truncate table t2;
select * from t1;
select * from t2;
select * from t3;

#连接客户端1
connection conn1;
echo 'conn1';
--error 155
commit;
select * from t1;
select * from t2;
select * from t3;

#2-3在客户端1 对表t1,t2,t3进行更新，先不提交
echo 'conn1';
set autocommit = 0;
insert into t1 values(3,3);
insert into t2 values(3,3);
insert into t3 values(3,3);

#连接客户端2 truncate表t3
connection conn2;
echo 'conn2';
truncate table t3;
select * from t1;
select * from t2;
select * from t3;

#连接客户端1
connection conn1;
echo 'conn1';
--error 155
commit;
select * from t1;
select * from t2;
select * from t3;

#2-4在客户端1 对表t1,t2,t3进行更新，先不提交
echo 'conn1';
insert into t1 values(4,4);
insert into t2 values(4,4);
insert into t3 values(4,4);

#连接客户端2 truncate表t4
connection conn2;
echo 'conn2';
truncate table t4;
select * from t1;
select * from t2;
select * from t3;

#连接客户端1
connection conn1;
echo 'conn1';
commit;
select * from t1;
select * from t2;
select * from t3;

#2-5在客户端1 对表t1,t2,t3进行更新，先不提交
echo 'conn1';
insert into t1 values(5,5);
insert into t2 values(5,5);
insert into t3 values(5,5);

#连接客户端2 truncate表t1,t2
connection conn2;
echo 'conn2';
truncate table t1,t2;
select * from t1;
select * from t2;
select * from t3;

#连接客户端1
connection conn1;
echo 'conn1';
--error 155
commit;
select * from t1;
select * from t2;
select * from t3;

#2-6在客户端1 对表t1,t2,t3进行更新，先不提交
echo 'conn1';
insert into t1 values(6,6);
insert into t2 values(6,6);
insert into t3 values(6,6);

#连接客户端2 truncate表t1,t3
connection conn2;
echo 'conn2';
truncate table t1,t3;
select * from t1;
select * from t2;
select * from t3;

#连接客户端1
connection conn1;
echo 'conn1';
--error 155
commit;
select * from t1;
select * from t2;
select * from t3;

drop table t1;
drop table t2;
drop table t3;
drop table t4;





