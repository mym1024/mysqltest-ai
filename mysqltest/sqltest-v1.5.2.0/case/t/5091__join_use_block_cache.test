--source merge.sql
###########################################################################################
###1.测试功能点：join中指定use_block_cache参数
##
#
###2.测试项：（每新添一测试项,需在添加前注明测试项,注释填写在新添sql前,不填在此处,如下样例）
###2.问题网址：xxx
###3.问题号：xxx
###4.预计运行时间：xxx
###5.编写/修改人：zhuyiying
###6.编写/修改日期：2020-01-03
###7.其它（选填）：case格式规范化修改
###
##
#
###########################################################################################

##########################################################################################
--disable_warnings
drop table if exists t1,t2,t3;
--enable_warnings
alter system set min_drop_cache_wait_time='2s' server_type=yaodatasvr;

#merge join(其中一个表使用block cache)
create table t1 (c1 int primary key, c2 varchar(8), c3 varchar(8));
create table t2 (c1 int primary key, c2 varchar(8), c3 varchar(8));
replace into t1 values(1,'b1','c1');
replace into t1 values(2,'b2','c2');
replace into t1 values(3,'b3','c3');
replace into t2 values(1,'b1','c1');
replace into t2 values(2,'b2','c2');
replace into t2 values(3,'b3','c3');
--echo "merge"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 40
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

alter table t1 alter current use_block_cache=true;
alter table t2 alter current use_block_cache=false;
select * from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

select * from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

alter table t1 alter current use_block_cache=false;
select * from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n
#semi join
--echo "merge"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 40
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

alter table t1 alter current use_block_cache=true;
alter table t2 alter current use_block_cache=true;
select /*+JOIN(SI)*/* from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

select /*+JOIN(SI)*/* from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

alter table t1 alter current use_block_cache=false;
alter table t2 alter current use_block_cache=false;
select /*+JOIN(SI)*/* from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

#hash join
--echo "merge"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 40
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

alter table t1 alter current use_block_cache=true;
alter table t2 alter current use_block_cache=true;
select /*+JOIN(HASH_JOIN_SINGLE)*/* from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

select /*+JOIN(HASH_JOIN_SINGLE)*/* from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

alter table t1 alter current use_block_cache=false;
alter table t2 alter current use_block_cache=false;
select /*+JOIN(HASH_JOIN_SINGLE)*/* from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

#bloomfilter join
--echo "merge"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 40
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

alter table t1 alter current use_block_cache=true;
alter table t2 alter current use_block_cache=true;
select /*+JOIN(BLOOMFILTER_JOIN)*/* from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

select /*+JOIN(BLOOMFILTER_JOIN)*/* from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n

alter table t1 alter current use_block_cache=false;
alter table t2 alter current use_block_cache=false;
select /*+JOIN(BLOOMFILTER_JOIN)*/* from t1 join t2 on t1.c2 = t2.c2;
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_hit',value,1)
--echo $n
--let $n=query_get_value(select value from (select * from __all_server_stat) where svr_type='yaodatasvr' and name='block_cache_miss',value,1)
--echo $n
