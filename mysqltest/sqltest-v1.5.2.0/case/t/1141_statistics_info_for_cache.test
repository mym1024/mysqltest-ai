--source merge.sql
####################################必填######################################################
###1.测试功能点：统计信息缓存模块测试
##
#
###2.测试项：(每新添一测试项, 需在添加前注明测试项, 注释填写在新添sq1前, 不填在此处, 如下样例）
###3.问题网址：http://182.119.80.93/cbase_dev/cbase/merge_requests/531
###4.问题号：432-feature_statistic_info_and_optimizer
###5.预计运行时间：xxx
###6.编写/修改人：张旭，张二宝
###7.编写/修改日期：20200903
###8.其他（选填）：新编case
###
##
#
##############################################################################################

#####################################Do sql###################################################
create database statistics_info;
using database statistics_info;
sleep 5;

###打开查询优化器开关
set yao_enable_query_optimizer=true;

#设置合并参数

###建表插数据（混合数据类型，不同值个数小于10）
create table if not exists t1(id1 int,id3 datetime,id4 varchar(20),col1 int,col2 datetime,col3 varchar(20),col4 decimal(10, 1), col5 double, col6 float, primary key(id1, id3, id4));
replace into t1 values (0,'1000-10-10 10:10:10', 'aaa', 3, '1000-10-10 10:10:10', 'bbb', 1.1, 2.2, 3.3);
replace into t1 values (1,'1000-10-10 10:10:10', 'aaa', 4, '1000-10-10 10:10:11', 'ccc', 1.2, 2.3, 3.4);
replace into t1 values (2,'1000-10-10 10:10:10', 'aaa', 5, '1000-10-10 10:10:12', 'ddd', 1.3, 2.4, 3.5);
replace into t1 values (3,'1000-10-10 10:10:10', 'aaa', 6, '1000-10-10 10:10:13', 'eee', 1.4, 2.5, 3.6);
replace into t1 values (4,'1000-10-10 10:10:10', 'aaa', 7, '1000-10-10 10:10:14', 'fff', 1.5, 2.6, 3.7);


###建表插数据（混合数据类型，不同值个数大于10）
create table if not exists t2(id1 int,id3 datetime,id4 varchar(20),col1 int,col2 datetime,col3 varchar(20),col4 decimal(10, 1), col5 double, col6 float, primary key(id1, id3, id4));
replace into t2 values (0,'1000-10-10 10:10:10', 'aaa', 3, '1000-10-10 10:10:10', 'bbb', 1.1, 2.2, 3.3);
replace into t2 values (1,'1000-10-10 10:10:10', 'aaa', 4, '1000-10-10 10:10:11', 'ccc', 1.2, 2.3, 3.4);
replace into t2 values (2,'1000-10-10 10:10:10', 'aaa', 5, '1000-10-10 10:10:12', 'ddd', 1.3, 2.4, 3.5);
replace into t2 values (3,'1000-10-10 10:10:10', 'aaa', 6, '1000-10-10 10:10:13', 'eee', 1.4, 2.5, 3.6);
replace into t2 values (4,'1000-10-10 10:10:10', 'aaa', 7, '1000-10-10 10:10:14', 'fff', 1.5, 2.6, 3.7);
replace into t2 values (5,'1000-10-10 10:10:10', 'aaa', 8, '1000-10-10 10:10:15', 'ggg', 1.6, 2.7, 3.8);
replace into t2 values (6,'1000-10-10 10:10:10', 'aaa', 9, '1000-10-10 10:10:16', 'hhh', 1.7, 2.8, 3.9);
replace into t2 values (7,'1000-10-10 10:10:10', 'aaa', 10, '1000-10-10 10:10:17', 'iii', 1.8, 2.9, 4.0);
replace into t2 values (8,'1000-10-10 10:10:10', 'aaa', 11, '1000-10-10 10:10:18', 'jjj', 1.9, 3.0, 4.1);
replace into t2 values (9,'1000-10-10 10:10:10', 'aaa', 12, '1000-10-10 10:10:19', 'kkk', 2.0, 3.1, 4.2);
replace into t2 values (10,'1000-10-10 10:10:10', 'aaa', 13, '1000-10-10 10:10:20', 'lll', 2.1, 3.2, 4.3);


###建表插数据（混合数据类型，含有NULL值）
create table if not exists t3(id1 int,id3 datetime,id4 varchar(20),col1 int,col2 datetime,col3 varchar(20),col4 decimal(10, 1), col5 double, col6 float, primary key(id1, id3, id4));
replace into t3 values (0,'1000-10-10 10:10:10', 'aaa', 3, '1000-10-10 10:10:10', 'bbb', 1.1, 2.2, 3.3);
replace into t3 values (1,'1000-10-10 10:10:10', 'aaa', 4, '1000-10-10 10:10:11', 'ccc', 1.2, 2.3, 3.4);
replace into t3 values (2,'1000-10-10 10:10:10', 'aaa', 5, '1000-10-10 10:10:12', 'ddd', 1.3, 2.4, 3.5);
replace into t3 values (3,'1000-10-10 10:10:10', 'aaa', 6, '1000-10-10 10:10:13', 'eee', 1.4, 2.5, 3.6);
replace into t3 values (4,'1000-10-10 10:10:10', 'aaa', 7, '1000-10-10 10:10:14', 'fff', 1.5, 2.6, 3.7);
replace into t3 values (5,'1000-10-10 10:10:10', 'aaa', 8, '1000-10-10 10:10:15', 'ggg', 1.6, 2.7, 3.8);
replace into t3 values (6,'1000-10-10 10:10:10', 'aaa', 9, '1000-10-10 10:10:16', 'hhh', 1.7, 2.8, 3.9);
replace into t3 values (7,'1000-10-10 10:10:10', 'aaa', 10, '1000-10-10 10:10:17', 'iii', 1.8, 2.9, 4.0);
replace into t3 values (8,'1000-10-10 10:10:10', 'aaa', 11, '1000-10-10 10:10:18', 'jjj', 1.9, 3.0, 4.1);
replace into t3 values (9,'1000-10-10 10:10:10', 'aaa', 12, '1000-10-10 10:10:19', 'kkk', 2.0, 3.1, 4.2);
replace into t3 values (10,'1000-10-10 10:10:10', 'aaa', 13, '1000-10-10 10:10:20', 'lll', 2.1, 3.2, 4.3);
replace into t3 values (11,'1000-10-10 10:10:10', 'aaa', NULL, NULL,NULL,NULL, NULL,NULL);

###合并，使索引生效
--echo “merge”
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 800 
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

###1. 生成统计任务，统计信息的不同值个数小于10
gather statistics t1(col1,col2,col3,col4,col5,col6);

###2. 生成统计任务，统计信息的不同值个数大于10
gather statistics t2(col1,col2,col3,col4,col5,col6);

###3. 生成统计任务，统计信息中含有NULL
gather statistics t3(col1,col2,col3,col4,col5,col6);

###查看收集任务
select * from __all_udi_monitor_list;

###启动收集命令
--echo "statistics"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT gather_statistics | tail -1;
--real_sleep 10

###查看统计信息
select * from __all_statistic_info;

###删表
drop table if exists t1;
drop table if exists t2;
drop table if exists t3;
drop database statistics_info;
########################################################################################################
