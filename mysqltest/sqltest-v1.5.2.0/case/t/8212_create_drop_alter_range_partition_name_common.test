--source merge.sql
##############################################################################################
###1.测试功能点：drop,create,alter range partition function
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：xxx
###4.问题号：xxx
###5.预计运行时间：xxx
###6.编写/修改人：zhuyinying
###7.编写/修改日期：2020-03-20
###8.其他（选填）：case格式规范化修改
###
##
#
##############################################################################################

#####################################Do sql###################################################
--disable_warnings
drop table if exists t1,t2,t3,t4,t5,t6,t7,t8,t9,t10,t11,t12,t13,t14,t15,t16,t17,t18,t19,t20;
--enable_warnings
alter system set balance_max_concurrent_migrate_num=30 server_type=yaoadminsvr;
alter system set balance_max_migrate_in_per_ds=6 server_type=yaoadminsvr;
alter system set balance_max_migrate_out_per_ds=6 server_type=yaoadminsvr;
alter system set max_migrate_task_count=6 server_type=yaodatasvr;

###2-1:create,alter,drop,以varchar类型作为分区键的单列，多列分区函数
create range partition function r1(x) '(\'d\'),(maxvalue)';
--error 65535
create range partition function r2(x) '(\'d\')';
--error 65535
create range partition function r2(x) '(d)';
create range partition function r3(x) '(\'d\'),(\'g\'),(maxvalue)';
--error 65535
create range partition function r4(x) '(\'d\'),(\'g\')';
--error 65535
create range partition function r4(x) '(d),(g),(maxvalue)';

create range partition function r5(x) '(\'d\'),(\'g\'),(\'q\'),(maxvalue)';
--error 65535
create range partition function r6(x) '(\'d\'),(\'g\'),(\'q\')';
--error 65535
create range partition function r6(x) '(\'f\'),(\'d\'),(\'z\'),(maxvalue)';

create range partition function r6(x) '(\'f\'),(\'r\'),(\'z\'),(maxvalue)';
--error 2
create range partition function r6(x) '(\'\\\'),(1)(maxvalue)';

create range partition function r7(x,y) '(\'dd\',\'dd\'),(maxvalue,\'ff\')';
--error 65535
create range partition function r8(x,y) '(\'dd\',\'dd\')';

create range partition function r9(x,y) '(\'dd\',\'dd\'),(\'hh\',\'hh\'),(maxvalue,\'ff\')';
--error 65535
create range partition function r10(x,y) '(\'dd\',\'dd\'),(\'hh\',\'hh\')';


create range partition function r11(x) '(5),(maxvalue)';
--error 65535
create range partition function r12(x) '(5)';
create range partition function r13(x) '(3),(6),(maxvalue)';
--error 65535
create range partition function r14(x) '(3),(6)';

create range partition function r15(x,y) '(3,3),(6,6),(maxvalue,1)';
--error 5088
create range partition function r16(x) '(3,3),(6,6)';

create range partition function r17(x,y) '(3,\'dd\'),(maxvalue,\'aa\')';
--error 65535
create range partition function r18(x,y) '(3,\'dd\'),(6,maxvalue)';
create range partition function r19(x,y) '(\'dd\',3),(\'ff\',6),(maxvalue,8)';
--error 65535
create range partition function r20(x,y) '(\'dd\',3),(\'ff\',6),(\'zz\',maxvalue)';
--error 65535
create range partition function r21(x,y) '(dd,3),(ff,6),(maxvalue,1)';

create table t1 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4));
create table t2 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg1,r1,c2);
create table t3 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (,r1,c2);
create table t4 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg0);
create table t5 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by ();
create table t6 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg3,r3,c2);
create table t7 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg5,r5,c2);
create table t8 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg6,r6,c2);
create table t9 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg7,r7,c2,c4);
create table t10 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg9,r9,c2,c4);

create table t11 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg11,r11,c1);
create table t12 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg13,r13,c1);

create index il3 on t3(c2) storing(c5);
create index il7 on t7(c2) storing(c6);

--echo "refesh_schema"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
sleep 5;
show partition groups;
show table rules;

insert into t1 values (1,'a',1,'a',1,'a'),(2,'b',2,'b',2,'b'),(3,'d',3,'d',3,'d');
replace into t1 values (4,'g',4,'g',4,'g'),(5,'t',5,'t',5,'t'),(6,'cf',6,'cf',6,'cf');
replace into t2 values (1,'a',1,'a',1,'a'),(3,'d',3,'d',3,'d'),(6,'cf',6,'cf',6,'cf');

insert into t3 values (1,'a',1,'a',1,'a'),(2,'b',2,'b',2,'b'),(3,'d',3,'d',3,'d'),(6,'cf',6,'cf',6,'cf');
insert into t4 values (1,'a',1,'a',1,'a'),(3,'d',3,'d',3,'d');
replace into t4 values (4,'g',4,'g',4,'g'),(6,'cf',6,'cf',6,'cf');

insert into t5 values (1,'a',1,'a',1,'a'),(3,'d',3,'d',3,'d');
replace into t5 values (4,'g',4,'g',4,'g'),(6,'cf',6,'cf',6,'cf');

insert into t6 values (1,'a',1,'a',1,'a'),(3,'d',3,'d',3,'d');
replace into t6 values (4,'g',4,'g',4,'g'),(6,'cf',6,'cf',6,'cf');

insert into t7 values (1,'aa',1,'aa',1,'aa'),(3,'dd',3,'dd',3,'dd');
replace into t7 values (4,'gg',4,'gg',4,'gg'),(6,'cf',6,'cf',6,'cf');

insert into t8 values (1,'aa',1,'aa',1,'aa'),(2,'bb',2,'bb',2,'bb'),(3,'dd',3,'dd',3,'dd');
insert into t9 values (1,'aa',1,'aa',1,'aa'),(2,'bb',2,'bb',2,'bb'),(3,'dd',3,'dd',3,'dd');
--real_sleep 1
replace into t9 values (4,'gg',4,'gg',4,'gg'),(5,'tt',5,'tt',5,'tt'),(6,'cf',6,'cf',6,'cf');
insert into t10 values (1,'aa',1,'aa',1,'aa'),(2,'bb',2,'bb',2,'bb'),(3,'dd',3,'dd',3,'dd');
--real_sleep 1
replace into t10 values (4,'gg',4,'gg',4,'gg'),(5,'tt',5,'tt',5,'tt'),(6,'cf',6,'cf',6,'cf');
insert into t11 values (1,'aa',1,'aa',1,'aa'),(2,'bb',2,'bb',2,'bb'),(3,'dd',3,'dd',3,'dd');
--real_sleep 1
replace into t11 values (4,'gg',4,'gg',4,'gg'),(5,'tt',5,'tt',5,'tt'),(6,'cf',6,'cf',6,'cf');
insert into t12 values (1,'aa',1,'aa',1,'aa'),(2,'bb',2,'bb',2,'bb'),(3,'dd',3,'dd',3,'dd');
--real_sleep 1
replace into t12 values (4,'gg',4,'gg',4,'gg'),(5,'tt',5,'tt',5,'tt'),(6,'cf',6,'cf',6,'cf');

select count(*) from t3;
truncate table t3;
sleep 1;
select count(*) from t3;
select * from t3 where c1=2;

show index on t3;
show index on t7;

insert into t2 values(7,'c',7,'c',7,'c'),(8,'f',8,'f',8,'f');
replace into t3 values (8,'f',8,'f',8,'f');
insert into t4 values(7,'c',7,'c',7,'c'),(8,'f',8,'f',8,'f');
replace into t5 values (8,'f',8,'f',8,'f');
replace into t6 values (8,'f',8,'f',8,'f');
replace into t7 values (8,'ff',8,'ff',8,'ff');
replace into t9 values (8,'ff',8,'ff',8,'ff');
replace into t12 values (8,'ff',8,'ff',8,'ff');

select *from t1;
select *from t2;
select *from t3;
select *from t4;
select *from t5;
select *from t6;
select *from t7;
select *from t9;
select *from t10;
select *from t11;
select *from t12;

update t2 set c5=c1*10 where c1<4;
update t3 set c6=c6 || '123' where c3>5;
update t4 set c2=c2+10 where c3 between 2 and 5;
update t5 set c4='abc'|| 'space',c5=c5*10 where c1 in(2,3,4);
update t9 set c1=c1*10,c2=c2|| 'space',c5=c5+10 where c3%2>0;
update t12 set c3=c1+c3+c5,c4=c4||c2 where c2=2 or c2=6;

select *from t2;
select *from t3;
select *from t4;
select *from t5;
select *from t9;
select *from t12;

truncate table t5;
select * from t5;
select * from t5 where c1 in(2,3,4);
create table t13 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg15,r15,c1,c3);
create table t14 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg17,r17,c1,c2);
create table t15 (c1 int not null,c2 varchar(10) default 'nullstr',c3 int,c4 varchar(30),c5 int,c6 varchar(30),primary key(c1,c2,c3,c4)) partition by (rg19,r19,c2,c1);

show partition groups;
show table rules;

create index il13 on t13(c4,c1) storing(c6);
create index il14 on t14(c2,c1) storing(c5);
--error 5031
create index il15 on t15(c2,c1) storing(c4);
create index il15 on t15(c4,c6) storing(c5);

--echo "refesh_schema"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
sleep 3;


show index on t13;
show index on t14;

replace into t13 values (1,'cc',1,'cc',1,'cc');
replace into t13 values (6,'tt',6,'tt',6,'tt');
replace into t14 values (1,'cc',1,'cc',1,'cc');
replace into t14 values (3,'ff',3,'ff',3,'ff');
replace into t14 values (6,'tt',6,'tt',6,'tt');
replace into t15 values (1,'cc',1,'cc',1,'cc');
replace into t15 values (3,'ff',3,'ff',3,'ff');
replace into t15 values (6,'tt',6,'tt',6,'tt');

select * from t13;
select * from t14;
select * from t15;

#--error 65535
create range partition function rge(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q) '(\'c\',\'d\',\'e\',\'f\',\'g\',\'h\',\'i\',\'j\',\'k\',\'l\',\'m\',\'n\',\'o\',\'p\',\'q\',\'w\',\'z\'),(maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue,maxvalue)';
###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
