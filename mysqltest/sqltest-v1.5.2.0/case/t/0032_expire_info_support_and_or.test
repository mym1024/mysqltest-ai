--source merge.sql
####################################必填######################################################
###1.测试功能点：expire_info功能完善：带有索引的表功能测试
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：http://182.119.80.93/cbase_dev/cbase/issues/507
###4.问题号：507
###5.预计运行时间：2120 s
###6.编写/修改人：yangruirui
###7.编写/修改日期：2020-10-26 / mod:2020-12-24:zyy
###8.其他（选填）：According to the 608-expire_info_support_int_type, mod this case
###
##
#
##############################################################################################

#####################################Do sql###################################################
alter system set balance_max_concurrent_migrate_num=30 server_type=yaoadminsvr;
alter system set balance_max_migrate_in_per_ds=6 server_type=yaoadminsvr;
alter system set balance_max_migrate_out_per_ds=6 server_type=yaoadminsvr;
alter system set max_migrate_task_count=6 server_type=yaodatasvr;
--disable_warnings
drop table if exists test1;
drop table if exists test2;
drop table if exists test3;
drop table if exists test4;
drop table if exists test5;
drop table if exists test6;
drop table if exists test7;
drop table if exists test8;
drop table if exists test9;
drop table if exists test10;
drop table if exists test11;
drop table if exists test12;
drop table if exists test13;
drop table if exists test14;

--enable_warnings
alter system set location_cache_timeout='6s' server_type=yaosqlsvr;


##################################### 异常 ###################################################
#修改列涉及过期列：(不允许修改，失败)
drop table if exists test;
create table test(c1 int primary key, c2 int, c3 int, c4 varchar(30));
alter table test add current expire_info='c4>=#2020-08-07# and c4<=#2020-08-09#';
--error 1046
alter table test drop c4;

#修改列涉及过期列：(不允许修改，失败)
drop table if exists test;
create table test(c1 int primary key, c2 int, c3 int, c4 varchar(30));
alter table test add current expire_info='c4>=#2020-08-07# and c3>2';
--error 1046
alter table test drop c3;
--error 1046
alter table test drop c4;

#and连接的列不在索引表中：(不允许修改，失败)
drop table if exists test;
create table test(c1 int primary key, c2 int, c3 int, c4 varchar(30));
create index idx on test(c2);
--error 152
alter table test add current expire_info='c4>=#2020-08-07# and c4<=#2020-08-09#';

#and连接的列不在索引表中：(不允许修改，失败)
drop table if exists test;
create table test(c1 int primary key, c2 int, c3 int, c4 varchar(30));
create index idx on test(c2,c4);
--error 152
alter table test add current expire_info='c4>=#2020-08-07# and c3>1';

#or连接的列类型不符合限制：(不允许修改，失败)
drop table if exists test;
create table test(c1 int primary key, c2 int, c3 int, c4 datetime);
--error 2
alter table test add current expire_info='c4=\'test\' or c4=\'game\'';

#and连接时间表示格式错误:(不允许建立，失败)
drop table if exists test;
--error 2
create table test(c1 int primary key, c2 int, c3 varchar(30), c4 datetime)expire_info='$SYS_DATE>1*24*60*60*1000000+c4 and c2>2';

#字符串后面不允许有运算:(不允许建立，失败)
drop table if exists test;
--error 2
create table test(c1 int primary key, c2 int, c3 int, c4 varchar(30))expire_info='c4=\'test\'+2';

#and连接的条件有表达式格式不正确:(不允许建立，失败)
drop table if exists test;
--error 2
create table test(c1 int primary key, c2 int, c3 varchar(30), c4 datetime)expire_info='c4=#2020-08-07# and c3=test';
#--error 2
create table test(c1 int primary key, c2 int, c3 varchar(30), c4 datetime)expire_info='c1=#2020-08-07# and c3=\'test\'';


##################################### 正常功能测试 ###################################################
###2-1 创建含有varchar属性列的数据表Test1:
create table test1(c1 int primary key, c2 int, c3 int, c4 varchar(30));

#新增varchar列与指定字符串'test'比较的过期信息
alter table test1 add current expire_info='c4=\'test\' or c4=\'game\'';

#插入数
insert into test1 values(1,1,1,'test');
insert into test1 values(2,2,1,'game');
insert into test1 values(3,3,1,'program');
insert into test1 values(4,4,1,'test');
insert into test1 values(5,0,1,'test');

###2-2 创建含有datetime属性列的数据表Test2:
create table test2(c1 int primary key, c2 int, c3 int, c4 datetime);

#新增datetime列与指定常量时间戳比较的and形式过期信息
alter table test2 add current expire_info='c4>=#2020-08-07# and c4<=#2020-08-09#';

#插入数据
insert into test2 values(1,1,1,'2020-08-07');
insert into test2 values(2,1,1,'2020-08-08');
insert into test2 values(3,1,1,'2020-08-09');
insert into test2 values(4,1,1,'2021-08-11');
insert into test2 values(5,1,1,'2021-08-14  18:00:00');

###2-3 创建含有datetime属性列的数据表Test3:
create table test3(c1 int primary key, c2 int, c3 int, c4 datetime);

#新增datetime列与指定常量时间戳比较的and形式过期信息
alter table test3 add current expire_info='c4=#2020-08-07# or c4=#2020-08-09#';

#插入数据
insert into test3 values(1,1,1,'2020-08-07');
insert into test3 values(2,1,1,'2020-08-07');
insert into test3 values(3,1,1,'2020-08-09');
insert into test3 values(4,1,1,'2021-08-11');
insert into test3 values(5,1,1,'2021-08-14  18:00:00');

###2-4 创建含有varchar属性列的数据表Test4:
create table test4(c1 int primary key, c2 int, c3 int, c4 varchar(30));

#新增varchar列过期信息
alter table test4 add current expire_info='c4>=#2020-08-07# and c4<=#2020-08-09#';

#插入数据
insert into test4 values(1,1,1,'20200807');
insert into test4 values(2,1,1,'20200808');
insert into test4 values(3,1,1,'2020/08/09');
insert into test4 values(4,1,1,'20200811');
insert into test4 values(5,1,1,'2020/08/26');
insert into test4 values(8,1,1,'20200827');

###2-5 创建含有varchar属性列和datetime属性列的数据表Test5:
create table test5(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增指定时间戳比较的and字符串比较形式过期信息
alter table test5 add current expire_info='c4=#2020-08-07# and c3=\'test\'';

#插入数据
insert into test5 values(1,1,'test','2020-08-07');
insert into test5 values(2,1,'test ','2020-08-08');
insert into test5 values(3,1,'tes t','2020-08-07');

###2-6 创建含有varchar属性列和datetime属性列的数据表Test6:
create table test6(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增指定时间戳比较的and字符串比较形式过期信息
alter table test6 add current expire_info='c4=#2020-08-07# and c1=1';

#插入数据
insert into test6 values(1,1,'test','2020-08-07');
insert into test6 values(2,1,'test ','2020-08-08');
insert into test6 values(3,1,'tes t','2020-08-07');

###2-7 创建含有varchar属性列和datetime属性列的数据表Test7:
create table test7(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增相对时间比较and字符串比较形式的过期信息
alter table test7 add current expire_info='$SYS_DATE>c4+1*24*60*60*1000000 and c3=\'test\'';

#插入数据
insert into test7 values(1,1,'test','2020-08-07');
insert into test7 values(2,1,'test ','2020-08-08');
insert into test7 values(3,1,'tes t','2020-08-07');

###2-8 创建含有varchar属性列和datetime属性列的数据表Test8:
create table test8(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增相对时间比较and字符串比较形式的过期信息
alter table test8 add current expire_info='$SYS_DATE>c4+1*24*60*60*1000000 and c3=#2020-08-07#';

#插入数据
insert into test8 values(1,1,'20200809','2020-08-07');
insert into test8 values(2,1,'2020-08-07','2020-08-08');
insert into test8 values(3,1,'test','2020-08-07');

###2-9 创建含有varchar属性列和datetime属性列的数据表Test9:
create table test9(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增相对时间SYS_DAY比较and字符串比较形式的过期信息
alter table test9 add current expire_info='$SYS_DAY>c4+1*24*60*60*1000000 and c3=#2020-08-07#';

#插入数据
insert into test9 values(1,1,'20200809','2020-08-07');
insert into test9 values(2,1,'2020-08-07','2020-08-08');
insert into test9 values(3,1,'test','2020-08-07');

###2-10 创建含有varchar属性列和datetime属性列的数据表Test10:
create table test10(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增字符串比较and null过滤形式的过期信息
alter table test10 add current expire_info='c3=\'test\' and c2=NULL';

#插入数据
insert into test10 values(1,1,'test','2020-08-07');
insert into test10 values(2,1,'test','2020-08-08');
insert into test10 values(3,1,'test','2020-08-07');
insert into test10(c1,c3,c4) values(4,'test','2020-08-07');
insert into test10(c1,c3,c4) values(5,'t est','2020-08-07');

###2-11 创建含有varchar属性列和datetime属性列的数据表Test11:
create table test11(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增绝对时间比较and字符串比较形式的特殊的过期信息
alter table test11 add current expire_info='$SYS_DATE>c3+1*24*60*60*1000000 or c3=\'9999/99/99\'';

#插入数据
insert into test11 values(1,1,'2020-08-07','2020-08-07');
insert into test11 values(2,1,'test','2020-08-08');
insert into test11 values(3,1,'2020-08-07','2020-08-07');
insert into test11 values(4,1,'9999/99/99','2020-08-07');

###2-12 创建含有varchar属性列和datetime属性列的数据表Test12:
create table test12(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增绝对时间比较and字符串比较形式的特殊的过期信息
alter table test12 add current expire_info='c4!=#2020-08-07# and c1>=1';

#插入数据
insert into test12 values(1,1,'test','2020-08-07');
insert into test12 values(2,1,'test ','2020-08-08');
insert into test12 values(3,1,'tes t','2020-08-07');

###2-13 创建含有varchar属性列和datetime属性列的数据表Test13:
create table test13(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增绝对时间比较and字符串比较形式的特殊的过期信息
alter table test13 add current expire_info='$SYS_DATE>c4+1*24*60*60*1000000 or 1=0';

#插入数据
insert into test13 values(1,1,'test','2020-08-07');
insert into test13 values(2,1,'test ','2020-08-08');
insert into test13 values(3,1,'tes t','2020-08-07');
insert into test13 values(4,1,'tes t','2029-08-07');

###2-14 创建含有varchar属性列和datetime属性列的数据表Test14:
create table test14(c1 int primary key, c2 int, c3 varchar(30), c4 datetime);

#新增绝对时间比较and数值取余计算的特殊的过期信息
alter table test14 add current expire_info='$SYS_DATE>c4+1*24*60*60*1000000 and c1%2=0';

#插入数据
insert into test14 values(1,1,'test','2020-08-07');
insert into test14 values(2,1,'test ','2020-08-08');
insert into test14 values(3,1,'tes t','2020-08-07');

select * from test1;
select * from test2;
select * from test3;
select * from test4;
select * from test5;
select * from test6;
--sleep 5
select * from test7;
select * from test8;
select * from test9;
select * from test10;
select * from test11;
select * from test12;
select * from test13;
select * from test14;

--echo "merge"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 600
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;
--real_sleep 60

select * from test1;
select * from test2;
select * from test3;
select * from test4;
select * from test5;
select * from test6;
--sleep 5
select * from test7;
select * from test8;
select * from test9;
select * from test10;
select * from test11;
select * from test12;
select * from test13;
select * from test14;


###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
