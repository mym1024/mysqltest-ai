--source merge.sql
##############################################################################################
###1.测试功能点：验证两种修改表名的语句在合并前后都可用，并且若表名已存在则不能修改
###                       以及在合并前后修改列名，并验证列名冲突不能修改
#
###2.问题网址：xxx
###3.问题号：xxx
###4.预计运行时间：1248.171855 s
###5.编写/修改人：chenshibo
###6.编写/修改日期：2019-11-20
###
###
##
#
##############################################################################################

#####################################Do sql####################################################
--disable_warnings
drop table if exists t1,t2,m1,m2,n1,n2;
--enable_warnings

# empty table


###2-1：修改表名
create table t1 (c1 int primary key, c2 int)partition by range(c1)(partition r0 values less than(5),partition r1 values less than (10),partition r2 values less than maxvalue);
--real_sleep 5
alter table t1 rename to t2;
--error 5019
select * from t1;
select * from t2;

create table m1 (c1 int primary key,c2 int)partition by range(c1)(partition r0 values less than(5),partition r1 values less than (10),partition r2 values less than (15),partition r3 values less than maxvalue);
desc m1;
--real_sleep 5
rename table m1 to m2;
--error 5019
desc m1;
desc m2;
drop table if exists t1,t2,m1,m2;

###2-2：冻结合并后修改表名
create table t1 (c1 int primary key, c2 int)partition by list(c1) (partition q0 values in(1,3),partition a1 values in (2,4,5));
--real_sleep 5
insert into t1 values(1,1),(2,2),(3,3);
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 800
rename table t1 to t2;
--error 5019
desc t1;
desc t2;
insert into t2 values(4,4);

rename table t2 to t1;
select * from t1;
--error 5019
select * from t2;
insert into t1 values(5,5);
select * from t1;
--error 5019
select * from t2;
drop table if exists t1,t2;

###2-3：两个表对换表名，
--error 5077
drop partition function e;
create enum partition function e(x)'[(1)],[(3)]';
create table n1(c1 int primary key,c2 int)partition by(em,e,c1);
--error 5077
drop partition function h;
create hash partition function h(x) 'x+1';
create table n2(c1 int primary key,c2 int)partition by(hs,h,c1);
--real_sleep 5
insert into n1 values(1,1);
insert into n2 values(1,1),(2,2);
rename table n1 to n1_temp;
rename table n2 to n1;
rename table n1_temp to n2;
select * from n1;
select * from n2;

drop table if exists n1,n2;

###2-4：仅修改表名
create table t1(c1 int primary key,c2 int);
create table t2(c1 int primary key,c2 int);
--error 5019
rename table t1 to t2;
--error 5019
rename table t100 to t200;

drop table if exists t1;

###2-5：修改列名，并在合并后再修列名
create table t1(c1 int primary key,c2 int);
--real_sleep 5
alter table t1 rename c2 to c3;
desc t1;
drop table if exists t1;

create table t1(c1 int primary key,c2 int)partition by range(c1)(partition r0 values less than(5),partition r1 values less than (10),partition r2 values less than maxvalue);
desc t1;
--real_sleep 5
alter table t1 rename column c2 to c3;
desc t1;
insert into t1 values(1,1),(2,2),(3,3);
select * from t1;
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 400
--error 5002
alter table t1 rename c1 to c2;
--real_sleep 5
select * from t1;
insert into t1 values(4,4);
alter table t1 rename c3 to c2;
select * from t1;

alter table t1 rename c2 to c3,add c4 int;
select * from t1;
--error 5009
alter table t1 rename c2 to c3;
#
select * from t1;
--error 5009
alter table t1 rename c200 to c300;
drop table t1;

create table t1(c1 int primary key,c2 int,c3 int)partition by range(c1)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than maxvalue);
desc t1;
--error 5002
alter table t1 drop c2,rename c1 to c3;
desc t1;
drop table t1;

