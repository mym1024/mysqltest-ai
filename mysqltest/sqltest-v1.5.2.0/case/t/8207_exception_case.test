--source merge.sql
##############################################################################################
###1.测试功能点：alter table修改分区方式异常系
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：xxx
###4.问题号：xxx
###5.预计运行时间：xxx
###6.编写/修改人：zhuyinying
###7.编写/修改日期：2020-03-20
###8.其他（选填）：case格式规范化修改
###
##
#
##############################################################################################

#####################################Do sql###################################################
--disable_warnings
drop table if exists t1,t2,t3,t4,t5;
--enable_warnings


###2-1:不分区表改分区表
create range partition function r_1(x) '(10),(20),(maxvalue)';
create range partition function r_2(x,y) '(10,30),(20,40),(maxvalue,maxvalue)';
create range partition function r_3(x) '(\'10\'),(\'20\'),(maxvalue)';
create range partition function r_4(x,y) '(\'10\',\'30\'),(\'20\',\'40\'),(maxvalue,maxvalue)';
create range partition function r_5(x,y) '(10,\'30\'),(20,\'40\'),(maxvalue,maxvalue)';
create hash partition function h_1(x) 'x';
create hash partition function h_2(x,y) 'x+y';
create enum partition function e_1(x) '[(1),(2)],[(3),(4)]';

show partition functions;
create table t1(a int primary key,b int,c int);
create table t2(a int,b int,c int,primary key(a,b));
create table t3(a varchar(10) primary key,b varchar(10),c int);
create table t4(a varchar(10) ,b varchar(10),c int,primary key(a,b));
create table t5(a varchar(10),b int,c int,primary key(a,b));

--echo "refresh"
exec $LOCAL_DIR/tools/rs_amin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 3

show partition groups;

###改为不存在的分区规则
--error 4001
alter table t1 partition rule to(t1,r_8,a);
--error 4001
alter table t2 partition rule to(t2,r_8,a);
--error 4001
alter table t3 partition rule to(t3,r_8,a);
--error 4001
alter table t4 partition rule to(t4,r_8,a);
--error 4001
alter table t5 partition rule to(t5,r_8,a);

###参数类型不一致
--error 4001
alter table t1 partition rule to(t1,r_3,a);
--error 4001
alter table t3 partition rule to(t3,r_1,a);
--error 4001
alter table t5 partition rule to(t5,r_4,a,b);
--error 4001
alter table t5 partition rule to(t5,r_2,a,b);
--error 4001
alter table t2 partition rule to(t2,r_5,a,b);
--error 4001
alter table t4 partition rule to(t4,r_5,a,b);

###参数个数不一致
--error 4001
alter table t3 partition rule to(t3,r_4,a);
--error 4001
alter table t1 partition rule to(t1,r_2,a);
--error 4001
alter table t3 partition rule to(t3,r_5,a);
--error 4001
alter table t1 partition rule to(t1,r_5,a);
--error 4001
alter table t2 partition rule to(t2,r_1,a,b);
--error 4001
alter table t4 partition rule to(t4,r_3,a,b);

###包含非主键
--error 5081
alter table t1 partition rule to(t1,r_1,b);
--error 5081
alter table t3 partition rule to(t3,r_3,b);
--error 5081
alter table t2 partition rule to(t3,r_2,a,c);
--error 5081
alter table t4 partition rule to(t3,r_4,a,c);


###改为enum分区
--error 4001
alter table t1 partition rule to(t1,e_1,a);


drop table t1,t2,t3,t4,t5;
drop partition function r_1,r_2,r_3,r_4,r_5,h_1,h_2,e_1;

###2-2:range分区表改分区表
create range partition function r_1(x) '(10),(20),(maxvalue)';
create range partition function r_2(x,y) '(10,30),(20,40),(maxvalue,maxvalue)';
create range partition function r_3(x) '(\'10\'),(\'20\'),(maxvalue)';
create range partition function r_4(x,y) '(\'10\',\'30\'),(\'20\',\'40\'),(maxvalue,maxvalue)';
create range partition function r_5(x,y) '(10,\'30\'),(20,\'40\'),(maxvalue,maxvalue)';
create hash partition function h_1(x) 'x';
create hash partition function h_2(x,y) 'x+y';
create enum partition function e_1(x) '[(1),(2)],[(3),(4)]';

show partition functions;
create table t1(a int primary key,b int,c int) partition by(t1,r_1,a);
create table t2(a int,b int,c int, primary key(a,b)) partition by(t2,r_2,a,b);
create table t3(a varchar(10) primary key,b varchar(10),c int) partition by(t3,r_3,a);
create table t4(a varchar(10) ,b varchar(10),c int,primary key(a,b))partition by(t4,r_4,a,b);
create table t5(a int,b varchar(10),c int,primary key(a,b))partition by(t5,r_5,a,b);
create table t1_1(a int primary key,b int,c int) partition by range(a)(partition p0 values less than(10),partition p1 values less than(20),partition p2 values less than (maxvalue));
create table t2_1(a int,b int,c int, primary key(a,b)) partition by range columns(a,b) (partition p0 values less than(10,20),partition p1 values less than(20,30),partition p2 values less than (maxvalue,maxvalue));
create table t3_1(a varchar(10) primary key,b varchar(10),c int) partition by range(a)(partition p0 values less than('10'),partition p1 values less than('20'),partition p2 values less than (maxvalue));
create table t4_1(a varchar(10) ,b varchar(10),c int,primary key(a,b)) partition by range columns(a,b) (partition p0 values less than('10','20'),partition p1 values less than('20','30'),partition p2 values less than (maxvalue,maxvalue));
create table t5_1(a varchar(10),b int,c int,primary key(a,b)) partition by range columns(a,b) (partition p0 values less than('10',20),partition p1 values less than('20',30),partition p2 values less than (maxvalue,maxvalue));

--echo "refresh"
exec $LOCAL_DIR/tools/rs_amin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 3

show partition groups;

###改为不存在的分区规则
--error 4001
alter table t1 partition rule to(t1,r_8,a);
--error 4001
alter table t2 partition rule to(t2,r_8,a);
--error 4001
alter table t3 partition rule to(t3,r_8,a);
--error 4001
alter table t4 partition rule to(t4,r_8,a);
--error 4001
alter table t5 partition rule to(t5,r_8,a);
--error 4001
alter table t1_1 partition rule to(t1,r_8,a);
--error 4001
alter table t2_1 partition rule to(t2,r_8,a);
--error 4001
alter table t3_1 partition rule to(t3,r_8,a);
--error 4001
alter table t4_1 partition rule to(t4,r_8,a);
--error 4001
alter table t5_1 partition rule to(t5,r_8,a);

###参数类型不一致
--error 4001
alter table t1 partition rule to(t1,r_3,a);
--error 4001
alter table t3 partition rule to(t3,r_1,a);
--error 4001
alter table t5 partition rule to(t5,r_4,a,b);
--error 4001
alter table t5 partition rule to(t5,r_2,a,b);
--error 4001
alter table t2 partition rule to(t2,r_5,a,b);
--error 4001
alter table t4 partition rule to(t4,r_5,a,b);
--error 4001
alter table t1_1 partition rule to(t1,r_3,a);
--error 4001
alter table t3_1 partition rule to(t3,r_1,a);
--error 4001
alter table t5_1 partition rule to(t5,r_4,a,b);
--error 4001
alter table t5_1 partition rule to(t5,r_2,a,b);
--error 4001
alter table t2_1 partition rule to(t2,r_5,a,b);
--error 4001
alter table t4_1 partition rule to(t4,r_5,a,b);

###参数个数不一致
--error 4001
alter table t3 partition rule to(t3,r_4,a);
--error 4001
alter table t1 partition rule to(t1,r_2,a);
--error 4001
alter table t2 partition rule to(t2,r_1,a,b);
--error 4001
alter table t4 partition rule to(t4,r_3,a,b);
--error 4001
alter table t3 partition rule to(t3,r_5,a);
--error 4001
alter table t1 partition rule to(t1,r_5,a);
--error 4001
alter table t3_1 partition rule to(t3,r_4,a);
--error 4001
alter table t1_1 partition rule to(t1,r_2,a);
--error 4001
alter table t2_1 partition rule to(t2,r_1,a,b);
--error 4001
alter table t4_1 partition rule to(t4,r_3,a,b);
--error 4001
alter table t3_1 partition rule to(t3,r_5,a);
--error 4001
alter table t1_1 partition rule to(t1,r_5,a);

###包含非主键
--error 5081
alter table t1 partition rule to(t1,r_1,b);
--error 5081
alter table t3 partition rule to(t3,r_3,b);
--error 5081
alter table t2 partition rule to(t3,r_2,a,c);
--error 5081
alter table t4 partition rule to(t3,r_4,a,c);
--error 5081
alter table t1_1 partition rule to(t1,r_1,b);
--error 5081
alter table t3_1 partition rule to(t3,r_3,b);
--error 5081
alter table t2_1 partition rule to(t3,r_2,a,c);
--error 5081
alter table t4_1 partition rule to(t3,r_4,a,c);

###改为enum分区
--error 4001
alter table t1 partition rule to(t1,e_1,a);
--error 4001
alter table t1_1 partition rule to(t1,e_1,a);

drop table t1,t2,t3,t4,t5,t1_1,t2_1,t3_1,t4_1,t5_1;
drop partition function r_1,r_2,r_3,r_4,r_5,h_1,h_2,e_1;

###2-3:list分区表改分区表
create range partition function r_1(x) '(10),(20),(maxvalue)';
create range partition function r_2(x,y) '(10,30),(20,40),(maxvalue,maxvalue)';
create range partition function r_3(x) '(\'10\'),(\'20\'),(maxvalue)';
create range partition function r_4(x,y) '(\'10\',\'30\'),(\'20\',\'40\'),(maxvalue,maxvalue)';
create range partition function r_5(x,y) '(10,\'30\'),(20,\'40\'),(maxvalue,maxvalue)';
create hash partition function h_1(x) 'x';
create hash partition function h_2(x,y) 'x+y';
create enum partition function e_1(x) '[(1),(2)],[(3),(4)]';

show partition functions;
create table t1(a int primary key,b int,c int) partition by list(a)(partition p0 values in(1,2,3),partition p1 values in(4,5,6));
create table t2(a int,b int,c int, primary key(a,b)) partition by list columns(a,b)(partition p0 values in((1,2),(2,4),(3,6)),partition p1 values in((4,8),(5,10),(6,12)));
create table t3(a varchar(10) primary key,b varchar(10),c int) partition by list(a)(partition p0 values in('1','2','3'),partition p1 values in('4','5','6'));
create table t4(a varchar(10) ,b varchar(10),c int,primary key(a,b))partition by list columns(a,b)(partition p0 values in(('1','2'),('2','4'),('3','6')),partition p1 values in(('4','8'),('5','10'),('6','12')));
create table t5(a varchar(10),b int,c int,primary key(a,b))partition by list columns(a,b)(partition p0 values in(('1',2),('2',4),('3',6)),partition p1 values in(('4',8),('5',10),('6',12)));

--echo "refresh"
exec $LOCAL_DIR/tools/rs_amin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 3

show partition groups;

###改为不存在的分区规则
--error 4001
alter table t1 partition rule to(t1,r_8,a);
--error 4001
alter table t2 partition rule to(t2,r_8,a);
--error 4001
alter table t3 partition rule to(t3,r_8,a);
--error 4001
alter table t4 partition rule to(t4,r_8,a);
--error 4001
alter table t5 partition rule to(t5,r_8,a);

###参数类型不一致
--error 4001
alter table t1 partition rule to(t1,r_3,a);
--error 4001
alter table t3 partition rule to(t3,r_1,a);
--error 4001
alter table t5 partition rule to(t5,r_4,a,b);
--error 4001
alter table t5 partition rule to(t5,r_2,a,b);
--error 4001
alter table t2 partition rule to(t2,r_5,a,b);
--error 4001
alter table t4 partition rule to(t4,r_5,a,b);

###参数个数不一致
--error 4001
alter table t3 partition rule to(t3,r_4,a);
--error 4001
alter table t1 partition rule to(t1,r_2,a);
--error 4001
alter table t3 partition rule to(t3,r_5,a);
--error 4001
alter table t1 partition rule to(t1,r_5,a);
--error 4001
alter table t2 partition rule to(t2,r_1,a,b);
--error 4001
alter table t4 partition rule to(t4,r_3,a,b);

###包含非主键
--error 5081
alter table t1 partition rule to(t1,r_1,b);
--error 5081
alter table t3 partition rule to(t3,r_3,b);
--error 5081
alter table t2 partition rule to(t3,r_2,a,c);
--error 5081
alter table t4 partition rule to(t3,r_4,a,c);


###改为enum分区
--error 4001
alter table t1 partition rule to(t1,e_1,a);


drop table t1,t2,t3,t4,t5;
drop partition function r_1,r_2,r_3,r_4,r_5,h_1,h_2,e_1;

###2-5:enum分区表改分区表
create range partition function r_1(x) '(10),(20),(maxvalue)';
create range partition function r_2(x,y) '(10,30),(20,40),(maxvalue,maxvalue)';
create range partition function r_3(x) '(\'10\'),(\'20\'),(maxvalue)';
create range partition function r_4(x,y) '(\'10\',\'30\'),(\'20\',\'40\'),(maxvalue,maxvalue)';
create range partition function r_5(x,y) '(10,\'30\'),(20,\'40\'),(maxvalue,maxvalue)';
create hash partition function h_1(x) 'x';
create hash partition function h_2(x,y) 'x+y';
create enum partition function e_1(x) '[(1),(2)],[(3),(4)]';

show partition functions;
create table t1(a int primary key,b int,c int) partition by(t1,h_1,a);
create table t2(a int,b int,c int,primary key(a,b)) partition by(t2,h_2,a,b);
create table t3(a varchar(10) primary key,b varchar(10),c int) partition by(t3,h_1,a);
create table t4(a varchar(10) ,b varchar(10),c int,primary key(a,b)) partition by(t4,h_2,a,b);
create table t5(a varchar(10),b int,c int,primary key(a,b)) partition by(t5,h_2,a,b);

--echo "refresh"
exec $LOCAL_DIR/tools/rs_amin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 3

show partition groups;

###改为不存在的分区规则
--error 4001
alter table t1 partition rule to(t1,r_8,a);
--error 4001
alter table t2 partition rule to(t2,r_8,a);
--error 4001
alter table t3 partition rule to(t3,r_8,a);
--error 4001
alter table t4 partition rule to(t4,r_8,a);
--error 4001
alter table t5 partition rule to(t5,r_8,a);

###参数类型不一致
--error 4001
alter table t1 partition rule to(t1,r_3,a);
--error 4001
alter table t3 partition rule to(t3,r_1,a);
--error 4001
alter table t5 partition rule to(t5,r_4,a,b);
--error 4001
alter table t5 partition rule to(t5,r_2,a,b);
--error 4001
alter table t2 partition rule to(t2,r_5,a,b);
--error 4001
alter table t4 partition rule to(t4,r_5,a,b);

###参数个数不一致
--error 4001
alter table t3 partition rule to(t3,r_4,a);
--error 4001
alter table t1 partition rule to(t1,r_2,a);
--error 4001
alter table t3 partition rule to(t3,r_5,a);
--error 4001
alter table t1 partition rule to(t1,r_5,a);
--error 4001
alter table t2 partition rule to(t2,r_1,a,b);
--error 4001
alter table t4 partition rule to(t4,r_3,a,b);

###包含非主键
--error 5081
alter table t1 partition rule to(t1,r_1,b);
--error 5081
alter table t3 partition rule to(t3,r_3,b);
--error 5081
alter table t2 partition rule to(t3,r_2,a,c);
--error 5081
alter table t4 partition rule to(t3,r_4,a,c);


###改为enum分区
--error 4001
alter table t1 partition rule to(t1,e_1,a);


drop table t1,t2,t3,t4,t5;
drop partition function r_1,r_2,r_3,r_4,r_5,h_1,h_2,e_1;
###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
