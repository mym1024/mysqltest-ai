####################################必填######################################################
###1.测试功能点：枚举类型 Test DML - DELETE with ENUM and SET types
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：xxx
###4.问题号：xxx
###5.预计运行时间:
###6.编写/修改人：yangf
###7.编写/修改日期：2025-08-26
###8.其他（选填）：新编case
###
##
#
##############################################################################################	
#####################################Do sql###################################################
--disable_query_log
set sql_quote_show_create=0;
--enable_query_log

# Setup: Create tables for DELETE testing
# Using a structure similar to previous tests to leverage ENUM/SET columns in WHERE clauses
CREATE TABLE t_delete_parent (
    parent_id INT PRIMARY KEY,
    parent_group ENUM('group1', 'group2', 'group3')
);

CREATE TABLE t_delete_enum_set (
    id INT AUTO_INCREMENT,
    category ENUM('cat_x', 'cat_y', 'cat_z') NOT NULL,
    status_flags SET('active', 'verified', 'premium', 'deleted') NOT NULL,
    priority ENUM('low', 'normal', 'high') DEFAULT 'normal',
    data VARCHAR(100),
    group_id INT,
    PRIMARY KEY (id),
    KEY idx_category (category),
    KEY idx_status_flags (status_flags),
    KEY idx_priority (priority),
    KEY idx_group_id (group_id),
    KEY idx_cat_status (category, status_flags),
    CONSTRAINT fk_delete_group FOREIGN KEY (group_id) REFERENCES t_delete_parent(parent_id)
);

CREATE TABLE t_delete_audit (
    audit_id INT AUTO_INCREMENT PRIMARY KEY,
    deleted_record_id INT,
    deleted_category ENUM('cat_x', 'cat_y', 'cat_z'),
    KEY idx_deleted_id (deleted_record_id)
);

INSERT INTO t_delete_parent VALUES (1, 'group1'), (2, 'group2'), (3, 'group3');
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);

# 1. Basic DELETE Operations

# 1.1. Single Row Delete - Based on Primary Key (simple condition, but valid test)
DELETE FROM t_delete_enum_set WHERE id = 1;
SELECT 'After deleting id=1:' AS msg;
SELECT * FROM t_delete_enum_set WHERE id = 1;
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;

# 1.2. Batch Delete - Delete multiple rows based on ENUM value
TRUNCATE TABLE t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
DELETE FROM t_delete_enum_set WHERE category = 'cat_y';
SELECT 'After deleting category=''cat_y'':' AS msg;
SELECT * FROM t_delete_enum_set WHERE category = 'cat_y';
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;

# 1.3. Batch Delete - Delete multiple rows based on SET membership
TRUNCATE TABLE t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
DELETE FROM t_delete_enum_set WHERE FIND_IN_SET('deleted', status_flags) > 0;
SELECT 'After deleting rows with ''deleted'' flag:' AS msg;
SELECT * FROM t_delete_enum_set WHERE FIND_IN_SET('deleted', status_flags) > 0;
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;


# 2. DELETE with Complex WHERE Clauses (Involving ENUM/SET)
TRUNCATE TABLE t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_y', 'active', 'normal', 'Re-added Record A', 2),
('cat_y', 'premium,deleted', 'low', 'Re-added Record B', 2);
SELECT 'State after re-inserting cat_y records:' AS msg;
SELECT * FROM t_delete_enum_set ORDER BY id;

# 2.1. Delete based on multiple ENUM conditions
TRUNCATE TABLE t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
DELETE FROM t_delete_enum_set WHERE priority = 'high' AND category = 'cat_z';
SELECT 'After deleting high priority cat_z:' AS msg;
SELECT * FROM t_delete_enum_set WHERE priority = 'high' AND category = 'cat_z';
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;

# 2.2. Delete based on ENUM range or list
TRUNCATE TABLE t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
DELETE FROM t_delete_enum_set WHERE priority IN ('low', 'normal');
SELECT 'After deleting low/normal priority:' AS msg;
SELECT * FROM t_delete_enum_set WHERE priority IN ('low', 'normal');
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;

# 2.3. Delete based on complex ENUM/SET combination
TRUNCATE TABLE t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
DELETE FROM t_delete_enum_set
WHERE category = 'cat_x'
  AND (
    (FIND_IN_SET('premium', status_flags) > 0 AND FIND_IN_SET('verified', status_flags) = 0) OR
    (FIND_IN_SET('premium', status_flags) = 0 AND FIND_IN_SET('verified', status_flags) > 0)
  );
SELECT 'After deleting specific cat_x with premium XOR verified:' AS msg;
SELECT * FROM t_delete_enum_set WHERE category = 'cat_x';
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;

# 3. DELETE with JOIN (Deleting based on related table data involving ENUM/SET)
DELETE FROM t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1),
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2);

INSERT INTO t_delete_audit (deleted_record_id, deleted_category) VALUES (3, 'cat_x'), (5, 'cat_y');

SELECT 'State before JOIN DELETE:' AS msg;
SELECT * FROM t_delete_enum_set ORDER BY id;
SELECT * FROM t_delete_audit ORDER BY audit_id;

# 3.1. Delete from main table based on existence in audit table (ENUM join)
TRUNCATE TABLE t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
TRUNCATE TABLE t_delete_audit;
INSERT INTO t_delete_audit (deleted_record_id, deleted_category) VALUES (3, 'cat_x'), (5, 'cat_y');
#mysql、ob执行成功，表现不一致
--error 5001
DELETE dm FROM t_delete_enum_set dm JOIN t_delete_audit da ON dm.id = da.deleted_record_id WHERE da.deleted_category = 'cat_x';
SELECT 'After JOIN DELETE of audited cat_x records:' AS msg;
SELECT * FROM t_delete_enum_set WHERE id = 3;
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;

# 3.2. Delete from main table based on related parent table ENUM
TRUNCATE TABLE t_delete_enum_set;
delete from t_delete_parent;
INSERT INTO t_delete_parent VALUES (1, 'group1'), (2, 'group2'), (3, 'group3');
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
--error 5001
DELETE dm FROM t_delete_enum_set dm JOIN t_delete_parent dp ON dm.group_id = dp.parent_id WHERE dp.parent_group = 'group2';
SELECT 'After JOIN DELETE related to parent group2:' AS msg;
SELECT * FROM t_delete_enum_set WHERE group_id = 2;
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;

# 4. DELETE with Subquery (Involving ENUM/SET)
#
DELETE FROM t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1),
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2);

SELECT 'State before Subquery DELETE:' AS msg;
SELECT * FROM t_delete_enum_set ORDER BY id;

# 4.1. Delete based on ENUM value found in a subquery
TRUNCATE TABLE t_delete_enum_set;
delete from t_delete_parent;
INSERT INTO t_delete_parent VALUES (1, 'group1'), (2, 'group2'), (3, 'group3');
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);

DELETE FROM t_delete_enum_set WHERE category = (SELECT parent_group FROM t_delete_parent WHERE parent_id = 3);
SELECT 'After DELETE where category = (subquery result ''cat_z''):' AS msg;
SELECT * FROM t_delete_enum_set WHERE category = 'cat_z';
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;

# 4.2. Delete based on IDs found in a subquery involving SET
TRUNCATE TABLE t_delete_enum_set;
delete from t_delete_parent;
INSERT INTO t_delete_parent VALUES (1, 'group1'), (2, 'group2'), (3, 'group3');
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
DELETE FROM t_delete_enum_set
WHERE id IN (
    SELECT temp_id FROM (
        SELECT id AS temp_id FROM t_delete_enum_set WHERE FIND_IN_SET('premium', status_flags) > 0
    ) AS subq
);
SELECT 'After DELETE where id IN (subquery of premium records):' AS msg;
SELECT * FROM t_delete_enum_set WHERE FIND_IN_SET('premium', status_flags) > 0;
SELECT COUNT(*) AS remaining_count FROM t_delete_enum_set;

# 5. Edge Cases and Error Handling (Conceptual for DELETE)
DELETE FROM t_delete_enum_set;
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active', 'high', 'Record FK Test', 1);
DELETE FROM t_delete_audit;
INSERT INTO t_delete_audit (deleted_record_id, deleted_category) VALUES (LAST_INSERT_ID(), 'cat_x');
SELECT 'State before FK DELETE test:' AS msg;
SELECT * FROM t_delete_enum_set WHERE id = (SELECT MAX(deleted_record_id) FROM t_delete_audit);
SELECT * FROM t_delete_audit WHERE deleted_record_id = (SELECT MAX(deleted_record_id) FROM t_delete_audit);

# 5.1. Attempt DELETE that would violate FK constraint if parent is deleted first
TRUNCATE TABLE t_delete_enum_set;
delete from t_delete_parent;
INSERT INTO t_delete_parent VALUES (1, 'group1'), (2, 'group2'), (3, 'group3');
INSERT INTO t_delete_enum_set (category, status_flags, priority, data, group_id) VALUES
('cat_x', 'active,verified', 'high', 'Record 1', 1),
('cat_y', 'premium', 'normal', 'Record 2', 2),
('cat_x', 'active,deleted', 'low', 'Record 3', 1),
('cat_z', 'verified,premium', 'high', 'Record 4', 3),
('cat_y', 'active', 'normal', 'Record 5', 2),
('cat_x', '', 'low', 'Record 6', 1), 
('cat_z', 'active,verified,premium', 'high', 'Record 7', 3),
('cat_y', 'deleted', 'low', 'Record 8', 2),
('cat_x', 'premium,verified', 'normal', 'Record 9', 1),
('cat_z', 'active', 'high', 'Record 10', 3);
INSERT INTO t_delete_audit (deleted_record_id, deleted_category) VALUES (3, 'cat_x'), (5, 'cat_y');
#mysql、ob执行报错，表现不一致
ALTER TABLE t_delete_parent ADD CONSTRAINT chk_no_delete CHECK (parent_id > 10);
--error 5209
DELETE FROM t_delete_parent WHERE parent_id = 1;
ALTER TABLE t_delete_parent DROP CONSTRAINT chk_no_delete;

SELECT 'Final state of t_delete_enum_set:' AS msg;
SELECT * FROM t_delete_enum_set ORDER BY id;
SELECT 'Final count in t_delete_enum_set:' AS msg;
SELECT COUNT(*) AS final_count FROM t_delete_enum_set;
SELECT 'Final state of t_delete_audit:' AS msg;
SELECT * FROM t_delete_audit ORDER BY audit_id;

# Cleanup
DROP TABLE t_delete_audit;
DROP TABLE t_delete_enum_set;
DROP TABLE t_delete_parent;
############################################ end sql ###################################################
