####################################必填######################################################
###1.测试功能点：测试用户自定义函数_创建自定义函数、调用
#                 
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：
###4.问题号：
###5.预计运行时间：
###6.编写/修改人：zhangt
###7.编写/修改日期：2024-02-05
###8.其他（选填）：v1.3.0.0新增
###
##
#
##############################################################################################

#####################################Do sql###################################################
create table student(id int,name varchar(20),score int);
insert into student values(1,'a',60);
insert into student values(2,'b',90);
insert into student values(3,'c',91);
insert into student values(4,'d',60);
insert into student values(5,'e',15);
create table t1(a int);
insert into t1 values(1),(2),(3);
delimiter //;

###2-1：函数名测试
#--单行注释
create function udf_name() returns bit(3)
begin 
	declare a bit(3) default b'001';
	-- 单行注释
	set a =  b'111';
	return a;
end//
select udf_name()//

/*多行注释
多行注释*/
create function udf_name1() returns createtime
begin 
	declare a createtime ;
	/*多行注释
	 多行注释*/
	return a;
end//
select udf_name1()//

#与系统函数同名
create function min(a int)RETURNS int
begin
	return 0;
end//
select min(a) from t1//
--error 5055
select yao.min(a) from t1//
select test.min(a) from t1//

#ISSUE210:自定义函数名长度为空导致的coredump
--error 5001
create function (a int) returns int
begin
	return 0;
end//

#大小写
--error 5025
create function UDF_name() returns bit(3)
begin end//

#同名不同参
--error 5025
create function udf_name(c1 int) returns bit(3)
begin 
	declare a bit(3) default b'001';
	return a;
end//

###2-2：函数参数测试
#参数不同个数、不同类型
create function udf_para1(n int) returns int
begin 
	declare a int default 1;
	return 1;
end//
select udf_para1(1)//

create function udf_para2(c1 json) returns json begin return c1;end//
select udf_para2('{}')//
select udf_para2('{"abc":1,"def":null}')//

create function udf_para3(c1 bit)returns bit begin return c1;end//
select udf_para3(b'0')//

create function udf_para4(c1 json,c2 bit(1),c3 timestamp) returns bool
begin 
	return true; 
end//
select udf_para4('{"abc":1,"def":null,"hig":"aaa","bool":false}',b'0','2024-03-20')//

create function udf_para5(c1 varchar(25),c2 bool,c3 double,c4 float) returns varchar(25)
begin 
	declare aa varchar(25);
	set aa = c1;
	return aa; 
end//
select udf_para5('aaa',true,1.23456789,1.23)//

###2-3：函数返回值测试
create function udf_return1() returns json
begin 
	declare a json;
	set a = '[1,null,true,false,"abc",1.1]';
	return a;
end//
select udf_return1()//

CREATE FUNCTION udf_return2(num1 INT,num2 INT)RETURNS DECIMAL(10, 2)
begin
	DECLARE avg DECIMAL(10, 2);
	SET avg = (num1 + num2) / 2;
	RETURN avg;
END//
SELECT udf_return2(10, 20)//

#无返回值
create function udf_return3() returns int
begin end//
--error 16
select udf_return3()//

--error 5001
create function udf_return4() returns int specific 'p_p'
begin return 1; end//

--error 5001
create function udf_return5() returns int DYNAMIC RESULT SETS 0
begin return 1; end//

###2-4：函数8大特性测试
#COMMENT特性
create function udf_comment(num int) returns int comment 'calculate the sum of 0-num'
begin 
	declare i,sum int default 0;
	while i<=num do
		set sum = sum+1;
		set i = i+1;
	end while;
	return sum;
end//
select test.udf_comment(10)//
select test.udf_comment(5)//

#LANGUAGE SQL特性
create function udf_language() returns int language sql
begin return 1; end//
select udf_language()//

CREATE FUNCTION udf_language_sql(input_number INT)RETURNS INT  LANGUAGE SQL
BEGIN 
	DECLARE a INT;
    IF input_number > 0 THEN
        SET a = 1;
    ELSE
        SET a = 0;
    END IF;
    RETURN a;
END //
SELECT udf_language_sql(5) AS a//

#DETERMINISTIC特性
create function udf_deterministic() returns int  NOT DETERMINISTIC
begin return 1; end//
select udf_deterministic()//

CREATE FUNCTION udf_deterministic_sql(input_string VARCHAR(255)) RETURNS VARCHAR(255) DETERMINISTIC
BEGIN 
	DECLARE a VARCHAR(255);
    SET a = UPPER(input_string);
    RETURN a;
END //
select udf_deterministic_sql('aa')//

#CONTAINS SQL特性
create function udf_contains() returns int  CONTAINS SQL
begin return 1; end//
select udf_contains()//

#READS SQL DATA特性
create function udf_reads() returns int  READS SQL DATA
begin return 1; end//
select udf_reads()//
CREATE TABLE test_table (id int PRIMARY KEY, column_name int)//
INSERT INTO test_table (id, column_name) VALUES (1, 10)//
CREATE FUNCTION test_reads_sql_data(input_id INT) RETURNS INT READS SQL DATA
BEGIN DECLARE a INT;
    SELECT column_name FROM test_table WHERE id = input_id;
	INSERT INTO test_table (id, column_name) VALUES (2, 20);
    RETURN a;
END //
select test_reads_sql_data(1)//

#MODIFIES SQL DATA特性
create function test_modifies_sql_data() returns int  MODIFIES SQL DATA
begin return 1; end//
select test_modifies_sql_data()//

create function test_modifies_sql_data1(input_val int) returns int MODIFIES SQL DATA
begin 
	declare a int;
    UPDATE test_table SET column_name = input_val WHERE id = 1;
	INSERT INTO test_table (id, column_name) VALUES (3, 30);
	return a;
end//
SELECT test_modifies_sql_data1(20)//
SELECT * FROM test_table//

create function test_modifies_sql_data2() returns int  MODIFIES SQL DATA
begin 
	declare a int default 1;
	return a; 
end//
SELECT test_modifies_sql_data2()//

#SQL SECURITY - DEFINER、INVOKER特性
CREATE FUNCTION test_definer() RETURNS INT SQL SECURITY DEFINER
BEGIN
    declare a INT;
    SET a = 84;
    RETURN a;
END //
SELECT test_definer() AS definer_result//

CREATE FUNCTION test_invoker() RETURNS INT SQL SECURITY INVOKER
BEGIN
    DECLARE a INT;
    SET a = 99;
    RETURN a;
END //
SELECT test_invoker() AS invoker_result//

#NO SQL特性
create function udf_nosql() returns varchar no sql
begin return 1; end//
select udf_nosql()//

###2-5：函数调用测试
#调用系统函数
create function func1() returns varchar(50) 
begin 
	return now(); 
end//
--replace_column 1 '2024-03-28 18:09:25.766737'
select func1()//

create function func2() returns varchar(50) 
begin 
	return if(1<2 ,4 ,5); 
end//
select func2()//

CREATE FUNCTION CalculateCircleArea(radius FLOAT)
RETURNS FLOAT
BEGIN
    DECLARE area FLOAT;    
    SET area = PI() * radius * radius;
    SET area = ROUND(area, 2); -- 在这里调用 ROUND 函数对结果保留两位小数    
    RETURN area;
END //
SELECT CalculateCircleArea(3)//

CREATE FUNCTION ConvertTemperature(celsius FLOAT)
RETURNS VARCHAR(50)
BEGIN
    DECLARE fahrenheit FLOAT;    
    SET fahrenheit = celsius * 9 / 5 + 32;
    SET fahrenheit = CAST(fahrenheit AS CHAR); -- 在这里调用 CAST 函数将浮点数结果转换为字符串    
    RETURN CONCAT('The temperature in Fahrenheit is: ', fahrenheit);
END //
SELECT ConvertTemperature(0)//

CREATE FUNCTION CheckNullValue(inputValue VARCHAR(50))
RETURNS VARCHAR(50)
BEGIN
    DECLARE resultValue VARCHAR(50);    
    SET resultValue = NVL(inputValue, 'NULL');-- 在这里调用 NVL 函数将 NULL 值替换为指定值    
    RETURN resultValue;
END //
SELECT CheckNullValue('Hello')//

CREATE TABLE orders (order_id INT PRIMARY KEY,order_date DATE,customer_id INT,total_amount DECIMAL(10, 2))//
INSERT INTO orders VALUES (1, '2024-03-26', 101, 50.00),(2, '2024-03-27', 102, 75.50),(3, '2024-03-28', 103, 100.25)//
CREATE FUNCTION calculate_total_sales(customer_id INT)RETURNS DECIMAL(10, 2)
BEGIN
    DECLARE total_sales DECIMAL(10, 2);
    SELECT ROW_NUMBER() OVER (ORDER BY order_id desc) INTO total_sales  FROM orders  ORDER BY order_id LIMIT 1;
    RETURN total_sales;
END//
SELECT calculate_total_sales(102)//

CREATE FUNCTION generate_json_array(n INT)RETURNS JSON
BEGIN
    DECLARE i INT DEFAULT 1;
    DECLARE result_json JSON DEFAULT JSON_ARRAY();
    WHILE i <= n DO
        SET result_json = JSON_ARRAY_APPEND(result_json, '$', i);
        SET i = i + 1;
    END WHILE;
    RETURN result_json;
END//
SELECT generate_json_array(5)//

#调用自定义函数
create function getNext(n int) returns int
begin
	declare a int default 0;
	set a=n-1;
	return a;
end //
select getNext(6)//

create function getNum() returns int
begin
	declare a int default 0;
	return a;
end //
select getNum()//

create function GradeLevel(score int)
returns varchar(5)
begin
	declare level varchar(20);
	case
		when score >=90 and score <=100 then set level = 'a';
		when score >=80 then set level = 'b';
		when score >=60 then set level = 'c';
		else set level = 'd';
	end case;
	return level;
end//
select GradeLevel(87)//

select concat(getNext(61), getNext(92))//
select getNext(2) <= getNext(3) AS c1,getNext(getNum()) AS c2//
select * from student where score = getNext(61)//
select * from student where (name like GradeLevel(60)) && (id in (select getNext(id) from student))//
select * from student t1,student t2 where (t1.name like GradeLevel(60)) AND (t2.id in (select getNext(id) from student))//
select id,name,score from student where GradeLevel(score) like 'A'//
select * from student t1 inner join student t2 on getNext(t1.id) = getNext(t2.id)//
select * from student t1,student t2 where t1.id between getNext(2) and getNext(4)//
create function udf_qt1() returns int
begin
	declare a int default 0;
	set a = getNum() +5;
	return getNext(a);
end//
select udf_qt1()//

create function udf_qt2() returns varchar(20)
begin
	declare a varchar(20) default '0';
	set a = GradeLevel(udf_qt1()+60);
	return a;
end//
select udf_qt2()//

create function udf_qt3() returns int
begin
	insert into student values(getNext(111),'111',66);
	return 1;
end//
select udf_qt3()//
select * from student//

create function udf_qt4() returns int
begin
	update student set score = getNext(21) where (name like GradeLevel(60)) OR (id in (select getNext(id) from student where id = 2));
	return 1;
end//
select udf_qt4()//
select * from student//

#调用函数进行修改插入操作
--real_sleep 3
alter table student add grade_level varchar(5)//
update student set grade_level = GradeLevel(score)//
select * from student//
update student set score = getNext(96) where id = getNext(3)// 
select * from student//
update student set score = getNext(99) where id in (select getNext(id) from student)//
select * from student//
update student set score = getNext(99) where NOT(name like GradeLevel(60))//
select * from student//
insert into student values(6,'f',70,GradeLevel(70))//
select * from student//
delete from student where id < getNext(4)//
select * from student//

#创建自定义函数不支持指定库
CREATE FUNCTION test.getNum2() RETURNS INT 
begin  declare a int default 0;   
	return a; 
END//
--error 5055
select yao.getNum2()//
select test.getNum2()//
select getNum2()//

###2-6：删除、修改、查看自定义函数（修改暂不支持）
delimiter ;//
--replace_column 4 固定 5 固定替换
show function status;
--replace_column 5 固定 6 固定替换
show function status like '%test%';
SHOW FUNCTION STATUS WHERE Db = 'yao' AND Name LIKE 'udf_name';
show create function udf_qt4;
drop function udf_qt4;
--error 5740
drop function test.udf_qt4;
DROP FUNCTION IF EXISTS test.`getNum2()`;

###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
