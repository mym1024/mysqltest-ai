##############################################################################################
###1.测试功能点：测试jdbc连接数据库，通过设置autocommit来控制事务的执行
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：xxx
###4.问题号：xxx
###5.预计运行时间：xxx
###6.编写/修改人：zhuyinying
###7.编写/修改日期：2020-01-02
###8.其他（选填）：case格式规范化修改
###
##
#
##############################################################################################

#####################################Do sql###################################################

--echo case 1:two trx commit


###2-1：jdbc连接数据库，测试prepare相关
connect (conn1,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connect (conn2,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn1;
drop table if exists t1;
create table t1(c0 int primary key ,c1 int) partition by range(c0) (partition r0 values less than(5),partition r1 values less than (10),partition r2 values less than (15),partition r3 values less than maxvalue);
--real_sleep 5
insert into t1 values(0,0),(-1,-1);
prepare stmt_i from insert into t1 values(?,?),(?,?);
prepare stmt_u from update t1 set c1=? where c0=?;
prepare stmt_d from delete from t1 where c0=?;
prepare stmt_s from select c0,c1 from t1 where c0=? for update;
prepare stmt_select from select c0,c1 from t1;

set autocommit=0;
set @a1=1;
set @b1=1;
set @a2=2;
set @b2=2;

execute stmt_i using @a1,@b1,@a2,@b2;
execute stmt_u using @b2,@a1;
execute stmt_d using @a2;
execute stmt_s using @a1;
execute stmt_s using @a2;

connection conn2;
prepare p_stmt_i from insert into t1 values(?,?),(?,?);
prepare p_stmt_u from update t1 set c1=? where c0=?;
prepare p_stmt_d from delete from t1 where c0=?;
prepare p_stmt_s from select c0,c1 from t1 where c0=? for update;
prepare p_stmt_select from select c0,c1 from t1;

set autocommit=0;
set @p_a1=3;
set @p_b1=3;
set @p_a2=4;
set @p_b2=4;

execute p_stmt_i using @p_a1,@p_b1,@p_a2,@p_b2;
execute p_stmt_u using @p_b2,@p_a1;
execute p_stmt_d using @p_a2;
execute p_stmt_s using @p_a1;
execute p_stmt_s using @p_a2;

connection conn1;
commit;
set autocommit=1;
execute stmt_select;

connection conn2;
commit;
set autocommit=1;
execute p_stmt_select;

disconnect conn1;
disconnect conn2;

--echo case 2:1 commit 2 rollback
connect (conn1,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connect (conn2,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn1;
drop table if exists t2;
create table t2(c0 int primary key ,c1 int);
--real_sleep 5
insert into t2 values(0,0),(-1,-1);
prepare stmt_i from insert into t2 values(?,?),(?,?);
prepare stmt_u from update t2 set c1=? where c0=?;
prepare stmt_d from delete from t2 where c0=?;
prepare stmt_s from select c0,c1 from t2 where c0=? for update;
prepare stmt_select from select c0,c1 from t2;
set autocommit=0;
set @a1=1;
set @b1=1;
set @a2=2;
set @b2=2;

execute stmt_i using @a1,@b1,@a2,@b2;
execute stmt_u using @b2,@a1;
execute stmt_d using @a2;
execute stmt_s using @a1;
execute stmt_s using @a2;

connection conn2;
prepare p_stmt_i from insert into t2 values(?,?),(?,?);
prepare p_stmt_u from update t2 set c1=? where c0=?;
prepare p_stmt_d from delete from t2 where c0=?;
prepare p_stmt_s from select c0,c1 from t2 where c0=? for update;
prepare p_stmt_select from select c0,c1 from t2;

set autocommit=0;
set @p_a1=3;
set @p_b1=3;
set @p_a2=4;
set @p_b2=4;

execute p_stmt_i using @p_a1,@p_b1,@p_a2,@p_b2;
execute p_stmt_u using @p_b2,@p_a1;
execute p_stmt_d using @p_a2;
execute p_stmt_s using @p_a1;
execute p_stmt_s using @p_a2;

connection conn1;
rollback;
set autocommit=1;
execute stmt_select;

connection conn2;
commit;
set autocommit=1;
execute p_stmt_select;

disconnect conn1;
disconnect conn2;


--echo case 2:1 rollback 2 rollback
connect (conn1,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connect (conn2,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);
connection conn1;
drop table if exists t3;
create table t3(c0 int primary key ,c1 int);
--real_sleep 5
insert into t3 values(0,0),(-1,-1);
prepare stmt_i from insert into t3 values(?,?),(?,?);
prepare stmt_u from update t3 set c1=? where c0=?;
prepare stmt_d from delete from t3 where c0=?;
prepare stmt_s from select c0,c1 from t3 where c0=? for update;
prepare stmt_select from select c0,c1 from t3;
set autocommit=0;
set @a1=1;
set @b1=1;
set @a2=2;
set @b2=2;

execute stmt_i using @a1,@b1,@a2,@b2;
execute stmt_u using @b2,@a1;
execute stmt_d using @a2;
execute stmt_s using @a1;
execute stmt_s using @a2;

connection conn2;
prepare p_stmt_i from insert into t3 values(?,?),(?,?);
prepare p_stmt_u from update t3 set c1=? where c0=?;
prepare p_stmt_d from delete from t3 where c0=?;
prepare p_stmt_s from select c0,c1 from t3 where c0=? for update;
prepare p_stmt_select from select c0,c1 from t3;

set autocommit=0;
set @p_a1=3;
set @p_b1=3;
set @p_a2=4;
set @p_b2=4;

execute p_stmt_i using @p_a1,@p_b1,@p_a2,@p_b2;
execute p_stmt_u using @p_b2,@p_a1;
execute p_stmt_d using @p_a2;
execute p_stmt_s using @p_a1;
execute p_stmt_s using @p_a2;

connection conn1;
rollback;
set autocommit=1;
execute stmt_select;

connection conn2;
rollback;
set autocommit=1;
execute p_stmt_select;

disconnect conn1;
disconnect conn2;



###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
