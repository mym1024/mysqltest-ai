--source merge.sql
####################################必填######################################################
###1.测试功能点：prepare语句，分区
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：xxx
###4.问题号：xxx
###5.预计运行时间：178.28 s
###6.编写/修改人：pangtong
###7.编写/修改日期：2019-11-5
###8.其他（选填）：case格式规范化修改
###
##
#
##############################################################################################

#####################################Do sql###################################################
--disable_warnings
drop table if exists t1,t2,t3; 
alter system set min_drop_cache_wait_time='10s' server_type=yaodatasvr;
alter system set each_tablet_sync_meta=False server_type=yaodatasvr;
--disable_query_log
--enable_query_log
--real_sleep 3


###2-1:哈希分区，prepare语句
--error 5077
drop partition function h;
create hash partition function h(x) 'x+1';
create table t1(a int primary key,b varchar(255),c int)partition by(hs,h,a);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);


prepare stmt1 from insert into t1 values(?,'d',2);
set @x=4;
execute stmt1 using @x;
alter table t1 add d int;
set @x=5;
--error 5007
execute stmt1 using @x;
select * from t1;
deallocate prepare stmt1;
drop table t1;


###2-2:枚举分区，prepare语句
--error 5077
drop partition function e;
create enum partition function e(x) '[(1)],[(2)],[(3)],[(4)],[(5)],[(6)],[(7)],[(8)],[(9)],[(10)]';
create table t1(a int primary key,b varchar(255),c int)partition by(em,e,a);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3);

prepare stmt2 from insert into t1 values(?,'d',3);
set @x=3;
execute stmt2 using @x;
--error 5009
alter table t1 drop q;
set @x=4;
execute stmt2 using @x;
select * from t1;
deallocate prepare stmt2;

prepare stmt3 from insert into t1 values(?,'d',3);
set @x=5;
execute stmt3 using @x;
alter table t1 drop c;
set @x=6;
--error 5007
execute stmt3 using @x;
select * from t1;
deallocate prepare stmt3;

prepare stmt4 from insert into t1 values(?,'d');
set @x=7;
execute stmt4 using @x;
alter table t1 add c int;
alter table t1 drop c;
set @x=8;
execute stmt4 using @x;
select * from t1;
deallocate prepare stmt4;

drop table t1;


###2-3:range分区，prepare语句
create table t1(a int primary key,b varchar(255),c int) partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than(15),partition r3 values less than maxvalue);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt10 from replace into t1(a,b,c) values(1,'d',?),(2,'f',6);
set @x=1;
execute stmt10 using @x;
alter table t1 add d int;
execute stmt10 using @x;
select * from t1;
deallocate prepare stmt10;


drop table t1;
create table t1(a int primary key,b varchar(255),c int,d int)partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than maxvalue);
--real_sleep 1
insert into t1 values(1,'a',2,2);

prepare stmt11 from replace into t1(a,b,c) values(1,'d',?),(2,'f',6);
set @x=1;
execute stmt11 using @x;
alter table t1 drop d;
execute stmt11 using @x;
select * from t1;
deallocate prepare stmt11;


drop table t1;
create table t1(a int primary key,b varchar(255),c int)partition by list(a)(partition q0 values in(1,3),partition q1 values in(2,4,5));
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);
alter table t1 add d int;

prepare stmt12 from replace into t1(a,b,c) values(1,'d',?),(2,'f',6);
set @x=1;
execute stmt12 using @x;
alter table t1 drop c;
--error 5009
execute stmt12 using @x;
select * from t1;
deallocate prepare stmt12;


drop table t1;
create table t1(a int primary key,b varchar(255),c int);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt13 from replace into t1(a,b,c) values(1,'d',?),(2,'f',6);
set @x=1;
execute stmt13 using @x;
alter table t1 drop c;
--error 5009
execute stmt13 using @x;
select * from t1;
deallocate prepare stmt13;
drop table t1;


###2-4:无分区，prepare语句
create table t1(a int primary key,b varchar(255),c int)partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than(15),partition r3 values less than maxvalue);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);
prepare stmt5 from insert into t1 values(?,'d',4);
set @x=4;
execute stmt5 using @x;
alter table t1 drop b;
alter table t1 add b varchar(255);
set @x=5;
--error 7
execute stmt5 using @x;
select * from t1;
deallocate prepare stmt5;

prepare stmt6 from insert into t1 values(?,'d',2);
set @x=6;
--error 7
execute stmt6 using @x;
alter table t1 drop b;
alter table t1 add b int;
set @x=7;
--error 7
execute stmt6 using @x;
select * from t1;
deallocate prepare stmt6;

prepare stmt7 from insert into t1 values(?,2,6);
set @x=8;
execute stmt7 using @x;
drop table t1;


###2-5:range分区
--error 5019
execute stmt7 using @x;
deallocate prepare stmt7;

create table t1(a int primary key,b varchar(255),c int)partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r3 values less than maxvalue);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt8 from insert into t1 values(?,2,3);
set @x=4;
execute stmt8 using @x;
drop table t1;
create table t1(a int primary key,b varchar(255),c int);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);
set @x=5;
#--error 5012
execute stmt8 using @x;
select * from t1;
deallocate prepare stmt8;

prepare stmt9 from insert into t1 values(?,2,5);
set @x=4;
execute stmt9 using @x;
drop table t1;
sleep 1;
create table t1(a int primary key,b varchar(255));
sleep 15;
set @x=5;
--error 5007
execute stmt9 using @x;
select * from t1;
--real_sleep 1
deallocate prepare stmt9;

drop table t1;

###2-6:list分区
create table t1(a int primary key,b varchar(255),c int)partition by list(a)(partition q0 values in(1,3),partition q1 values in(2,4,5));
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

# add column
prepare stmt10 from insert into t1(a,b,c) values(?,'d',6);
set @x=4;
execute stmt10 using @x;
alter table t1 add d int;
set @x=5;
execute stmt10 using @x;
select * from t1;
deallocate prepare stmt10;

drop table t1;
create table t1(a int primary key,b varchar(255),c int)partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than(15),partition r3 values less than maxvalue);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);
alter table t1 add d int;

prepare stmt11 from insert into t1(a,b,c) values(?,'d',3);
set @x=4;
execute stmt11 using @x;
alter table t1 drop d;
set @x=5;
execute stmt11 using @x;
select * from t1;
deallocate prepare stmt11;

drop table t1;


###2-7:range分区
create table t1(a int primary key,b varchar(255),c int)partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r3 values less than maxvalue);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);
alter table t1 add d int;

prepare stmt12 from insert into t1(a,b,c) values(?,'d',2);
set @x=4;
execute stmt12 using @x;
alter table t1 drop c;
set @x=5;
--error 5009
execute stmt12 using @x;
select * from t1;
deallocate prepare stmt12;

drop table t1;
create table t1(a int primary key,b varchar(255),c int)partition by list(a)(partition q0 values in(1,3),partition q1 values in(2,4,5));
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt13 from insert into t1(a,b) values(?,'d');
set @x=4;
execute stmt13 using @x;
alter table t1 drop c;
set @x=5;
execute stmt13 using @x;
select * from t1;
deallocate prepare stmt13;

drop table t1;


###2-8:list分区
create table t1(a int primary key,b varchar(255),c int)partition by list(a)(partition q0 values in(1,3),partition q1 values in(2,4,5));
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt14 from insert into t1(a,b,c) values(?,'d',1);
set @x=4;
--real_sleep 1
execute stmt14 using @x;
alter table t1 drop c;
alter table t1 add c int;
set @x=5;
#--error 18
--sleep 3
execute stmt14 using @x;
select * from t1;
deallocate prepare stmt14;

drop table t1;


###2-9:range分区
create table t1(a int primary key,b varchar(255),c int)partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r3 values less than maxvalue);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt15 from insert into t1(a,b,c) values(?,'d',1);
set @x=4;
execute stmt15 using @x;
alter table t1 drop b;
alter table t1 add b int;
set @x=5;
--error 7
execute stmt15 using @x;
select * from t1;
deallocate prepare stmt15;

drop table t1;
create table t1(a int primary key,b varchar(255),c int)partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than(15),partition r3 values less than maxvalue);
--real_sleep 1
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt16 from insert into t1(a,b,c) values(?,'d',1);
set @x=4;
execute stmt16 using @x;
alter table t1 add d int;
alter table t1 drop d;
set @x=5;
execute stmt16 using @x;
select * from t1;
deallocate prepare stmt16;


###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
