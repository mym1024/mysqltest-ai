--source merge.sql
####################################必填######################################################
###1.测试功能点：查询优化器多个fromItem隐式JOIN，多个连接条件
##
#
###2.测试项：(每新添一测试项, 需在添加前注明测试项, 注释填写在新添sq1前, 不填在此处, 如下样例）
###3.问题网址：http://182.119.80.93/cbase_dev/cbase/merge_requests/531
###4.问题号：432-feature_statistic_info_and_optimizer
###5.预计运行时间：xxx
###6.编写/修改人：曹俊，张二宝
###7.编写/修改日期：20200903
###8.其他（选填）：新编case
###
##
#
##############################################################################################

#####################################Do sql###################################################
create database opt;
using database opt;
sleep 5;

###打开查询优化器开关
set yao_enable_query_optimizer=true;

###设置合并参数

###建表插数据
create table if not exists t1(id int primary key, c1 Decimal(5,2), c2 int);
create table if not exists t2(id int primary key, c1 Decimal(5,2), c2 int);
create table if not exists t3(id int primary key, c1 Decimal(5,2), c2 int);

###t1表
###t1.c1列：高频值不同值个数：10，高频值平均重复次数：40，低频值不同值个数：50，低频值平均重复次数：12，倾斜率>0.5
###t1.c2列：高频值不同值个数：10，高频值平均重复次数：100，低频值不同值个数：100，低频值平均重复次数：25，倾斜率<0.5
--let $row_num = 0
--let $HD = 1
--let $LD = 11
--let $P = 0
--let $HD2 = 1
while ($HD < 11)
{
  let $number = 0;

  while ($number < 40)
  {
    eval replace into t1 values($row_num, $HD, $HD2);
    inc $number;
    inc $row_num;
    inc $P;
    
    if ($P == 100)
    {
      inc $HD2;
      while ($P > 0)
      {
        dec $P;
      }
    }
  }

  if ($number == 40)
  {
    inc $HD;
  }
}

while ($LD < 61)
{
  let $number = 0;
  while ($number < 12)
  {
    eval replace into t1 values($row_num, $LD, $HD2);
    inc $number;
    inc $row_num;
    inc $P;

    if ($P == 100)
    {
      inc $HD2;
      while ($P > 0)
      {
        dec $P;
      }
    }
  }

  if ($number == 12)
  {
    inc $LD;
  }
}

while ($HD2 < 111)
{
  let $number = 0;

  while ($number < 25)
  {
    eval replace into t1 values($row_num, NULL, $HD2);
    inc $number;
    inc $row_num;
  }

  if ($number == 25)
  {
    inc $HD2;
  }
}

###t2表
###t2.c1列：高频值不同值个数：10，高频值平均重复次数：40，低频值不同值个数：50，低频值平均重复次数：12，倾斜率>0.5
###t2.c2列：高频值不同值个数：10，高频值平均重复次数：100，低频值不同值个数：100，低频值平均重复次数：10，倾斜率>0.5
--let $row_num = 0
--let $HD = 1
--let $LD = 11
--let $P = 0
--let $HD2 = 1
while ($HD < 11)
{
  let $number = 0;

  while ($number < 40)
  {
    eval replace into t2 values($row_num, $HD, $HD2);
    inc $number;
    inc $row_num;
    inc $P;
    
    if ($P == 100)
    {
      inc $HD2;
      while ($P > 0)
      {
        dec $P;
      }
    }
  }

  if ($number == 40)
  {
    inc $HD;
  }
}

while ($LD < 61)
{
  let $number = 0;
  while ($number < 12)
  {
    eval replace into t2 values($row_num, $LD, $HD2);
    inc $number;
    inc $row_num;
    inc $P;

    if ($P == 100)
    {
      inc $HD2;
      while ($P > 0)
      {
        dec $P;
      }
    }
  }

  if ($number == 12)
  {
    inc $LD;
  }
}

while ($HD2 < 111)
{
  let $number = 0;

  while ($number < 10)
  {
    eval replace into t2 values($row_num, NULL, $HD2);
    inc $number;
    inc $row_num;
  }

  if ($number == 10)
  {
    inc $HD2;
  }
}

###t3表
###高频值不同值个数：10，高频值平均重复次数：40，低频值不同值个数：50，低频值平均重复次数：20，倾斜率<0.5
--let $row_num = 0
--let $HD = 1
--let $LD = 11
while ($HD < 11)
{
  let $number = 0;
  while ($number < 40)
  {
    eval replace into t3 values($row_num, $HD, $HD);
    inc $number;
    inc $row_num;
  }

  if ($number == 40)
  {
    inc $HD;
  }
}

while ($LD < 61)
{
  let $number = 0;
  while ($number < 20)
  {
    eval replace into t3 values($row_num, $LD, $LD);
    inc $number;
    inc $row_num;
  }

  if ($number == 20)
  {
    inc $LD;
  }
}

###合并
--echo "merge"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 800 
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

###生成统计任务
gather statistics t1(c1, c2);
gather statistics t2(c1, c2);
gather statistics t3(c1, c2);

###查看收集任务
select * from __all_udi_monitor_list;

###启动收集命令
--echo "statistics"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT gather_statistics | tail -1;
--real_sleep 10 

###查看统计信息
select * from __all_statistic_info;

###检查左右表数据行数
select count(*) from t1;
select count(*) from t2;
select count(*) from t3;

###防止查询进程Process timeout
set global yao_query_timeout=2147483647;
connect (conn1,$OBMYSQL_MS0,admin,admin,opt,$OBMYSQL_PORT);
connection conn1;

###2-1：hash join & hash join & hash join，交换where后的连接条件顺序
select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t2.c2 = t3.c2 and t1.c2 = t2.c2;
explain select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t2.c2 = t3.c2 and t1.c2 = t2.c2;

select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c1 = t2.c1 and t1.c2 = t2.c2;
explain select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c1 = t2.c1 and t1.c2 = t2.c2;

select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t2.c2 = t3.c2 and t1.c1 = t2.c1;
explain select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t2.c2 = t3.c2 and t1.c1 = t2.c1;

select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t1.c2 = t2.c2 and t2.c2 = t3.c2;
explain select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t1.c2 = t2.c2 and t2.c2 = t3.c2;

select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t1.c1 = t2.c1 and t2.c2 = t3.c2;
explain select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t1.c1 = t2.c1 and t2.c2 = t3.c2;

select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c2 = t2.c2 and t1.c1 = t2.c1;
explain select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c2 = t2.c2 and t1.c1 = t2.c1;

select count(*) from t1, t2 left join t3 on t2.c1 = t3.c1 and t2.c2 = t3.c2 where  t1.c1 = t2.c1 and t1.c2 = t2.c2;
explain select count(*) from t1, t2 left join t3 on t2.c1 = t3.c1 and t2.c2 = t3.c2 where  t1.c1 = t2.c1 and t1.c2 = t2.c2;

###2-2：hash join & semi join & semi join，通过过滤条件控制表的不同值个数使其符合semi join，交换where后的连接条件顺序
select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t2.c2 = t3.c2 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;
explain select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t2.c2 = t3.c2 and  t1.c2 = t2.c2 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;

select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c1 = t2.c1 and  t1.c2 = t2.c2 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;
explain select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c1 = t2.c1 and  t1.c2 = t2.c2 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;

select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t2.c2 = t3.c2 and  t1.c1 = t2.c1 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;
explain select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t2.c2 = t3.c2 and  t1.c1 = t2.c1 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;

select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t1.c2 = t2.c2 and  t2.c2 = t3.c2 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;
explain select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t1.c2 = t2.c2 and  t2.c2 = t3.c2 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;

select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t1.c1 = t2.c1 and  t2.c2 = t3.c2 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;
explain select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t1.c1 = t2.c1 and  t2.c2 = t3.c2 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;

select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c2 = t2.c2 and  t1.c1 = t2.c1 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;
explain select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c2 = t2.c2 and  t1.c1 = t2.c1 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;

select count(*) from t1, t2 left join t3 on t2.c1 = t3.c1 and t2.c2 = t3.c2 where  t1.c1 = t2.c1 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;
explain select count(*) from t1, t2 left join t3 on t2.c1 = t3.c1 and t2.c2 = t3.c2 where  t1.c1 = t2.c1 and  t1.c2 = t2.c2 and t1.c2 <= 40 and t3.c2 <= 60;

###2-3:semi join & semi join &semi join，通过过滤条件控制t1和t2的c1列的行数小于200行，使其满足semi join，交换where后的连接条件顺序
select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t2.c2 = t3.c2 and  t1.c2 = t2.c2 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);
explain select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t2.c2 = t3.c2 and  t1.c2 = t2.c2 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);

select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c1 = t2.c1 and  t1.c2 = t2.c2 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);
explain select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c1 = t2.c1 and  t1.c2 = t2.c2 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);

select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t2.c2 = t3.c2 and  t1.c1 = t2.c1 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);
explain select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t2.c2 = t3.c2 and  t1.c1 = t2.c1 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);

select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t1.c2 = t2.c2 and  t2.c2 = t3.c2 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);
explain select count(*) from t1, t2, t3 where t1.c1 = t2.c1 and t1.c2 = t2.c2 and  t2.c2 = t3.c2 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);

select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t1.c1 = t2.c1 and  t2.c2 = t3.c2 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);
explain select count(*) from t1, t2, t3 where t1.c2 = t2.c2 and t1.c1 = t2.c1 and  t2.c2 = t3.c2 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);

select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c2 = t2.c2 and  t1.c1 = t2.c1 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);
explain select count(*) from t1, t2, t3 where t2.c2 = t3.c2 and t1.c2 = t2.c2 and  t1.c1 = t2.c1 and  (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);

select count(*) from t1, t2 left join t3 on t2.c1 = t3.c1 and t2.c2 = t3.c2 where  t1.c1 = t2.c1 and  t1.c2 = t2.c2 and (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);
explain select count(*) from t1, t2 left join t3 on t2.c1 = t3.c1 and t2.c2 = t3.c2 where  t1.c1 = t2.c1 and  t1.c2 = t2.c2 and (t1.c1 = 1 or t1.c1 = 11) and (t2.c1 = 1 or t2.c1 = 11);

###删表删库
drop table if exists t1;
drop table if exists t2;
drop table if exists t3;
drop database opt;

########################################################################################################
