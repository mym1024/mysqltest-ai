--source merge.sql
##############################################################################################
###1.测试功能点：alter table 修改分区方式正常系--不分区表改分区表
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：xxx
###4.问题号：xxx
###5.预计运行时间：xxx
###6.编写/修改人：zhuyinying
###7.编写/修改日期：2020-03-20
###8.其他（选填）：case格式规范化修改
###
##
#
##############################################################################################

#####################################Do sql###################################################
--disable_warnings
drop table if exists t1_r,t2_r,t3_r,t1_h,t2_h;
alter system set balance_max_concurrent_migrate_num=30 server_type=yaoadminsvr;
alter system set balance_max_migrate_in_per_ds=6 server_type=yaoadminsvr;
alter system set balance_max_migrate_out_per_ds=6 server_type=yaoadminsvr;
alter system set max_migrate_task_count=6 server_type=yaodatasvr;

###2-1:不分区表改range分区表
create range partition function r_1(x) '(10),(20),(maxvalue)';
create range partition function r_2(x,y) '(10,\'abc\'),(20,\'bcd\'),(maxvalue,maxvalue)';
show partition functions;
create table t1_r(a int primary key,b int);
create table t2_r(a int primary key,b int);
create table t3_r(a int,b varchar(10),c int,primary key(a,b));

create index il1 on t2_r(b);
create index il1 on t1_r(b);
create index il1 on t3_r(c);
--echo "refesh"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 3

show index on t2_r;
show index on t1_r;
show partition groups;

insert into t1_r values(1,1),(10,1),(20,1);
insert into t2_r values(1,1),(10,1),(20,1);
insert into t3_r values(1,'a',1),(10,'ab',1),(10,'abc',1),(20,'abc',1);
--real_sleep 1

select * from t1_r;
delete from t1_r where a=1;
delete from t1_r where a=10;
select * from t1_r;
select * from t2_r;
delete from t2_r where a=1;
delete from t2_r where a=10;
select * from t2_r;
select * from t3_r;
delete from t3_r where a=1;
delete from t3_r where a=10;
--real_sleep 1
select * from t3_r;

truncate table t1_r;
insert into t1_r values(1,1),(10,1),(20,1);

truncate table t2_r;
insert into t2_r values(1,1),(10,1),(20,1);
--real_sleep 1

truncate table t3_r;
insert into t3_r values(1,'a',1),(10,'ab',1),(10,'abc',1),(20,'abc',1);
--real_sleep 1

select * from t2_r;
delete from t2_r where a=1;
delete from t2_r where a=10;
select * from t2_r;
alter table t2_r partition rule to (,r_1,a);

select * from t1_r;
delete from t1_r where a=1;
delete from t1_r where a=10;
select * from t1_r;
alter table t1_r partition rule to (rr,r_1,a);

select * from t3_r;
delete from t3_r where a=1;
delete from t3_r where a=10;
--real_sleep 1
select * from t3_r;
alter table t3_r partition rule to (rr,r_2,a,b);

show partition groups;
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 900
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

show index on t2_r;
select * from t2_r;
insert into t2_r values(1,1),(10,1),(30,1);
replace into t2_r values(30,3);
update t2_r set b=5 where a=1;
--real_sleep 1
select * from t2_r;
delete from t2_r where a=1;
delete from t2_r where a=10;
select * from t2_r;

show index on t1_r;
select * from t1_r;
insert into t1_r values(1,1),(10,1),(30,1);
replace into t1_r values(30,3);
update t1_r set b=5 where a=1;
--real_sleep 1
select * from t1_r;
delete from t1_r where a=1;
delete from t1_r where a=10;
select * from t1_r;

show index on t3_r;
select * from t3_r;
insert into t3_r values(1,'a',1),(10,'ab',1),(10,'abc',1);
replace into t3_r values(20,'bdc',3);
update t3_r set c=5 where a=1;
--real_sleep 1
select * from t3_r;
delete from t3_r where a=1;
delete from t3_r where a=10;
--real_sleep 1
select * from t3_r;

truncate table t1_r;
--real_sleep 1
select * from t1_r;
insert into t1_r values(1,1),(10,1),(20,1);
--real_sleep 3
select * from t1_r;

truncate table t2_r;
--real_sleep 1
select * from t2_r;
insert into t2_r values(1,1),(10,1),(20,1);
--real_sleep 3
select * from t2_r;

truncate table t3_r;
--real_sleep 1
select * from t3_r;
insert into t3_r values(1,'a',1),(10,'ab',1),(10,'abc',1),(20,'abc',1);
--real_sleep 3
select * from t3_r;

exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 700
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

show index on t2_r;
select * from t2_r;
show index on t1_r;
select * from t1_r;
show index on t3_r;
select * from t3_r;

drop table t2_r,t1_r,t3_r;
drop partition function r_1,r_2;

###2-1:不分区表改hash分区表
create hash partition function h_1(x) 'x';
show partition functions;
create table t1_h(a int primary key,b int);
create table t2_h(a int primary key,b int);

create index il1 on t1_h(b);
create index il1 on t2_h(b);
--echo "refesh"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 3

show index on t1_h;
show index on t2_h;
show partition groups;

insert into t1_h values(1,1),(4,1),(2,1),(5,1);
insert into t2_h values(1,1),(4,1),(2,1),(5,1);

select * from t1_h;
delete from t1_h where a=2;
delete from t1_h where a=4;
select * from t1_h;
select * from t2_h;
delete from t2_h where a=2;
delete from t2_h where a=4;
select * from t2_h;

truncate table t1_h;
insert into t1_h values(1,1),(4,1),(2,1),(5,1);
truncate table t2_h;
insert into t2_h values(1,1),(4,1),(2,1),(5,1);

select * from t1_h;
delete from t1_h where a=2;
delete from t1_h where a=4;
select * from t1_h;
alter table t1_h partition rule to (hh,h_1,a);

select * from t2_h;
delete from t2_h where a=2;
delete from t2_h where a=4;
select * from t2_h;
alter table t2_h partition rule to (,h_1,a);
show partition groups;

exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 600
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

show index on t1_h;
select * from t1_h;
insert into t1_h values(4,1),(8,1),(2,1);
replace into t1_h values(8,3);
update t1_h set b=5 where a=2;
--real_sleep 1
select * from t1_h;
delete from t1_h where a=1;
delete from t1_h where a=5;
select * from t1_h;

show index on t2_h;
select * from t2_h;
insert into t2_h values(4,1),(8,1),(2,1);
replace into t2_h values(8,3);
update t2_h set b=5 where a=2;
--real_sleep 5
select * from t2_h;
delete from t2_h where a=1;
delete from t2_h where a=5;
select * from t2_h;

truncate table t1_h;
select * from t1_h;
insert into t1_h values(4,1),(8,1),(2,1);
--real_sleep 5
select * from t1_h;

truncate table t2_h;
select * from t2_h;
insert into t2_h values(4,1),(8,1),(2,1);
--real_sleep 5
select * from t2_h;

exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 600
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

show index on t1_h;
select * from t1_h;
show index on t2_h;
select * from t2_h;
###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
