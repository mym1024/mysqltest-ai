--source merge.sql
##############################################################################################
###1.测试功能点：测试过期条件expire_info
##                  
#                                     
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：
###4.问题号：
###5.预计运行时间：2000s
###6.编写/修改人： gaohuanyu
###7.编写/修改日期：2019-11-07
###8.其他（选填）：case格式规范化修改
###
##
#
##############################################################################################

#####################################Do sql###################################################
--echo case 1:int + 1 row
--disable_query_log
alter system set min_drop_cache_wait_time='10s' server_type=yaodatasvr;
alter system set safe_copy_count_in_init = 1 server_type=yaodatasvr;
alter system set each_tablet_sync_meta=False server_type=yaodatasvr;
--enable_query_log
--real_sleep 6

###2-1:过期条件测试，合并后清除满足过期条件的数据，过期列为时间戳类型，全部过期
--echo case 4:all expire
drop table if exists t1;
create table t1(c0 int primary key,c1 modifytime) EXPIRE_INFO='c1>0';
--real_sleep 5
insert into t1(c0) values(1),(2),(3);
--replace_column 2 time
select count(c0) from t1;

--echo merge happens
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 300

select count(c0) from t1;
drop table t1;

###2-2:过期条件测试，合并后清除满足过期条件的数据，过期列为时间戳类型，无过期
--echo case 5:no expire
drop table if exists t1;
create table t1(c0 int primary key,c1 modifytime) EXPIRE_INFO='c1<0';
--real_sleep 5
insert into t1(c0) values(1),(2),(3);
--replace_column 2 time
select count(c0) from t1;

--echo merge happens
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 300
--replace_column 2 time
select count(c0) from t1;
drop table t1;


###2-3:过期条件测试，合并后清除满足过期条件的数据，过期列为时间戳类型，测试过期条件为具体时间点
--echo case 6:expression test
drop table if exists t1;
create table t1(c0 int primary key,c1 modifytime) EXPIRE_INFO='c1> #2012-10-01 23:00:00#';
--real_sleep 5
insert into t1(c0) values(1),(2),(3);
--replace_column 2 time


--echo merge happens
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 300
select count(c0) from t1;
drop table t1;



###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
