--source merge.sql
####################################必填######################################################
###1.测试功能点：建表时创建expire_info，带索引
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：http://182.119.80.93/cbase_dev/cbase/issues/352
###4.问题号：352
###5.预计运行时间：3150 s
###6.编写/修改人：wangxiangyi
###7.编写/修改日期：2019-10-16 / mod:2020-12-24:zyy
###8.其他（选填）：according to the 608-expire_info_support_int_type, mod this case
###
##
#
##############################################################################################

#####################################Do sql###################################################
alter system set balance_max_concurrent_migrate_num=30 server_type=yaoadminsvr;
alter system set balance_max_migrate_in_per_ds=6 server_type=yaoadminsvr;
alter system set balance_max_migrate_out_per_ds=6 server_type=yaoadminsvr;
alter system set max_migrate_task_count=6 server_type=yaodatasvr;
--disable_warnings
drop table if exists test1;
drop table if exists test2;
drop table if exists test3;
drop table if exists test4;
drop table if exists test5;
drop table if exists test6;
drop table if exists test7;
drop table if exists test8;
drop table if exists test9;
drop table if exists test10;

--enable_warnings
alter system set location_cache_timeout='6s' server_type=yaosqlsvr;

##################################### MODIFYTIME ###################################################
#创建含有modifytime属性列的数据表Test1:(条件中缺少列名，失败)
--error 2
create table test1(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 modifytime)expire_info='$SYS_DATE>1*1*1*60*1000000';

#创建含有modifytime属性列的数据表Test1:(条件中多余一列，失败)
#--error 2
create table test1(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 modifytime)expire_info='$SYS_DATE>c2+c8+1*1*1*60*1000000';
drop table test1;

###2-1 创建含有modifytime属性列的数据表Test1：(条件中缺少列名，失败)
create table test1(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 modifytime)expire_info='$SYS_DATE>c8+1*1*1*60*1000000';

#创建索引
create index t1_1 on test1(c2) storing (c8);
create index t1_2 on test1(c3) storing (c8);
create index t1_3 on test1(c4) storing (c8);
create index t1_4 on test1(c5) storing (c8);
create index t1_5 on test1(c6) storing (c8);

#插入数据
insert into test1(c1, c2, c3, c4, c5, c6, c7) values(1,1,1,1,1,1,1),(2,2,2,2,2,2,2);

select  c1,c2,c3 from test1;


###2-2: 修改expire_info条件:
alter table test1 alter current expire_info='$SYS_DATE>c8+1*1*2*60*1000000';

###2-3: 删除expire_info条件
alter table test1 drop current expire_info;

###2-4: 添加expire_info条件:
alter table test1 add current expire_info='$SYS_DATE>c8+1*1*2*60*1000000';


##################################### CREATETIME ###################################################
###2-6 创建含有createtime属性列的数据表test2:
create table test2(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 createtime)expire_info='$SYS_DATE>c8+1*1*1*60*1000000';

#创建索引
create index t2_1 on test2(c2) storing (c8);
create index t2_2 on test2(c3) storing (c8);
create index t2_3 on test2(c4) storing (c8);
create index t2_4 on test2(c5) storing (c8);
create index t2_5 on test2(c6) storing (c8);

insert into test2(c1, c2, c3, c4, c5, c6, c7) values(1,1,1,1,1,1,1),(2,2,2,2,2,2,2);


##################################### VARCHAR ###################################################
###2-7 创建含有varchar属性列的数据表test3:
create table test3(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 varchar(30))expire_info='$SYS_DATE>c8+1*1*1*60*1000000';

#创建索
create index t3_1 on test3(c2) storing (c8);
create index t3_2 on test3(c3) storing (c8);
create index t3_3 on test3(c4) storing (c8);
create index t3_4 on test3(c5) storing (c8);
create index t3_5 on test3(c6) storing (c8);

insert into test3 values(1,1,1,1,1,1,1, '2019-10-22 15:40:04.741359'),(2,2,2,2,2,2,2, '2019-10-22 15:40:04.741359');


##################################### CHAR ###################################################
###2-8 创建含有char属性列的数据表test4:
create table test4(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 char(30))expire_info='$SYS_DATE>c8+1*1*1*60*1000000';

#创建索引
create index t4_1 on test4(c2) storing (c8);
create index t4_2 on test4(c3) storing (c8);
create index t4_3 on test4(c4) storing (c8);
create index t4_4 on test4(c5) storing (c8);
create index t4_5 on test4(c6) storing (c8);

insert into test4 values(1,1,1,1,1,1,1, '2019-10-22 15:40:04.741359'),(2,2,2,2,2,2,2, '2019-10-22 15:40:04.741359');


##################################### DATETIME ###################################################
###2-9 创建含有datetime属性列的数据表test5:
create table test5(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 datetime)expire_info='$SYS_DATE>c8+1*1*1*60*1000000';

#创建索引
create index t5_1 on test5(c2) storing (c8);
create index t5_2 on test5(c3) storing (c8);
create index t5_3 on test5(c4) storing (c8);
create index t5_4 on test5(c5) storing (c8);
create index t5_5 on test5(c6) storing (c8);

insert into test5 values(1,1,1,1,1,1,1, '2019-10-22 15:40:04.741359'),(2,2,2,2,2,2,2, '2019-10-22 15:40:04.741359');


##################################### TIMESTAMP ###################################################
###2-10 创建含有timestamp属性列的数据表test6:
create table test6(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 timestamp)expire_info='$SYS_DATE>c8+1*1*1*60*1000000';

#创建索引
create index t6_1 on test6(c2) storing (c8);
create index t6_2 on test6(c3) storing (c8);
create index t6_3 on test6(c4) storing (c8);
create index t6_4 on test6(c5) storing (c8);
create index t6_5 on test6(c6) storing (c8);

insert into test6 values(1,1,1,1,1,1,1, '2019-10-22 15:40:04.741359'),(2,2,2,2,2,2,2, '2019-10-22 15:40:04.741359');

--real_sleep 120

--echo "merge"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 1900
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

select * from test1;
select * from test2;
select * from test3;
select * from test4;
select * from test5;
select * from test6;


#2-10 过期列不支持后期alter
--error 1046
alter table test1 rename c8 to col8;

--error 1046
alter table test3 alter column c8 set data type varchar(32);


###2-11 修改expire_info条件使条件保证永真数据永不过期：
alter table test1 alter current expire_info='1=0';
alter table test2 alter current expire_info='1=0';
alter table test3 alter current expire_info='1=0';
alter table test4 alter current expire_info='1=0';
alter table test5 alter current expire_info='1=0';
alter table test6 alter current expire_info='1=0';

insert into test1(c1, c2, c3, c4, c5, c6, c7) values(1,1,1,1,1,1,1),(2,2,2,2,2,2,2);
insert into test2(c1, c2, c3, c4, c5, c6, c7) values(1,1,1,1,1,1,1),(2,2,2,2,2,2,2);
insert into test3 values(1,1,1,1,1,1,1, '2019-10-22 15:40:04.741359'),(2,2,2,2,2,2,2, '2019-10-22 15:40:04.741359');
insert into test4 values(1,1,1,1,1,1,1, '2019-10-22 15:40:04.741359'),(2,2,2,2,2,2,2, '2019-10-22 15:40:04.741359');
insert into test5 values(1,1,1,1,1,1,1, '2019-10-22 15:40:04.741359'),(2,2,2,2,2,2,2, '2019-10-22 15:40:04.741359');
insert into test6 values(1,1,1,1,1,1,1, '2019-10-22 15:40:04.741359'),(2,2,2,2,2,2,2, '2019-10-22 15:40:04.741359');

--echo "merge"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 600
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT stat -o merge | tail -1;

select c1,c2,c3 from test1;
select c1,c2,c3 from test2;
select * from test3;
select * from test4;
select * from test5;
select * from test6;


##################################### INT ###################################################
###2-12 创建含有int属性列的数据表test7:
#--error 2
create table test7(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 int)expire_info='$SYS_DATE>c8+1*1*1*60*1000000';


##################################### FLOAT ###################################################
###2-13 创建含有float属性列的数据表test8:
--error 2
create table test8(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 float)expire_info='$SYS_DATE>c8+1*1*1*60*1000000';


##################################### DOUBLE ###################################################
###2-14 创建含有double属性列的数据表test9:
--error 2
create table test9(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 double)expire_info='$SYS_DATE>c8+1*1*1*60*1000000';


##################################### DECIMAL ###################################################
###2-15 创建含有decimal属性列的数据表test10:
--error 2
create table test10(c1 int primary key, c2 int, c3 int, c4 int, c5 int, c6 int, c7 int, c8 decimal(30,15))expire_info='$SYS_DATE>c8+1*1*1*60*1000000';

###2-16 修改expire_info条件为正确条件：
alter table test1 alter current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test2 alter current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test3 alter current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test4 alter current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test5 alter current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test6 alter current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';

###2-17 删除expire_info条件：
alter table test1 drop current expire_info;
alter table test2 drop current expire_info;
alter table test3 drop current expire_info;
alter table test4 drop current expire_info;
alter table test5 drop current expire_info;
alter table test6 drop current expire_info;

###2-18 添加expire_info条件：
alter table test1 add current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test2 add current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test3 add current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test4 add current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test5 add current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';
alter table test6 add current expire_info='$SYS_DATE>c8+1*1*1*60*1000000';


###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
