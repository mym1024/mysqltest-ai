--source merge.sql
####################################必填######################################################
###1.测试功能点：对指定hash分区规则的表进行删除操作
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：xxx
###4.问题号：361
###5.预计运行时间：709 s
###6.编写/修改人：wangxiangyi
###7.编写/修改日期：2019-10-21
###8.其他（选填）：361bug修复后修改
###
##
#
##############################################################################################

#####################################Do sql###################################################
--disable_warnings
drop table if exists t1;
--enable_warnings

alter system set min_drop_cache_wait_time='10s' server_type=yaodatasvr;

create hash partition function h1(x)'x+1';
create table t1(id int primary key,c1 int,c2 decimal(25,0)) partition by(hs,h1,id);
show partition groups;
create index t1_index1 on t1 (c1) storing (c2);
create index t1_index2 on t1 (c2) storing (c1);
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT refresh_schema | tail -1;
--real_sleep 5
create or replace sequence seq;
insert into t1 values(nextval for seq,nextval for seq+nextval for seq,0);
--real_sleep 5
insert into t1 values(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq),(nextval for seq,nextval for seq+nextval for seq,prevval for seq);
--real_sleep 5
--echo "merge"
exec $LOCAL_DIR/tools/as_admin -r $RS0_IP -p $RS0_PORT major_freeze | tail -1;
--real_sleep 700

let $n=query_get_value(select table_id from __first_tablet_entry where table_name='t1',table_id,1);
--let $index_head =__
--let $index1_end =__idx__t1_index1
--let $index1_name=$index_head$n$index1_end
echo $index1_name;

--let $index2_end =__idx__t1_index2
--let $index2_name=$index_head$n$index2_end
echo $index2_name;

--let $select_for_index1=select * from $index1_name
--let $select_for_index2=select * from $index2_name

set yao_query_timeout=900000000;
eval select * from $index1_name;
eval select * from $index2_name;

# 1
select * from t1;
# 2
eval select * from $index1_name; # index1 on TABLE t1
eval select * from $index2_name; # index2 on TABLE t1

###2-1:根据prevval值进行delete操作
# 3
delete from t1 where id = prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 4
--error 5824
delete from t1 where id = prevval for seq1;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 5
delete from t1 where id = prevval for seq +1;
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 6
delete from t1 where id >= prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 7
delete from t1 where id >= prevval for seq-2;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 8
create or replace sequence seq;
--error 65535
delete from t1 where id = prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 9
create or replace sequence seq;
--error 65535
delete from t1 where id <= prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 10
create or replace sequence seq;
--error 65535
delete from t1 where id = prevval for seq +1;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 11
create or replace sequence seq;
--error 65535
delete from t1 where id <= prevval for seq +1;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 12
create or replace sequence seq;
--error 65535
delete from t1 where id = prevval for seq +prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 13
create or replace sequence seq;
--error 65535
delete from t1 where id <= prevval for seq +prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 14
select nextval for seq from t1;
--real_sleep 5
delete from t1 where id between 10 and prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 15
select nextval for seq from t1;
delete from t1 where id between 9 and prevval for seq+1;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 16
select nextval for seq from t1;
delete from t1 where id between 9 and prevval for seq+prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 17
select nextval for seq from t1;
--error 5824
delete from t1 where id between 9 and prevval for seq+prevval for seq1;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
## 18
####2-2:在序列中指定数据类型和最小值，根据序列值对数据进行delete操作
#create or replace sequence seq as decimal(25,0) minvalue 1234567891234567891234;
#select nextval for seq;
#--error 5047
#delete from t1 where id = prevval for seq;
#--real_sleep 5
#select * from t1;
#eval select * from $index1_name;
#eval select * from $index2_name;
## 19
#create or replace sequence seq as decimal(25,0) minvalue 1234567891234567891234;
#select nextval for seq;
#--error 79
#delete from t1 where id >= prevval for seq;
#--real_sleep 5
#select * from t1;
#eval select * from $index1_name;
#eval select * from $index2_name;
# 20
###2-3:在序列中指定quick参数，根据序列值对数据进行delete操作
create or replace sequence seq quick;
--error 65535
delete from t1 where id = prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 21
create or replace sequence seq quick;
select nextval for seq;
delete from t1 where id = prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;
# 22
create or replace sequence seq quick;
select nextval for seq;
delete from t1 where id <= prevval for seq;
--real_sleep 5
select * from t1;
eval select * from $index1_name;
eval select * from $index2_name;

###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
########################################################################################################
