--source merge.sql
####################################必填######################################################
###1.测试功能点：多个最小聚合函数消除
##
#
###2.测试项：(每新添一测试项, 需在添加前注明测试项, 注释填写在新添sq1前, 不填在此处, 如下样例）
###3.问题网址：xxx
###4.问题号：xxx
###5.预计运行时间：xxx
###6.编写/修改人：曹俊
###7.编写/修改日期：20200619
###8.其他（选填）：xxx
###
##
#
##############################################################################################

#####################################Do sql###################################################
alter system set balance_max_concurrent_migrate_num=30 server_type=yaoadminsvr;
alter system set balance_max_migrate_in_per_ds=6 server_type=yaoadminsvr;
alter system set balance_max_migrate_out_per_ds=6 server_type=yaoadminsvr;
alter system set max_migrate_task_count=6 server_type=yaodatasvr;

--disable_warnings
drop table if exists t1, t2;
--enable_warnings


###建表插数据
create table t1(c1 int primary key, c2 int, c3 int, c4 int);
create table t2(c1 int primary key, c2 int, c3 int, c4 int);

create index idx1 on t1(c2);
create index idx2 on t1(c2) storing(c3);
create index idx3 on t1(c2, c3);
create index idx4 on t1(c2, c3) storing(c4);
create index idx5 on t1(c3);
create index idx6 on t1(c3) storing(c4);


show index on t1;

insert into t1 values(1, 3, 4, 6);
insert into t1 values(2, 2, 6, 5);
insert into t1 values(3, 4, 5, 3);
insert into t1 values(4, 6, 1, 4);
insert into t1 values(5, 5, 2, 1);
insert into t1 values(6, 1, 3, 2);

insert into t2 values(1, 3, 4, 6);
insert into t2 values(2, 2, 6, 5);
insert into t2 values(3, 4, 5, 3);
insert into t2 values(4, 6, 1, 4);
insert into t2 values(5, 5, 2, 1);
insert into t2 values(6, 1, 3, 2);

select @@yao_enable_query_optimizer;

set @@yao_enable_query_optimizer=true;

select @@yao_enable_query_optimizer;

###2-1：只含多个聚合函数
select min(c1), min(c2) from t1;

select min(c2), min(c3) from t1;

select min(c1), min(c2), min(c3) from t1;

select min(c1), min(c2), min(c3), min(c4) from t1;

select min(c1), min(c2) from t1 where c1 > 0 and c2 > 0;

select min(c2), min(c3) from t1  where c1 > 0 and c2 > 0 and c3 > 0;

select min(c2), min(c3) from t1  where c1 > 0 and c2 > 0 and c3 > 0  and c4 > 0;

select min(c1) as x, min(c2) as y from t1;


###2-2：嵌套子查询多个最小聚合函数消除
select min(a) from (select min(c1) as a, min(c2) as b from t1) t1;

select min(a) , min(b) from (select min(c1) as a, min(c2) as b from t1) t1;

select min(a) , min(b) from (select a, b from (select min(c1) as a, min(c2) as b from t1) t1) t1;

select * from (select min(a) as x, b from (select min(c1) as a, min(c2) as b from t1) t1) t1;


###2-3：显式连接子查询或嵌套子查询最小聚合消除
select * from t2 inner join (select min(c1) as a, min(c2) as b from t1) t1 on t2.c1 = t1.a;

select * from (select min(c1) as x, min(c2) as y from t1) a inner join (select min(c2) as z, min(c3) as w from t1) b on a.x = b.z and a.y = b.w;

select * from t2 inner join (select a, b from (select min(c1) as a, min(c2) as b from t1) t1) t1 on t2.c1 = t1.a;


###2-4：隐式连接子查询或嵌套子查询最小聚合消除
select * from t2, (select min(c1) as a, min(c2) as b from t1) t1 where t2.c1 = t1.a;

select * from (select min(c1) as x, min(c2) as y from t1) a, (select min(c2) as z, min(c3) as w from t1) b where a.x = b.z and a.y = b.w;

select * from t2, (select a, b from (select min(c1) as a, min(c2) as b from t1) t1) t1 where t2.c1 = t1.a;


###2-5：多个聚合函数+其他列, 非嵌套子查询
select min(c1), min(c2), c3 as x, c4 as y from t1;

select min(c1), min(c2), c1 as x, c2 as y, c1, c2 from t1;

select c1, min(c1), c2, min(c2), c2, c3 from t1;

select min(c1), min(c2), c3 as x, c4 as y from t1 where c1 > 0 and c2 > 0;

select min(c1), min(c2), c1 as x, c2 as y, c1, c2 from t1 where c1 > 0 and c2 > 0;

select c1, min(c1), c2, min(c2), c2, c3 from t1 where c1 > 0 and c2 > 0;


###2-6：多个聚合函数+其他列, 嵌套子查询
select min(a) from (select min(c1) as a, min(c2), c2, c3 from t1) t1;

select * from (select a, b from (select min(c1) as a, min(c2) as b, c2, c3 from t1) t1) t1;

select * from (select min(a) as x, c2 as w from (select min(c1) as a, min(c2), c2, c3 from t1) t1) t1;


###2-7：显式连接子查询或嵌套子查询最小聚合消除
select * from t2 inner join (select min(c1) as a, min(c2) as b, c2, c3 from t1) t1 on t2.c1 = t1.a;

select * from (select min(c1) as x, min(c2) as y, c2, c3 from t1) a inner join (select min(c2) as z, min(c3) as w, c2, c3 from t1) b on a.x = b.z and a.y = b.w;

select * from t2 inner join (select a, b from (select min(c1) as a, min(c2) as b, c2, c3 from t1) t1) t1 on t2.c1 = t1.a;


###2-8：隐式连接子查询或嵌套子查询最小聚合消除
select * from t2, (select min(c1) as a, min(c2) as b, c2, c3 from t1) t1 where t2.c1 = t1.a;

select * from (select min(c1) as x, min(c2) as y, c2, c3 from t1) a, (select min(c2) as z, min(c3) as w, c2, c3 from t1) b where a.x = b.z and a.y = b.w;

select * from t2, (select a, b from (select min(c1) as a, min(c2) as b, c2, c3 from t1) t1) t1 where t2.c1 = t1.a;


###2-9：消除union语句最小聚合
select min(c1), min(c2) from t1 union select min(c2), min(c3) from t1;

select min(c1), min(c2) from t1 union select min(c2), min(c3) from t1 union select min(c2), min(c3) from t1;

select min(c1), min(c2), c3 from t1 union select min(c2), min(c3), c4 from t1;

###2-10：不支持最小聚合消除的情况
select min(c1), min(c2), count(*) from t1;

select min(c1), min(c2) from t1 group by c2;

select /*+index(t1 idx1) */ min(c1), min(c2) from t1 where c2 >0 and c3 > 0;

--error 7
select min(c1), min(c2) from t1 where c1 = 1 for update;

select min(c1), min(c2) from t1 limit 1;

select distinct min(c1), min(c2) from t1;

select min(c1), min(c2) from t1 order by c2;

select min(c1), min(c2) from t1 having min(c1);


###删表删库
drop table if exists t1;
drop table if exists t2;

########################################################################################################
