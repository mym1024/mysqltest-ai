####################################必填######################################################
###1.测试功能点：list分区规则表中prepare执行操作过程中修改表的结构
##
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：xxx
###4.问题号：xxx
###5.预计运行时间：xxx
###6.编写/修改人：zhuyinying
###7.编写/修改日期：2020-01-13
###8.其他（选填）：case格式规范化修改
###
##
#
##############################################################################################

#####################################Do sql###################################################
--disable_warnings
drop table if exists t1,t2; 
--enable_warnings

create table t1(a int primary key,b varchar(255),c int)partition by list(a)(partition q0 values in(1,3),partition q1 values in(2,4,5));
--real_sleep 5
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);


###2-1:add new column
prepare stmt1 from update t1 set b='ok' where a=?;
set @a=1;
execute stmt1 using @a;
alter table t1 add d int;
execute stmt1 using @a;
select * from t1;
deallocate prepare stmt1;


###2-2:drop a exist column which not use
prepare stmt2 from update t1 set b='ok' where a=?;
set @a=1;
execute stmt2 using @a;
alter table t1 drop d;
execute stmt2 using @a;
select * from t1;
deallocate prepare stmt2;


###2-3:drop a exist column which used by set
prepare stmt3 from update t1 set b='ok' where a=?;
set @a=1;
execute stmt3 using @a;
# --error 5002
alter table t1 drop b;
#--error 18
--error 5009
execute stmt3 using @a;
select * from t1;
deallocate prepare stmt3;


alter table t1 add b int;
###2-4:drop column which used by where
prepare stmt4 from update t1 set b=2 where a=?;
set @a=1;
execute stmt4 using @a;
--error 5002
alter table t1 drop a;
execute stmt4 using @a;
select * from t1;
deallocate prepare stmt4;


drop table t1;
create table t1(a int primary key,b varchar(255),c int)partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than maxvalue);
--real_sleep 5
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);


###2-5:add a new column and drop it
prepare stmt5 from update t1 set b='ok' where a=?;
set @a=1;
execute stmt5 using @a;
alter table t1 add d int;
alter table t1 drop d;
execute stmt5 using @a;
select * from t1;
deallocate prepare stmt5;


###2-6:drop a exist column ,add add it which have not use
prepare stmt6 from update t1 set b='ok' where a=?;
set @a=1;
execute stmt6 using @a;
alter table t1 drop c;
alter table t1 add c int;
execute stmt6 using @a;
select * from t1;
deallocate prepare stmt6;


###2-7:drop a exist column ,add add it which set used and have same type
prepare stmt7 from update t1 set b='ok' where a=?;
set @a=1;
execute stmt7 using @a;
alter table t1 drop b;
alter table t1 add b varchar(255);
#--error 18
execute stmt7 using @a;
select * from t1;
deallocate prepare stmt7;


###2-8:drop a exist column ,add add it which set used and have different type
prepare stmt8 from update t1 set b='ok' where a=?;
set @a=1;
execute stmt8 using @a;
alter table t1 drop b;
alter table t1 add b int;
#--error 18
--error 7
execute stmt8 using @a;
select * from t1;
deallocate prepare stmt8;


###2-9:drop a exist column ,add add it which where used and have same type
prepare stmt9 from update t1 set b='ok' where a=?;
set @a=1;
--error 7
execute stmt9 using @a;
--error 5002
alter table t1 drop a;
--error 5008
alter table t1 add a int;
--error 7
execute stmt9 using @a;
select * from t1;
deallocate prepare stmt9;


###2-10:drop a exist column ,add add it which where used and have different type
prepare stmt10 from update t1 set b='ok' where a=?;
set @a=1;
--error 7
execute stmt10 using @a;
--error 5002
alter table t1 drop a;
--error 5008
alter table t1 add a varchar(255);
--error 7
execute stmt10 using @a;
select * from t1;
deallocate prepare stmt10;


# drop table
prepare stmt11 from update t1 set b='ok' where a=?;
set @a=1;
--error 7
execute stmt11 using @a;
drop table t1;
#--error 5012
--error 5019
execute stmt11 using @a;
deallocate prepare stmt11;


###2-11:drop table and create again
create table t1(a int primary key,b varchar(255),c int)partition by range(a)(partition r0 values less than(5),partition r1 values less than(10),partition r2 values less than(15),partition r3 values less than maxvalue);
--real_sleep 5
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt12 from update t1 set b='ok' where a=?;
set @a=1;
execute stmt12 using @a;
drop table t1;
create table t1(a int primary key,b varchar(255),c int);
--real_sleep 5
#--error 5019
execute stmt12 using @a;
select * from t1;
deallocate prepare stmt12;


###2-12:drop table and create with diff name
drop table t1;
--error 5077
drop partition function e;
create enum partition function e(x) '[(1)],[(3)],[(2)],[(4)]';
create table t1(a int primary key,b varchar(255),c int)partition by(em,e,a);
--real_sleep 5
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt13 from update t1 set b='ok',c=2 where a=?;
set @a=1;
execute stmt13 using @a;
drop table t1;
create table t1(a int primary key,b varchar(255));
--error 5009
execute stmt13 using @a;
sleep 5;
select * from t1;
deallocate prepare stmt13;


###2-13:drop table and create with diff name
drop table t1;
--error 5077
drop partition function h;
create hash partition function h(x) 'x+1';
create table t1(a int primary key,b varchar(255),c int)partition by(hs,h,a);
--real_sleep 5
insert into t1 values(1,'a',2),(2,'b',3),(3,'c',4);

prepare stmt14 from update t1 set b='ok' where a=?;
set @a=1;
execute stmt14 using @a;
drop table t1;
create table t2(a int primary key,b varchar(255));
--real_sleep 5
--error 5019
execute stmt14 using @a;

deallocate prepare stmt14;


###///新添测试项///###
###2-x:(新增测试项说明)
#do sql
###################################################################################################
