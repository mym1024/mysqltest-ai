##############################################################################################
###1.测试功能点：测试json数据类型
#                 
#
###2.测试项：(每新添一测试项，需在添加前注明测试项，注释填写在新添sq1前，不填在此处，如下样例）
###3.问题网址：
###4.问题号：
###5.预计运行时间：
###6.编写/修改人：wubw
###7.编写/修改日期：2023-11-08
###8.其他（选填）：新增
###
##
#
##############################################################################################

#####################################Do sql###################################################
set names utf8mb4;
connect (conn1,$OBMYSQL_MS0,admin,admin,test,$OBMYSQL_PORT);

connection conn1;
--disable_warnings
drop table if exists lc,lc0,lc1,lc2,lc3,lc4,lc5,lc6,lc7,lc8;
--enable_warnings

###DDL相关测试
##Create测试
create table lc0(a int,b json,c varchar(20));
create table lc1(a int primary key,b json,c varchar(20));
--error 5006
create table lc3(a int ,b json primary key,c varchar(20));
create table lc2(a int primary key,b json not null,c varchar(20));
--error 6003
create table lc7(b json default '1');
create table lc4(a int,b json,c varchar(20));
--error 6001
create index idx1 on lc4(b);
create table lc5(a int,b json,c varchar(20));
create index idx1 on lc5(a);
create table lc(b json);
create table lc8(b json, c json, d json);
create table lc6(a int,b json,c varchar(20));
--error 6001
create index idx1 on lc6(a,b);

##Alter测试
alter table lc1 drop b;
alter table lc1 add b json;

##Show展示
desc lc1;
show create table lc1;
show full columns from lc1;

##Insert测试
--error 5411
insert into lc values(1);
--error 5411
insert into lc values(1.1);
--error 5411
insert into lc values(cast(current_timestamp() as datetime));
--error 5411
insert into lc values(cast(current_timestamp() as date));
--error 5411
insert into lc values(cast(current_timestamp() as time));
--error 5411
insert into lc values(cast(1.1 as double));
--error 5411
insert into lc values(cast(1.1 as float));
insert into lc values(null);

insert into lc values('1'),('null'),('true'),('false'),('"abc"'),('1.1');
select * from lc;
truncate table lc;
insert into lc values('[1,null,true,false,"abc",1.1]');
select * from lc;
truncate table lc;
insert into lc values('"abc"'),('"null"');
select * from lc;
truncate table lc;
insert into lc values('{"abc":1,"def":null,"hig":"aaa","bool":false}');
select * from lc;
truncate table lc;
--error 5411
insert into lc values('abc');
truncate table lc;
--error 5410
insert into lc values('');
select * from lc;
truncate table lc;
--error 5411
insert into lc values('[1,{"a":true}, null');
--error 5411
insert into lc values('[1,{a:true}, null]');
truncate table lc;
insert into lc values('[true,{"array":[1,null,[1,2,3]],"object":{"abc":{"true":1}}}]');
select * from lc;
truncate table lc;
insert into lc values('{"a":1,"b":2,"a":3}');
select * from lc;
insert into lc1(a,b) values(1,'[true]');
update lc1 set b='[1,2,null,{"abc":1}]' where a =1;
select * from lc1;

##Update测试
truncate table lc1;
insert into lc1(a,b) values(1,'[true]');
update lc1 set b='[1,2,null,{"abc":1}]' where a =1;
select * from lc1;
--error 119
update lc set b=1;
--error 119
update lc set b=1.1;
--error 119
update lc set b=cast(1.1 as double);
--error 119
update lc set b=cast(1.1 as float);
--error 119
update lc set b=cast(current_timestamp() as time);
--error 119
update lc set b=cast(current_timestamp() as date);
--error 5411
update lc1 set b='{[1,2,3]' where a =1;
update lc1 set b=null where a =1;
select * from lc1;
--error 5410
update lc1 set b='' where a =1;

##Delete测试
truncate table lc;
insert into lc values('1'),('[1,2,3]');
delete from lc where b=1;
select * from lc;
truncate table lc;
insert into lc values('1'),('[1,2,3]');
delete from lc where b='[1,2,3]';
select * from lc;

##预编译测试
drop table if exists lc1;
create table lc1(a int primary key,b json,c varchar(20));
prepare stmt1 from insert into lc1 values(1,?,'hello1');
set @a='[1,2,{"name":"Bob"}]';
execute stmt1 using @a;
select * from lc1;
deallocate prepare stmt1;
drop table if exists lc1;
create table lc1(a int primary key,b json,c varchar(20));
prepare stmt1 from insert into lc1 values(1,?,'hello1');
set @a='[1,2,{"name":Bob}]';
--error 5411
execute stmt1 using @a;
select * from lc1;
deallocate prepare stmt1;
drop table if exists lc1;
create table lc1(a int primary key,b json,c varchar(20));
prepare stmt1 from insert into lc1 values(1,'[1,2,{"name":"Bob"}]','hello1');
execute stmt1;
select * from lc1;
deallocate prepare stmt1;
drop table if exists lc1;
create table lc1(a int primary key,b json,c varchar(20));
prepare stmt1 from insert into lc1 values(1,'[1,2,{"name":Bob}]','hello1');
--error 5411
execute stmt1;
select * from lc1;
deallocate prepare stmt1;

##Select测试
truncate table lc;
insert into lc values('1'),('[1,2,3]');
select * from lc where b=cast('[1,2,3]' as json);
select count(*) from lc where b in (select b from lc);
select count(*) from lc where b in (select b  from lc bb where bb.b=cast('[1,2,3]' as json));
select count(*) from lc a where a.b in (select b  from lc bb where bb.b=cast('[1,2,3]' as json));
truncate table lc1;
truncate table lc2;
insert into lc1(a,b) values(1,'1'),(2,'[1,2,3]');
insert into lc2(a,b) values(1,'[1,2,3]');
select count(*) from lc1 where b in (select b from lc2);
select count(*) from lc1 where b in (select json_extract(b, '$') from lc1);
select b from lc1  union select b from lc2;
select b from lc1  except select b from lc2;
select b from lc1  intersect select b from lc2;
select count(*)  from lc1 right join lc2 on lc1.b = lc2.b;
select count(*)  from lc1 left join lc2 on lc1.b = lc2.b;
truncate table lc;
insert into lc(b) values('1'),('[1,2,3]'),('{"name":1}');
select b from lc order by b desc;
select b from lc order by b asc;
select * from lc where b=1 or b = cast('[1,2,3]' as json);
select b from lc where b=1 union select b from lc where b=cast('[1,2,3]' as json);
truncate table lc;
insert into lc(b) values('1'),('[1,2,3]');
select b from lc except select b from lc where b=1;
select b from lc intersect select b from lc where b=1; 
select b from lc where b between 1 and cast('[1,2,3]' as json);
select b from lc where b is not null;
select b is not null from lc;
select max(b) from lc;
select min(b) from lc ;
select sum(b) from lc;
select avg(b) from lc ;
select 2 from lc where b in(select b from lc) ;
select b from lc group by b;
select b from lc having sum(b)<4;
truncate table lc8;
insert into lc8(b,c) values('{"age":12}','[true,null]'),('"abc"','1');
select b,c,ord(b),ord(c) from lc8;
select b,instr(b, 'a') from lc8;
select b,left(b, 3),c,right(c,2) from lc8;
select b,c,substr(b,2),substr(c,2,3) from lc8;
select b,c,concat(b,c),concat(b,' json'),concat('json! ',c) from lc8;

##json函数测试
select json_array(cast('20230303' as date));
select json_array(true,false,null,'xoj',1111,cast('[1,true,null]' as json),cast(1.1 as double),current_timestamp());
--error 5411
select json_array(cast('[a' as json));
select json_array(1+3,1.1-1.2,'1'*'8',9.3/3.2,9%5);
create table test1(c1 json);
Insert into test1 values(json_array(1,true,'abc'));
update test1 set c1=json_array(1,2,true,'abcd');
select * from test1;
--error 119
update test1 set c1=json_array(1,2,true,'abcd',cast('[1' as json));
select * from test1;
select * from test1 having c1 <= json_array(1,2,true,'abcd');
create table t2(c1 int primary key, c2 varchar(10));
insert into t2 values(1,'a'),(2,'b');
select json_array(max(c2), min(c1), sum(c1), avg(c1), count(c2)) from t2;
truncate table test1;
insert into test1 values('[1]');
select * from test1 join t2 on test1.c1=json_array(t2.c1);

select json_object('name',cast('[1,true,null]' as json));
select json_object('name',true,'age',false,'first',null,'second','xoj','third',1111,'fourth',cast('[1,true,null]' as json),'fifth',cast(1.1 as double),'sixth',current_timestamp());
select json_object('first',1+3,'second',1.1-1.2,'third','1'*'8','fourth',9.3/3.2,'fifth',9%5);
truncate table test1;
Insert into test1 values(json_object('age',1,'man',true,'name','abc'));
update test1 set c1='1' where c1=json_object('age',1,'man',true,'name','abc');
select * from test1;
select * from test1 having c1<=json_object('age',1,'man',true,'name','abc','json',cast(1 as json));
delete from test1 where c1=json_object('age',1,'man',true,'name','abc','json',cast(1 as json));
select json_object('max',max(c2), 'min',min(c1), 'sum',sum(c1), 'avg',avg(c1), 'count',count(c2)) from t2;
truncate table test1;
truncate table t2;
insert into test1 values('{"a":1}');
insert into t2 values(1,'a'),(2,'b');
select * from test1 join t2 on test1.c1=json_object(t2.c2,t2.c1);

--error 5054
select json_quote();
--error 5414
select json_quote(to_date('2022-12-30 22:34:39','yyyy-mm-dd hh24:mi:ss'));
select json_quote('{name:"zxs",grade:60}');
select json_quote(json_quote('123'));

--error 5414
select json_contains(cast('2022-01-01' as date), cast('2022-01-01' as date));
select json_contains(cast(current_timestamp() as json),'"abc"');
create table test2(c1 json,c2 json,c3 int);
insert into test2(c1,c2) values('[1,2]','[1]'),('[1]','[1,2]');
update test2 set c3 = 1 where json_contains(c1,c2);
select * from test2;
update test2 set c3 = json_contains(c1,c2);
select * from test2;
select * from test2 having json_contains(c1,c2);
insert into test2 values('1','1',json_contains('1','1'));
delete from test2 where c3!=json_contains(c1,c2);
(select * from test2 where json_contains(c1,c2) = 0) union (select * from test2 where json_contains(c1,c2) = 1);

--error 2
select json_contains_path('1','one');
--error 5414
select json_contains_path(1.1,'all','$');
select json_contains_path('[1,{"name":"Alice","array":[1,null,false]}]','all','$[last-1 to last-0]','$[1].array[2][*]','$[1][0].name');
select json_contains_path('1','one',  '$')<>json_contains_path('1', 'one', '$');

--error 5054
select json_extract();
select json_extract('[1,2,3]','$','$[1]','$[2]','$[1][1]','$[100][100]','$[3 to 5]','$[last-1]');
--error 5414
select json_extract(cast(2.1 as decimal(2,1)),'$');
select json_extract('[1,{"name":"Alice","array":[1,null,false]}]', '$[0][0][0]','$[1][0][0]','$[1]**[0]');
select json_extract('1', '$')!=json_extract('1', '$');

--error 5413
select json_keys('[1,[1,2]]' ,'abc');
select json_keys('{"name":{"age":10}}','$.name.name');
select json_keys('{"name":"Bob","obj":[1,[2,3],4]}','$.obj[1]');
select json_keys('1', '$')!=json_keys('1', '$');

select json_overlaps('1','1');
--error 5054
select json_overlaps('1','1','$','$');
--error 5414
select json_overlaps(cast(2.1 as decimal(2,1)), cast(2.1 as decimal(2,1)));
select json_overlaps(cast('[true]' as json), cast(true as json));
select json_overlaps('1','1')=json_overlaps('1','1');

--error 2
select json_search('1','one');
--error 2
select json_search('["%a","_a","%_a"]','all','%_','12');
select json_search('"1"','one','1',null,'$','$[0]','$.obj');
--error 5009
select json_search('[1,["1",2]]', 'one',$);
--error 5411
select json_search('[1', 'one','1');
select json_search('{"name":"Bob","age":11,"bool":true,"max":null,"others":"Bob"}','all',null);
select json_search('["abc","bc",{"alpha":"b","beta":"bc","cigema":"ab"},"b"]','all','%b%',null,'$[last-3 to last-1]','$[0 to 4]');

--error 5422
select json_value('[1]','$[1]' ERROR on empty);
--error 5422
select json_value('[1,"abc",3]','$[10]' error on empty DEFAULT 11 on error);
select json_value('[1,2,3]','$' RETURNING FLOAT error on empty DEFAULT 11 on error);
select json_value('[1,{"name":"Alice","array":["2023-01-10 11:11:11",null,false]}]', '$[1].array[0]' returning datetime);
--error 5001
select json_value('[1,{"name":"Alice","array":[1,null,false]}]', '$[0 to 2]' returning double default '888.8' on error null on empty);

--error 5411
select 1 member of('[1');
select cast('"abc"' as json) member of(cast(current_timestamp() as json));
select cast('{"fname":"Bob","lage":11}' as json) member of('{"name":"Bob","age":11}');
select 1 member of('1')<1 member of('1');

--error 2
select json_array_append('[1,2,3]','$[0]','2','$[0][0]');
select json_array_append(cast('[1,2]' as json),'$[1]',cast('[1,2]' as json));
--error 5415
select json_array_append('[1,2,3,4,5]', '$[1 to 3]',1);
select json_array_append('{"name":"Bob","age":11}', '$.name[0]', true);
select json_array_append('[1,{"name":"Alice","array":[1,null,false]}]', '$[1].array[0]',false,'$[1].array[0]',true);
select json_array_append('1', '$', '1')>json_array_append('1', '$', '1');

--error 5054
select json_array_insert('1');
select json_array_insert('[1,2,3]','$[0]','2','$[0][0]','3');
--error 5414
select json_array_insert(cast('2022-01-01' as date),'$[0]', 1);
select json_array_insert('[1]','$[0]', cast('[1,2]' as json));
--error 5424
select json_array_insert('{"name":"Bob","age":11}', '$', true);
select json_array_insert('[1,{"name":"Alice","array":[1,null,false]}]', '$[1].name[0]',1);

select json_insert('[1,2,3]','$[0]','2','$[0][0]','3');
--error 5413
select json_insert('[1,[1,2]]' ,true, 1);
select json_insert(cast('[1,2]' as json),'$[1]',cast('[1,2]' as json));
--error 5415
select json_insert('[1,2,3,4,5]', '$[1 to 3]',1);
select json_insert('{"name":"Bob","age":11}', '$.name[1]', true);
select json_insert('[1,{"name":"Alice","array":[1,null,false]}]', '$[last-8]','abc','$[0][1]','bcd');

--error 5054
select json_replace();
--error 2
select json_replace('[1,2,3]','$[0]','2','$[0][0]');
select json_replace('[1]','$[0]', cast('[1,2]' as json));
select json_replace('{"name":"Bob","age":11}', '$.name[1]', true);
select json_replace('[1,{"name":"Alice","array":[1,null,false]}]', '$[1].hobby','tennis','$[1].name','Bob');

--error 5413
select json_set('[1,[1,2]]' ,current_timestamp(), 1);
select json_set('[1]','$[0]', cast('[1,2]' as json));
select json_set(cast('[1,2]' as json),'$[1]',cast('[1,2]' as json));
--error 5415
select json_set('[1,2,3,4,5]', '$[*]',1);
select json_set('[1,{"name":"Alice","array":[1,null,false]}]', '$[1].hobby','tennis','$[1].name','Bob');

select json_remove('[1,2,3]','$[1]','$[1]','$[2]','$[1][1]','$[100][100]','$[last-1]');
--error 5009
select json_remove('[1,[1,2]]' ,$);
--error 5411
select json_remove('[1','$');
select json_remove('[1,{"name":"Alice","array":[1,null,false]}]', '$.name','$[1].array','$[1].array[0]');
select json_remove('1', '$[0]')<>json_remove('1', '$[0]');

select json_merge('1','1');
--error 5414
select json_merge(cast('11:11:11' as time), cast('11:11:11' as time));
select json_merge(cast(current_timestamp() as json),'"abc"');
select json_merge('{"name":"Bob","age":11}','{"name":"Bob","age":11,"relation":"dad"}');
select json_merge('[1,2,3,{"name":"Alice","age":11}]','{"name":"Bob","obj":[1,[2,3],4]}','{"relation":"Dad","age":65,"pet":["cat","dog"]}');

--error 5054
select json_merge_patch();
select json_merge_patch('1','[1,2]','"abc"','{"array":[1,2,3]}');
select json_merge_patch('true','false');
select json_merge_patch('{"name":["Bob", "Lisa", "Alice"],"age":11}','{"name":["Tom", "Jerry", "Lisa"], "age":{"year":1998, "day":25}, "obj":[true]}');
--error 5414
select json_merge_patch(current_timestamp(),'[1]','[2]');

--error 5054
select json_depth('1','1');
select json_depth('true'),json_depth(cast(1 as json));
select json_depth(cast('[true]' as json));
select json_depth('{"a":{"a":{"a":{"a":{"a":{"a":{"a":{"a":{"a":{"a":{}}}}}}}}}}}');
select json_depth('1')<>json_depth('1');

select json_unquote('1'),json_unquote('1.1'),json_unquote('"abc"');
--error 5414
select json_unquote(cast('2022-01-01' as date));
select json_unquote(cast('[true]' as json));
select json_unquote('[[],{},[[[[],[[],[{}]]]]]]');

--error 5054
select json_valid();
select json_valid('1'),json_valid('1.1'),json_valid('"abc"');
select json_valid('{"a":{"a":{"a":{"a":{"a":{"a":{"a":{"a":{"a":{"a":{}}}}}}}}}}}');
select json_valid('{"name":["Tom", "Jerry", "Lisa"], "age":{"year":1998, "day":25}, "obj":[true]}');

select json_pretty('1'),json_pretty('1.1'),json_pretty('"abc"');
--error 5414
select json_pretty(cast('2022-01-01' as date));
select json_pretty('1')!=json_pretty('1');

select json_storage_size('1'),json_storage_size('1.1'),json_storage_size('"abc"');
--error 5054
select json_storage_size('1','1');
select json_storage_size('{"name":"Bob","age":11,"relation":"dad"}');

--error 5413
select json_length('[1,[1,2]]' ,1);
select json_length(cast('[1,2]' as json),'$[1]');
select json_length('[1,{"name":"Alice","array":[1,null,false]}]', '$');

select json_type('1'),json_type('1.1'),json_type('"abc"');
--error 5054
select json_type('1','1');
select json_type('{"name":"Bob","age":11,"relation":"dad"}');
select json_type('1')>json_type('1');

###特殊情况下测试
#大数据，嵌套层数多，有回车换行，引号 @ 等特殊字符
CREATE TABLE table1(ID VARCHAR2(100),DATA_JSON json,TITLE VARCHAR2(300),AUTHOR VARCHAR2(300),URL VARCHAR2(300),IMG VARCHAR2(300),CITY_CODE VARCHAR2(300),AREA_CODE VARCHAR2(300),CMANAGER_CONTACT_PHONE VARCHAR2(300),CREATE_TIME TIMESTAMP(0),REMARKS VARCHAR2(300));
--error 5411
insert into table1 values('9b9d3233-1002-420f-8b72-e7aa139c110e','{"actNum":"15774","areaCode":"5742","background":"","bizType":"手机报彩信","cityCode":"574","cmanagerContact":"邵丹青","cmanagerContactPhone":"18858221009","costTotal":"1261.92","customType":"标签客群","customerName":"吴丽亚","details":"1.潜在求职意向用户:高\n2.年龄:47,52\n3.籍贯归属区县,按区县:余姚市\n4.居住地,按区县:余姚市\n","enterSion":"【农业银行余姚支行】","imgId":"908efc8a14354d36b61bf9bc06e140ae","market":"","mmsContent":"2021、2022届毕业生看过来！专业不限>！中国农业银行宁波市分行招聘啦！报名请扫图片二维码或点击下面链接。{链接}","preNum":"15774","publishId":"18747","publishName":"招聘彩信投放20210906","publishPrup":"线下引流","publishTime":"2021-09-06 17:00","pv":"70","pvRate":"0.00444","tradeId":12,"uv":"20","uvRate":"0.00127"}','招聘彩信投放20210906','jc','NULL','908efc8a14354d36b61bf9bc06e140ae','574','5742','18858221009','2021-09-08 10:01:33.000000','操作成功');
insert into table1 values('ac8d5eae-1107-4b4c-8ade-7fdb5b3cd040','{"actNum":"12435","areaCode":"5713","background":"","bizType":"手机报彩信","cityCode":"571","cmanagerContact":"倪梦瑶","cmanagerContactPhone":"13456785211","costTotal":"0.0000","customType":"","customerName":"何雪燕","details":"","enterSion":"【晋安家电】@!~#$%^&*","imgId":"6cb40285cedf44a8bacd2aced4f7fcf3","market":"","mmsContent":"亲爱的晋安老顾客，晋安家电新登店已搬迁至富春港商城一楼！乔迁新址又遇31周年庆，9月19 -20日全场电器超低价销售再送大礼，23238726","preNum":"15766","publishId":"18782","publishName":"晋安家电新登店已搬迁至富春港商城一楼","publishPrup":"线下引流","publishTime":"2021-09-07 16:00","pv":"0","pvRate":"0.0000","tradeId":16,"uv":"0","uvRate":"0.0000"}','晋安家电新登店已搬迁至富春港商城一楼','jc','NULL','6cb40285cedf44a8bacd2aced4f7fcf3','571','5713','13456785211','2021-09-09 00:02:03.000000','操作成功');
--error 5411
insert into table1 values('747f1f75-8648-456f-a3b9-22037afc68e4','{"customerName":"长兴~~~~~~~~~","publishName":"新冠疫苗宣传","costTotal":153.4,"publishTime":"2021-09-10 09:15:09","areaCode":"5722","cmanagerContactPhone":"15067220770","tradeId":8,"sceneId":"24小时应急","enterSion":"【虹星桥镇人民政府】","mmsContent":"【虹星桥镇人民政府】通知:明天(本周6)新冠疫苗生物跟科兴都有，可用于成人和12周岁以上的儿童（打第二针）。\n从下午13：30打到下午18：00。电话6682605。尽快安排，后续苗供应紧张。","cityCode":"572","cmanagerContact":"林玲","preNum":767,"actNum":767,"publishId":104716,"details":"1)(用户居住地归属乡镇【日】[已选择条件：湖州市|长兴县|和平镇]\r\n或\r\n2)用户工作地归属乡镇【日】[已选择条件：湖>州市|长兴县|和平镇])\r\n剔除\r\n3)当日停机用户【日】[是]"}','新冠疫苗宣传','jhms','NULL','NULL','NULL','NULL','NULL','2021-09-11 00:10:03.000000','筛选未通过');
#cast函数
drop table if exists table1;
create table table1 (b json);
insert into table1 values('{"1":"aaa"}');
SELECT CAST(b AS VARCHAR) from  table1;
SELECT CAST(b AS int) from  table1;
#--error 5103
SELECT CAST(b AS date ) from  table1;
